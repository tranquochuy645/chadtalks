import{r as s,j as d,a as v,u as x}from"./index-84eeaa5e.js";import{g}from"./getSocket-8aa47fbe.js";const k={iceServers:[{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10},E=({peerId:l,offer:R,answer:a,ice:o,localStream:i,onSendToPeer:f})=>{const n=s.useRef(null),w=s.useRef(null),m=s.useRef(null),u=s.useRef(null),y=async r=>{if(n.current=new RTCPeerConnection(k),w.current=new MediaStream,m.current)m.current.srcObject=w.current;else throw new Error("41");i==null||i.getTracks().forEach(e=>{var c;(c=n.current)==null||c.addTrack(e,i)}),n.current.ontrack=e=>{e.streams[0].getTracks().forEach(c=>{var h;(h=w.current)==null||h.addTrack(c)})},n.current.onicecandidate=async e=>{e.candidate&&f("ice_candidate",[r,e.candidate])}},P=async r=>{var e,c;await y(r),u.current=await((e=n.current)==null?void 0:e.createOffer()),await((c=n.current)==null?void 0:c.setLocalDescription(u.current)),f("offer",[r,u.current])},p=async(r,e)=>{var c,h,j;await y(r),await((c=n.current)==null?void 0:c.setRemoteDescription(e)),u.current=await((h=n.current)==null?void 0:h.createAnswer()),await((j=n.current)==null?void 0:j.setLocalDescription(u.current)),f("answer",[r,u.current])},C=async r=>{var e;await((e=n.current)==null?void 0:e.setRemoteDescription(r))},t=async r=>{var e;(e=n.current)==null||e.addIceCandidate(r)};return s.useEffect(()=>{R?p(l,R):P(l)},[]),s.useEffect(()=>{a&&C(a)},[a]),s.useEffect(()=>{o&&(console.log(o),t(o))},[o]),d.jsxs("div",{children:[d.jsxs("p",{children:["Peer ID: ",l]}),d.jsx("video",{className:"remote-video",ref:m,autoPlay:!0,playsInline:!0})]})};const O=()=>{const{roomId:l}=v(),R=x(),a=s.useRef(null),o=s.useRef(null),i=s.useRef(null),[f,n]=s.useState([]),w=async()=>{if(o.current=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),i.current)i.current.srcObject=o.current;else throw new Error("Can not get user media")},m=t=>{n(r=>r.filter(c=>c.id!==t))},u=t=>{n(r=>{const e={id:t};return[...r,e]})},y=async t=>{n(r=>{const e={id:t[0],offer:t[1]};return[...r,e]})},P=async t=>{n(r=>r.map(e=>e.id===t[0]?{...e,answer:t[1]}:e))},p=async t=>{n(r=>r.map(e=>e.id===t[0]?{...e,ice:t[1]}:e))};s.useEffect(()=>{const r=new URLSearchParams(window.location.search).get("token");if(!r){R("/auth");return}return console.log("render"),w().then(()=>{const e=g(r,!0);e.on("new_peer",u),e.on("off_peer",m),e.on("offer",y),e.on("answer",P),e.on("ice_candidate",p),a.current=e}),()=>{a.current&&a.current.disconnect()}},[]);const C=(t,r)=>{var e;(e=a.current)==null||e.emit(t,r)};return d.jsxs("div",{children:[d.jsx("h1",{children:"Call Page"}),d.jsxs("p",{children:["Room ID: ",l]}),d.jsx("video",{id:"local-video",ref:i,autoPlay:!0,playsInline:!0,muted:!0}),f.map(t=>d.jsx(E,{peerId:t.id,localStream:o.current,offer:t.offer,answer:t.answer,ice:t.ice,onSendToPeer:C},t.id))]})};export{O as default};
