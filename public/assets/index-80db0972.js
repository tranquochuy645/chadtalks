import{r as a,j as e,u as k}from"./index-57c8a08b.js";import{g as M}from"./getSocket-3ac81373.js";const F=({participants:t,userId:s})=>{if(t=t.filter(g=>g._id!==s),t.length==0)return null;const n=t.length>1,o=t.slice(0,4);return e.jsx("div",{className:"card",children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:o.map((g,l)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:g.avatar,alt:"Profile",className:"group-profile-picture"})},l))}),e.jsxs("div",{className:"profile-names",children:[o.length>0&&e.jsx("h3",{children:o.map(g=>g.fullname).join(", ")}),t.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",t.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[t[0].fullname+"  ",e.jsx("span",{className:t[0].isOnline?"online":"offline",children:"â€¢"})]}),t[0].bio&&e.jsx("p",{children:t[0].bio})]})})},z=a.memo(F);const T=t=>new Promise((s,n)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(o=>{if(o.ok)return o.json().then(g=>{s(g)});throw o.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(o=>{n(o)})}),B=({userId:t,currentRoomIndex:s,token:n,onRoomChange:o,onUpdateStatus:g})=>{const[l,d]=a.useState([]),c=a.useRef(""),u=a.useRef(null),w=k(),x=j=>{const h=j;"onl"+h!=c.current&&(c.current="onl"+h,d(b=>b&&b.map(i=>{const f=i.participants.map(r=>r._id===h?{...r,isOnline:!0}:r);return{...i,participants:f}})))},v=j=>{const h=j;"off"+h!=c.current&&(c.current="off"+h,d(b=>b&&b.map(i=>{const f=i.participants.map(r=>r._id===h?{...r,isOnline:!1}:r);return{...i,participants:f}})))},E=()=>{T(n).then(j=>{d(j)}).catch(()=>{w("/auth")})},L=j=>{var b,i;const h=document.querySelectorAll(".chat-room");h==null||h.forEach(f=>{var r;(r=f.classList)==null||r.remove("active")}),(i=(b=h[j])==null?void 0:b.classList)==null||i.add("active"),o(j)};a.useEffect(()=>{l.length>0&&g(l)},[l]),a.useEffect(()=>(n&&T(n).then(j=>{d(j);const h=M(n);h.on("onl",x),h.on("off",v),h.on("room",E),u.current=h}).catch(()=>{w("/auth")}),()=>{var j;(j=u.current)==null||j.disconnect()}),[n]);const C=a.useMemo(()=>l.map((j,h)=>e.jsx("div",{className:`chat-room ${h==s?"active":""}`,onClick:()=>L(h),children:e.jsx(z,{userId:t,participants:j.participants})},j._id)),[l]);return e.jsx("div",{id:"rooms-list",children:l&&l.length>0?e.jsx("div",{children:C}):e.jsx("p",{children:"No rooms to display"})})};const O={light:{text:"#000",background:"#d5e356",theme:"#ffffff"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},A=()=>{const[t,s]=a.useState(sessionStorage.getItem("theme")||"light");return a.useEffect(()=>{const n=O[t];Object.entries(n).forEach(([o,g])=>{document.documentElement.style.setProperty(`--${o}-color`,g)}),sessionStorage.setItem("theme",t)},[t]),[t,s]},G=()=>{const[t,s]=A(),n=t==="light",o=()=>{s(n?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:n,onChange:o}),e.jsxs("label",{className:`switcher-label ${n?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})},J=(t,s)=>fetch(`/api/v1/rooms/${t}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let p;const q=({room:t,token:s,profile:n})=>{const[o,g]=a.useState(""),[l,d]=a.useState(null),[c,u]=a.useState(),w=a.useRef(t._id),x=a.useRef(null),v=k(),E=r=>{g(r.target.value),console.log("typing ...")},L=()=>{o.trim()!==""&&(p==null||p.emit("msg",[t._id,o,new Date]),g(""))},C=r=>{if(r[1]===w.current){const m=r[0];if(m!==(n==null?void 0:n._id)&&!t.participants.some(_=>_._id===m))return;const y=r[2],N=r[3];d(_=>_!==null?[..._,{sender:m,content:y,timestamp:N}]:[{sender:m,content:y,timestamp:N}])}else console.log("New message, room: "+r[1])},j=()=>{p==null||p.emit("meet",[t._id,new Date])},h=r=>{const m=`/meet/${r}?token=${s}&room=${t._id}`;window.open(m)},b=r=>{if(r[1]==t._id&&u(r[2]),r[0]==(n==null?void 0:n._id))return r[3]?void 0:h(r[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{h(r[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(m=>{m==="granted"&&b(r)})},i=()=>{u(null)};a.useEffect(()=>{try{if(!s||!t)return;J(t._id,s).then(r=>{d(r.messages),r.meeting_uuid?u(r.meeting_uuid):u(null)}).catch(()=>{v("/auth")})}catch(r){console.error(r)}},[s,t._id]),a.useEffect(()=>{s&&(p=M(s),p==null||p.on("msg",C),p==null||p.on("meet",b),p==null||p.on("end_meet",i))},[s]),a.useEffect(()=>{w.current=t._id},[t._id]),a.useEffect(()=>{function r(){x.current&&(console.log(x.current.scrollTop),console.log(x.current.scrollHeight),console.log(x.current.clientHeight))}return x.current&&(console.log(x.current),x.current.addEventListener("scroll",r)),()=>{x.current&&x.current.removeEventListener("scroll",r)}},[]);const f=a.useMemo(()=>{const r=l==null?void 0:l.reverse();return e.jsx(e.Fragment,{children:Array.isArray(r)&&r.map((m,y)=>{let N;if(m.sender&&m.sender==(n==null?void 0:n._id))N=n.avatar;else{const _=t.participants.find(I=>I._id===m.sender);N=_?_.avatar:""}return e.jsxs("div",{className:`message ${m.sender==(n==null?void 0:n._id)?"own":""}`,children:[e.jsxs("div",{className:"message_wrapper",children:[m.sender!=(n==null?void 0:n._id)&&N&&e.jsx("img",{className:"inchat-avatar",src:N,alt:"Sender Avatar"}),e.jsx("p",{children:m.content})]}),e.jsx("p",{className:"message_timestamp",children:m.timestamp})]},y)})})},[l]);return e.jsxs("div",{id:"chat-box",children:[e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(z,{userId:n==null?void 0:n._id,participants:t.participants}),e.jsx("button",{className:"btn",onClick:j,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(G,{})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>h(c),children:"Join"})]}),e.jsxs("div",{ref:x,id:"messages-container",children:[f,e.jsx("img",{id:"chat-bg",src:"/assets/img/img_new/pattern.png"})]}),e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx("input",{type:"text",value:o,id:"input_message",onChange:E,onKeyDown:r=>{r.key=="Enter"&&L()}}),e.jsx("button",{onClick:L,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})]})};const H=({token:t,profileData:s,onRefresh:n})=>{const[o,g]=a.useState(!1),[l,d]=a.useState(!1),c=a.useRef(null),u=a.useRef(null),w=a.useRef(null),x=a.useRef(null),v=k();a.useEffect(()=>{if(t){const i=M(t);i.on("inv",n),w.current=i}return()=>{var i;(i=w.current)==null||i.disconnect()}},[t]),a.useEffect(()=>{x.current&&(l?x.current.classList.add("active"):x.current.classList.remove("active"))},[l]);const E=()=>{sessionStorage.removeItem("token"),v("/auth")},L=i=>{fetch(`/api/v1/rooms/${i}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!0})})},C=i=>{fetch(`/api/v1/rooms/${i}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!1})})},j=async i=>{i.preventDefault();let f={};if(i.target.bio.value&&(f.bio=i.target.bio.value),i.target.fullname.value&&(f.fullname=i.target.fullname.value),i.target.password.value)if(f.password=i.target.password.value,i.target.current_password.value)f.current_password=i.target.current_password.value;else return alert("Please enter current password");if(u.current&&(f.avatar=u.current),!f.bio&&!f.fullname&&!f.password&&!f.avatar)return alert("Empty form");const r=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify(f)});if(d(!1),r.ok)return alert("Updated successfully!"),n();const m=await r.json();if(m.message)return alert(m.message);alert("Error updating profile")},h=async()=>{if(window.confirm("Are you sure you want to delete your account?")){const f=window.prompt("Enter your password:");if(f!==null)try{const r={password:f},m=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify(r)});if(m.ok)sessionStorage.removeItem("token"),alert("You deleted your account successfully"),v("/auth");else{const y=await m.json();y.message?alert(y.message):alert("Wrong password!")}}catch(r){console.error("Error deleting account:",r)}}},b=()=>{if(c!=null&&c.current&&c.current.length>0){const i=c.current.files[0],f=new FileReader;f.onload=async r=>{var m;if((m=r.target)!=null&&m.result){const y=new Image;y.onload=async()=>{const N=document.createElement("canvas"),_=200,I=200;let S=y.width,R=y.height;S>_&&(R*=_/S,S=_),R>I&&(S*=I/R,R=I),N.width=S,N.height=R;const P=N.getContext("2d");P==null||P.drawImage(y,0,0,S,R);const U=N.toDataURL("image/jpeg");u.current=U},y.src=r.target.result}},f.readAsDataURL(i)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:s==null?void 0:s.avatar,alt:"Profile",id:"profile_img",className:"cover"}),l?e.jsxs("label",{id:"btn_upload-img",htmlFor:"upload-img",children:[e.jsx("i",{className:"bx bxs-camera"}),e.jsx("input",{id:"upload-img",type:"file",accept:"image/*",ref:c,onChange:b})]}):e.jsxs("div",{children:[e.jsx("h3",{children:s==null?void 0:s.fullname}),(s==null?void 0:s.bio)&&e.jsx("p",{children:s==null?void 0:s.bio})]}),e.jsxs("div",{className:"flex",children:[l?e.jsx("button",{className:"btn",onClick:()=>d(!1),children:e.jsx("i",{className:"bx bxs-message-square-x"})}):e.jsx("button",{className:"btn",onClick:()=>d(!0),children:e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>g(i=>!i),children:o?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),s!=null&&s.invitations.length&&(s==null?void 0:s.invitations.length)>0?e.jsx("span",{id:"nofcount",children:s==null?void 0:s.invitations.length}):null]})}),o&&e.jsx("div",{id:"notify-container",children:s&&s.invitations.length>0?s.invitations.map(i=>e.jsxs("div",{children:[e.jsx("p",{children:i}),e.jsx("button",{onClick:()=>L(i),children:"Accept"}),e.jsx("button",{onClick:()=>C(i),children:"Refuse"})]},i)):e.jsx("p",{children:"No invitations"})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:E,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsxs("div",{ref:x,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:s==null?void 0:s.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:s==null?void 0:s.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:h,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:j,children:"Save"})]})]})]})},K=a.memo(H);const Y=({token:t,onChoose:s})=>{const n=a.useRef(null),[o,g]=a.useState([]),l=()=>{var w;const u=(w=n.current)==null?void 0:w.value;u&&fetch(`/api/v1/search/${u}`,{headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(x=>{if(x.ok)return x.json().then(v=>{g(v)});console.log(x.status)})},d=u=>{u.key==="Enter"&&l()},c=u=>{n.current&&!n.current.contains(u.target)&&(g([]),n.current.value="")};return a.useEffect(()=>(document.addEventListener("click",c),()=>{document.removeEventListener("click",c)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:n,onKeyPress:d}),e.jsx("button",{className:"btn",onClick:l,children:e.jsx("i",{className:"bx bx-search"})}),o.length>0&&e.jsx("div",{id:"search_dropdown",children:o.map(u=>e.jsxs("div",{onClick:()=>{s({_id:u._id,fullname:u.fullname})},children:[e.jsx("img",{className:"profile-picture",src:u.avatar,alt:"Avatar"}),u.fullname]},u._id))})]})};const V=({token:t})=>{const[s,n]=a.useState([]),o=d=>{if(s.some(c=>c._id==d._id))return alert("already selected this user");n(c=>[...c,d])},g=d=>{console.log("remove user from users list"),d>=0&&d<s.length&&n(c=>c.filter((w,x)=>x!==d))},l=async()=>{if(s.length==0)return alert("Please select a user");const d=s.map(c=>c._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({invited:d})})).ok?n([]):alert("deo biet sao bug luon")}catch(c){console.error(c)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(Y,{token:t,onChoose:o}),s.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:s.map((d,c)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",d.fullname]}),e.jsx("span",{onClick:()=>g(c),children:"X"})]},d.fullname))}),e.jsx("button",{className:"btn",onClick:l,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})};function W(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const $=t=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(s=>{if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Z=({token:t})=>{const[s,n]=a.useState(null),[o,g]=a.useState([]),[l,d]=a.useState(0),c=k(),u=async()=>{try{const v=await $(t);n(v)}catch{c("/auth")}},w=v=>{d(v)},x=v=>{g(v)};return a.useEffect(()=>{t&&$(t).then(v=>{n(v)}).catch(v=>{console.error(v),c("/auth")})},[t]),e.jsx("div",{id:"main-page",className:"flex",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(K,{token:t,profileData:s,onRefresh:u}),e.jsx(V,{token:t}),e.jsx(B,{userId:s._id,currentRoomIndex:l,token:t,onRoomChange:w,onUpdateStatus:x})]}),e.jsx("section",{id:"section-right",children:o.length>0&&e.jsx(q,{profile:s,token:t,room:o[l]})})]}),e.jsx(W,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{Z as default,$ as getProfile};
