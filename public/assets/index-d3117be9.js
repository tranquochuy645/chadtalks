import{r as h,j as e,u as F,a as ee,c as te,g as ne,P as se}from"./index-2fdfccc4.js";import{u as B,S as re}from"./index-57fc2eb7.js";const ie=({participants:i,userId:n})=>{if(i=i.filter(s=>s._id!==n),i.length==0)return null;const c=i.length>1,d=i.slice(0,4);return e.jsx("div",{className:"card",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:d.map((s,a)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:s.avatar,alt:"Profile",className:"group-profile-picture"})},a))}),e.jsxs("div",{className:"profile-names",children:[d.length>0&&e.jsx("h3",{children:d.map(s=>s.fullname).join(", ")}),i.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",i.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:i[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[i[0].fullname+"  ",e.jsx("span",{className:i[0].isOnline?"online":"offline",children:"â€¢"})]}),i[0].bio&&e.jsx("p",{children:i[0].bio})]})})},X=h.memo(ie);const J=i=>new Promise((n,c)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+i}}).then(d=>{if(d.ok)return d.json().then(s=>{n(s)});throw d.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(d=>{c(d)})}),oe=({userId:i,currentRoomIndex:n,token:c,onRoomChange:d,onUpdateStatus:s})=>{const[a,r]=h.useState([]),t=B(),o=F(),g=m=>{const f=m;r(u=>u&&u.map(_=>{const E=_.participants.map(j=>j._id===f?{...j,isOnline:!0}:j);return{..._,participants:E}}))},p=m=>{const f=m;r(u=>u&&u.map(_=>{const E=_.participants.map(j=>j._id===f?{...j,isOnline:!1}:j);return{..._,participants:E}}))},x=m=>{console.log("set meet"),r(f=>f&&f.map(u=>u._id===m[1]?{...u,isMeeting:!0,meeting_uuid:m[2]}:u))},b=m=>{console.log("set end meet"),r(f=>f&&f.map(u=>u._id===m[0]&&u.isMeeting?{...u,isMeeting:!1,meeting_uuid:null}:u))},O=()=>{J(c).then(m=>{r(m)}).catch(()=>{o("/auth")})},k=m=>{var u,_;const f=document.querySelectorAll(".chat-room");f==null||f.forEach(E=>{var j;(j=E.classList)==null||j.remove("active")}),(_=(u=f[m])==null?void 0:u.classList)==null||_.add("active"),d(m)};h.useEffect(()=>{a.length>0&&s(a)},[a]),h.useEffect(()=>{if(t)return t.on("onl",g),t.on("off",p),t.on("meet",x),t.on("end_meet",b),t.on("room",O),()=>{t.off("onl",g),t.off("off",p),t.off("meet",x),t.off("end_meet",b),t.off("room",O)}},[t]),h.useEffect(()=>{J(c).then(m=>{r(m)}).catch(()=>{o("/auth")})},[]);const C=h.useMemo(()=>a.map((m,f)=>e.jsx("div",{className:`chat-room ${f==n?"active":""}`,onClick:()=>k(f),children:e.jsx(X,{userId:i,participants:m.participants})},m._id)),[a]);return e.jsx("div",{id:"rooms-list",children:a&&a.length>0?e.jsx("div",{children:C}):e.jsx("p",{children:"No rooms to display"})})};const K=({onChange:i,accept:n,id:c,icon:d})=>{const s=h.useRef(null),a=r=>{if(r.target.files){const t=r.target.files[0];i(t)}};return e.jsxs("label",{id:`btn_${c}`,className:"btn_fileinput",htmlFor:c,children:[d,e.jsx("input",{id:c,className:"fileinput",type:"file",accept:n,ref:s,onChange:a,style:{display:"none"}})]})};const ae=({token:i,userId:n,roomId:c,onJustSent:d})=>{const[s,a]=h.useState(""),[r,t]=h.useState([]),[o,g]=h.useState([]),p=B(),x=async m=>{try{const f=new FormData;return m.forEach(E=>{f.append(`file${m.length>1?"s":""}`,E)}),await(await fetch(`/media/${n}/${c}?token=${i}&count=${m.length}`,{method:"POST",body:f})).json()}catch(f){throw f}},b=m=>{a(m.target.value),console.log("typing ...")},O=async()=>{let m=[],f=[];if(r.length>0&&(console.log(r.length),m=r,t([])),o.length>0&&(console.log(o.length),m=[...m,...o],g([])),m.length>0)try{const u=await x(m);u.urls&&(f=u.urls)}catch(u){return alert("error uploading files: "+u.message)}(s.trim()!==""||f.length!==0)&&(console.log(f),p==null||p.emit("msg",[c,s,new Date,f]),d(),a(""))},k=m=>{g(f=>[...f,m])},C=m=>{t(f=>[...f,m])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(K,{accept:"image/*",onChange:k,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(K,{accept:"*",onChange:C,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),o.length>0&&e.jsx("div",{children:o.map((m,f)=>e.jsx("span",{children:m.name},f))}),r.length>0&&e.jsx("div",{children:r.map((m,f)=>e.jsx("span",{children:m.name},f))}),e.jsx("input",{type:"text",value:s,id:"input_message",onChange:b,onKeyDown:m=>{m.key=="Enter"&&O()}}),e.jsx("button",{onClick:O,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},le=h.memo(ae);const ce={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},ue=()=>{const[i,n]=h.useState(sessionStorage.getItem("theme")||"light");return h.useEffect(()=>{const c=ce[i];Object.entries(c).forEach(([d,s])=>{document.documentElement.style.setProperty(`--${d}-color`,s)}),sessionStorage.setItem("theme",i)},[i]),[i,n]},de=()=>{const[i,n]=ue(),c=i==="light",d=()=>{n(c?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:c,onChange:d}),e.jsxs("label",{className:`switcher-label ${c?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const fe=({token:i,room:n,userId:c})=>{const d=B(),s=()=>{d.emit("meet",[n._id,new Date])},a=t=>{const o=`/meet/${t}?token=${i}&room=${n._id}`;window.open(o)},r=t=>{if(console.log(t),t[0]==c)return t[3]?void 0:a(t[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{a(t[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&r(t)})};return h.useEffect(()=>{if(d)return d.on("meet",r),()=>{d.off("meet",r)}},[d,n._id]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:c,participants:n.participants}),e.jsx("button",{className:"btn",onClick:s,children:e.jsx("i",{className:"bx bxs-video"})}),n.isMeeting&&n.meeting_uuid&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>a(n.meeting_uuid),children:"Join"})]})]}),e.jsx(de,{})]})},he=h.memo(fe);var q={exports:{}};(function(i,n){(function(d,s){i.exports=s(h,ee)})(te,function(c,d){return function(s){var a={};function r(t){if(a[t])return a[t].exports;var o=a[t]={i:t,l:!1,exports:{}};return s[t].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=s,r.c=a,r.d=function(t,o,g){r.o(t,o)||Object.defineProperty(t,o,{enumerable:!0,get:g})},r.r=function(t){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,o){if(o&1&&(t=r(t)),o&8||o&4&&typeof t=="object"&&t&&t.__esModule)return t;var g=Object.create(null);if(r.r(g),Object.defineProperty(g,"default",{enumerable:!0,value:t}),o&2&&typeof t!="string")for(var p in t)r.d(g,p,(function(x){return t[x]}).bind(null,p));return g},r.n=function(t){var o=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(o,"a",o),o},r.o=function(t,o){return Object.prototype.hasOwnProperty.call(t,o)},r.p="",r(r.s=4)}([function(s,a,r){s.exports=r(5)()},function(s,a){s.exports=c},function(s,a){s.exports=d},function(s,a){s.exports=function(r,t,o){var g=r.direction,p=r.value;switch(g){case"top":return o.top+p<t.top&&o.bottom>t.bottom&&o.left<t.left&&o.right>t.right;case"left":return o.left+p<t.left&&o.bottom>t.bottom&&o.top<t.top&&o.right>t.right;case"bottom":return o.bottom-p>t.bottom&&o.left<t.left&&o.right>t.right&&o.top<t.top;case"right":return o.right-p>t.right&&o.left<t.left&&o.top<t.top&&o.bottom>t.bottom}}},function(s,a,r){r.r(a),r.d(a,"default",function(){return V});var t=r(1),o=r.n(t),g=r(2),p=r.n(g),x=r(0),b=r.n(x),O=r(3),k=r.n(O);function C(y){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?C=function(w){return typeof w}:C=function(w){return w&&typeof Symbol=="function"&&w.constructor===Symbol&&w!==Symbol.prototype?"symbol":typeof w},C(y)}function m(y,v){if(!(y instanceof v))throw new TypeError("Cannot call a class as a function")}function f(y,v){for(var w=0;w<v.length;w++){var l=v[w];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(y,l.key,l)}}function u(y,v,w){return v&&f(y.prototype,v),w&&f(y,w),y}function _(y,v){return v&&(C(v)==="object"||typeof v=="function")?v:j(y)}function E(y){return E=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},E(y)}function j(y){if(y===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return y}function I(y,v){if(typeof v!="function"&&v!==null)throw new TypeError("Super expression must either be null or a function");y.prototype=Object.create(v&&v.prototype,{constructor:{value:y,writable:!0,configurable:!0}}),v&&A(y,v)}function A(y,v){return A=Object.setPrototypeOf||function(l,P){return l.__proto__=P,l},A(y,v)}function R(y,v,w){return v in y?Object.defineProperty(y,v,{value:w,enumerable:!0,configurable:!0,writable:!0}):y[v]=w,y}function Z(y){return y.width===void 0&&(y.width=y.right-y.left),y.height===void 0&&(y.height=y.bottom-y.top),y}var V=function(y){I(v,y);function v(w){var l;return m(this,v),l=_(this,E(v).call(this,w)),R(j(l),"getContainer",function(){return l.props.containment||window}),R(j(l),"addEventListener",function(P,S,L,$){l.debounceCheck||(l.debounceCheck={});var T,z,N=function(){T=null,l.check()};$>-1?z=function(){T||(T=setTimeout(N,$||0))}:z=function(){clearTimeout(T),T=setTimeout(N,L||0)};var U={target:P,fn:z,getLastTimeout:function(){return T}};P.addEventListener(S,U.fn),l.debounceCheck[S]=U}),R(j(l),"startWatching",function(){l.debounceCheck||l.interval||(l.props.intervalCheck&&(l.interval=setInterval(l.check,l.props.intervalDelay)),l.props.scrollCheck&&l.addEventListener(l.getContainer(),"scroll",l.props.scrollDelay,l.props.scrollThrottle),l.props.resizeCheck&&l.addEventListener(window,"resize",l.props.resizeDelay,l.props.resizeThrottle),!l.props.delayedCall&&l.check())}),R(j(l),"stopWatching",function(){if(l.debounceCheck){for(var P in l.debounceCheck)if(l.debounceCheck.hasOwnProperty(P)){var S=l.debounceCheck[P];clearTimeout(S.getLastTimeout()),S.target.removeEventListener(P,S.fn),l.debounceCheck[P]=null}}l.debounceCheck=null,l.interval&&(l.interval=clearInterval(l.interval))}),R(j(l),"check",function(){var P=l.node,S,L;if(!P)return l.state;if(S=Z(l.roundRectDown(P.getBoundingClientRect())),l.props.containment){var $=l.props.containment.getBoundingClientRect();L={top:$.top,left:$.left,bottom:$.bottom,right:$.right}}else L={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var T=l.props.offset||{},z=C(T)==="object";z&&(L.top+=T.top||0,L.left+=T.left||0,L.bottom-=T.bottom||0,L.right-=T.right||0);var N={top:S.top>=L.top,left:S.left>=L.left,bottom:S.bottom<=L.bottom,right:S.right<=L.right},U=S.height>0&&S.width>0,M=U&&N.top&&N.left&&N.bottom&&N.right;if(U&&l.props.partialVisibility){var W=S.top<=L.bottom&&S.bottom>=L.top&&S.left<=L.right&&S.right>=L.left;typeof l.props.partialVisibility=="string"&&(W=N[l.props.partialVisibility]),M=l.props.minTopValue?W&&S.top<=L.bottom-l.props.minTopValue:W}typeof T.direction=="string"&&typeof T.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",T.direction,T.value),M=k()(T,S,L));var G=l.state;return l.state.isVisible!==M&&(G={isVisible:M,visibilityRect:N},l.setState(G),l.props.onChange&&l.props.onChange(M)),G}),l.state={isVisible:null,visibilityRect:{}},l}return u(v,[{key:"componentDidMount",value:function(){this.node=p.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(l){this.node=p.a.findDOMNode(this),this.props.active&&!l.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(l){return{top:Math.floor(l.top),left:Math.floor(l.left),bottom:Math.floor(l.bottom),right:Math.floor(l.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):o.a.Children.only(this.props.children)}}]),v}(o.a.Component);R(V,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:o.a.createElement("span",null)}),R(V,"propTypes",{onChange:b.a.func,active:b.a.bool,partialVisibility:b.a.oneOfType([b.a.bool,b.a.oneOf(["top","right","bottom","left"])]),delayedCall:b.a.bool,offset:b.a.oneOfType([b.a.shape({top:b.a.number,left:b.a.number,bottom:b.a.number,right:b.a.number}),b.a.shape({direction:b.a.oneOf(["top","right","bottom","left"]),value:b.a.number})]),scrollCheck:b.a.bool,scrollDelay:b.a.number,scrollThrottle:b.a.number,resizeCheck:b.a.bool,resizeDelay:b.a.number,resizeThrottle:b.a.number,intervalCheck:b.a.bool,intervalDelay:b.a.number,containment:typeof window<"u"?b.a.instanceOf(window.Element):b.a.any,children:b.a.oneOfType([b.a.element,b.a.func]),minTopValue:b.a.number})},function(s,a,r){var t=r(6);function o(){}function g(){}g.resetWarningCache=o,s.exports=function(){function p(O,k,C,m,f,u){if(u!==t){var _=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw _.name="Invariant Violation",_}}p.isRequired=p;function x(){return p}var b={array:p,bool:p,func:p,number:p,object:p,string:p,symbol:p,any:p,arrayOf:x,element:p,elementType:p,instanceOf:x,node:p,objectOf:x,oneOf:x,oneOfType:x,shape:x,exact:x,checkPropTypes:g,resetWarningCache:o};return b.PropTypes=b,b}},function(s,a,r){var t="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";s.exports=t}])})})(q);var pe=q.exports;const me=ne(pe);const ge=({src:i,alt:n})=>{const[c,d]=h.useState(!1);return h.useEffect(()=>{const s=new IntersectionObserver(r=>{r.forEach(t=>{t.isIntersecting&&(d(!0),s.unobserve(t.target))})}),a=document.getElementById(`lazyload-element-${i}`);return a&&s.observe(a),()=>{a&&s.unobserve(a)}},[i]),e.jsx("video",{id:`lazyload-element-${i}`,controls:!0,autoPlay:!1,playsInline:!0,src:c?i:"",children:n})},xe=({src:i,alt:n})=>{const[c,d]=h.useState(!1);return h.useEffect(()=>{const s=new IntersectionObserver(r=>{r.forEach(t=>{t.isIntersecting&&(d(!0),s.unobserve(t.target))})}),a=document.getElementById(`lazyload-element-${i}`);return a&&s.observe(a),()=>{a&&s.unobserve(a)}},[i]),e.jsx("img",{id:`lazyload-element-${i}`,src:c?i:"",loading:"lazy",alt:n})},Q=({url:i,token:n})=>{var t;const[c,d]=h.useState(!1),[s,a]=h.useState(!1),r=((t=i.split("/").pop())==null?void 0:t.substring(23))||"File";return h.useEffect(()=>{var g;const o=(g=i.split(".").pop())==null?void 0:g.toLowerCase();d(["jpg","jpeg","png","gif","bmp","svg"].includes(o||"")),a(["mp4","webm","ogg"].includes(o||""))},[i]),c?e.jsx(xe,{src:i+"?token="+n,alt:r}):s?e.jsx(ge,{src:i+"?token="+n,alt:r}):e.jsx("a",{href:i+"?token="+n,target:"_blank",rel:"noopener noreferrer",children:r})},be=({token:i,content:n,timestamp:c,urls:d})=>e.jsxs("div",{className:"message own",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:n})}),e.jsx("p",{className:"message_timestamp",children:c}),d&&d.length>0&&d.map((s,a)=>e.jsx(Q,{token:i,url:s},c+a))]}),ye=({token:i,avatarSRC:n,content:c,timestamp:d,urls:s})=>e.jsxs("div",{className:"message guest",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:n,alt:"Sender Avatar"}),e.jsx("p",{children:c}),s&&s.length>0&&s.map((a,r)=>e.jsx(Q,{token:i,url:a},d+r))]}),e.jsx("p",{className:"message_timestamp",children:d})]}),ve=({token:i,messages:n,userId:c,participants:d})=>e.jsx(e.Fragment,{children:Array.isArray(n)&&n.map((s,a)=>{if(s.sender&&s.sender==c)return e.jsx(be,{token:i,content:s.content,timestamp:s.timestamp,urls:s.urls},a);{const r=d.find(o=>o._id===s.sender),t=r?r.avatar:"";return e.jsx(ye,{token:i,avatarSRC:t,content:s.content,timestamp:s.timestamp,urls:s.urls},a)}})}),je=h.memo(ve);const H=(i,n,c,d)=>fetch(`/api/v1/rooms/${i}?limit=${c}&skip=${d}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+n}}).then(s=>{if(s.status===304)throw new Error("Already got this");if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),Y=30,_e=({token:i,room:n,userId:c,justSent:d})=>{const[s,a]=h.useState([]),[r,t]=h.useState(0),o=h.useRef(null),g=h.useRef(null),p=h.useRef(null),x=h.useRef(null),b=B(),O=F();console.log("Render container");const k=f=>{if(f[1]===n._id){const u=f[0];if(u!==c&&!n.participants.some(I=>I._id===u))return;p.current&&(p.current.style.display="block");const _=f[2],E=f[3],j=f[4];t(I=>I++),a(I=>I!==null?[...I,{sender:u,content:_,timestamp:E,urls:j}]:[{sender:u,content:_,timestamp:E,urls:j}])}},C=()=>{g.current&&(g.current.scrollIntoView({behavior:"smooth"}),p.current&&(p.current.style.display="none"))},m=f=>{if(!f||!s||s.length==0)return;if(s.length>=r){o.current&&(o.current.style.display="none");return}let u,_=Y;u=r-s.length-_,u<0&&(_+=u,u=0),H(n._id,i,`${_}`,`${u}`).then(E=>{x.current&&(x.current.scrollTop=300),a(j=>j?E.messages.concat(j):E.messages),E.conversationLength&&t(E.conversationLength)}).catch(()=>{O("/auth")})};return h.useEffect(()=>{try{if(!i||!n)return;H(n._id,i).then(f=>{a(f.messages),f.conversationLength&&t(f.conversationLength)}).catch(()=>{O("/auth")})}catch(f){console.error(f)}},[i,n._id]),h.useEffect(()=>{if(b)return b.on("msg",k),()=>{b.off("msg",k)}},[b,n._id]),h.useEffect(()=>{o.current&&(o.current.style.display="none");const f=setTimeout(()=>{o.current&&x.current&&x.current.scrollHeight>x.current.clientHeight&&(o.current.style.display="flex")},1e3);return()=>{clearTimeout(f)}},[n._id]),h.useEffect(()=>{if(!(!x.current||!s)){if(s.length<=Y)return C();if(Math.abs(x.current.scrollHeight-x.current.scrollTop-x.current.clientHeight)<300)return console.log("bottom"),C();if(s[s.length-1].sender==c&&d)return d=!1,C()}},[s]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:x,id:"messages-container",children:[e.jsx(me,{onChange:m,children:e.jsx("div",{ref:o,id:"topRef",children:e.jsx(se,{size:50})})}),s&&e.jsx(je,{token:i,messages:s,userId:c,participants:n.participants}),e.jsx("div",{ref:g})]}),e.jsxs("button",{id:"btn_scroll",ref:p,onClick:()=>{C()},children:[Array.isArray(s)&&s.length>1&&s[s.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const we=({room:i,token:n,profile:c})=>{const[d,s]=h.useState(!1),a=h.useCallback(()=>{s(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(he,{token:n,userId:c._id,room:i}),e.jsx(_e,{justSent:d,room:i,token:n,userId:c._id}),e.jsx(le,{token:n,userId:c._id,roomId:i._id,onJustSent:a})]})},Ee=i=>new Promise(async(n,c)=>{if(!window.confirm("Are you sure you want to delete your account?"))return c("Account deletion canceled");const s=window.prompt("Enter your password:");if(!s)return c("Password input canceled");try{const a={password:s},r=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify(a)});if(r.ok)return sessionStorage.removeItem("token"),n("Account deletion successful");const t=await r.json();if(t.message)return c(t.message);c("Wrong password")}catch(a){c(a)}});const Se=({token:i,profileData:n,onRefresh:c})=>{const[d,s]=h.useState(!1),[a,r]=h.useState(!1),t=h.useRef(null),o=h.useRef(null),g=h.useRef(null),p=F(),x=B();h.useEffect(()=>{if(x)return x.on("inv",c),()=>{x.off("inv",c)}},[x]),h.useEffect(()=>{o.current&&(a?o.current.classList.add("active"):o.current.classList.remove("active"))},[a]);const b=()=>{sessionStorage.removeItem("token"),p("/auth")},O=u=>{fetch(`/api/v1/rooms/${u}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({accept:!0})})},k=u=>{fetch(`/api/v1/rooms/${u}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({accept:!1})})},C=async()=>{if(!g.current)return;let u={};if(g.current.bio.value&&(u.bio=g.current.bio.value),g.current.fullname.value&&(u.fullname=g.current.fullname.value),g.current.password.value)if(u.password=g.current.password.value,g.current.current_password.value)u.current_password=g.current.current_password.value;else return alert("Please enter current password");if(t.current&&(u.avatar=t.current),!u.bio&&!u.fullname&&!u.password&&!u.avatar)return alert("Empty form");const _=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify(u)});if(r(!1),_.ok)return alert("Updated successfully!"),c();const E=await _.json();if(E.message)return alert(E.message);alert("Error updating profile")},m=async u=>{const _=new FormData;_.append("file",u);const E=await fetch(`/media/${n==null?void 0:n._id}/public?token=${i}&count=1`,{method:"POST",body:_}),j=await E.json();!E.ok&&j.message&&alert(j.message),j.urls&&(t.current=j.urls[0],C())},f=async()=>{try{const u=await Ee(i);alert(u),p("/auth")}catch(u){alert(u)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:n==null?void 0:n.avatar,alt:"Profile",id:"profile_img",className:"cover"}),a?e.jsx(K,{accept:"image/*",onChange:m,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:n==null?void 0:n.fullname}),(n==null?void 0:n.bio)&&e.jsx("p",{children:n==null?void 0:n.bio})]}),e.jsxs("div",{className:"flex",children:[a?e.jsx("button",{className:"btn",onClick:()=>r(!1),children:e.jsx("i",{className:"bx bxs-message-square-x"})}):e.jsx("button",{className:"btn",onClick:()=>r(!0),children:e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>s(u=>!u),children:d?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),n!=null&&n.invitations.length&&(n==null?void 0:n.invitations.length)>0?e.jsx("span",{id:"nofcount",children:n==null?void 0:n.invitations.length}):null]})}),d&&e.jsx("div",{id:"notify-container",children:n&&n.invitations.length>0?n.invitations.map(u=>e.jsxs("div",{children:[e.jsx("p",{children:u}),e.jsx("button",{onClick:()=>O(u),children:"Accept"}),e.jsx("button",{onClick:()=>k(u),children:"Refuse"})]},u)):e.jsx("p",{children:"No invitations"})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:b,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsxs("div",{ref:o,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:g,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:n==null?void 0:n.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:n==null?void 0:n.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:f,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:C,children:"Save"})]})]})]})},Ce=h.memo(Se);const Le=({token:i,onChoose:n})=>{const c=h.useRef(null),[d,s]=h.useState([]),a=()=>{var g;const o=(g=c.current)==null?void 0:g.value;o&&fetch(`/api/v1/search/${o}`,{headers:{"content-type":"application/json",authorization:"Bearer "+i}}).then(p=>{if(p.ok)return p.json().then(x=>{s(x)});console.log(p.status)})},r=o=>{o.key==="Enter"&&a()},t=o=>{c.current&&!c.current.contains(o.target)&&(s([]),c.current.value="")};return h.useEffect(()=>(document.addEventListener("click",t),()=>{document.removeEventListener("click",t)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:c,onKeyPress:r}),e.jsx("button",{className:"btn",onClick:a,children:e.jsx("i",{className:"bx bx-search"})}),d.length>0&&e.jsx("div",{id:"search_dropdown",children:d.map(o=>e.jsxs("div",{onClick:()=>{n({_id:o._id,fullname:o.fullname})},children:[e.jsx("img",{className:"profile-picture",src:o.avatar,alt:"Avatar"}),o.fullname]},o._id))})]})};const Te=({token:i})=>{const[n,c]=h.useState([]),d=r=>{if(n.some(t=>t._id==r._id))return alert("already selected this user");c(t=>[...t,r])},s=r=>{console.log("remove user from users list"),r>=0&&r<n.length&&c(t=>t.filter((g,p)=>p!==r))},a=async()=>{if(n.length==0)return alert("Please select a user");const r=n.map(t=>t._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({invited:r})})).ok?c([]):alert("deo biet sao bug luon")}catch(t){console.error(t)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(Le,{token:i,onChoose:d}),n.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:n.map((r,t)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",r.fullname]}),e.jsx("span",{onClick:()=>s(t),children:"X"})]},r.fullname))}),e.jsx("button",{className:"btn",onClick:a,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})};function Oe(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const D=i=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+i}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Ne=({token:i})=>{const[n,c]=h.useState(null),[d,s]=h.useState([]),[a,r]=h.useState(0),t=F(),o=async()=>{try{console.log("Loading profile again...");const x=await D(i);c(x)}catch{t("/auth")}},g=x=>{r(x)},p=x=>{s(x)};return h.useEffect(()=>{i&&D(i).then(x=>{c(x)}).catch(x=>{console.error(x),t("/auth")})},[i]),e.jsx("div",{id:"main-page",className:"flex",children:n?e.jsxs(re,{token:i,children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ce,{token:i,profileData:n,onRefresh:o}),e.jsx(Te,{token:i}),e.jsx(oe,{userId:n._id,currentRoomIndex:a,token:i,onRoomChange:g,onUpdateStatus:p})]}),e.jsx("section",{id:"section-right",children:d.length>0&&e.jsx(we,{profile:n,token:i,room:d[a]})})]}),e.jsx(Oe,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{Ne as default,D as getProfile};
