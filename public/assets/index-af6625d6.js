import{j as e,r as c,u as I}from"./index-1dfc1f07.js";import{g as k}from"./getSocket-3ac81373.js";const M=({participants:t,userId:s})=>{if(t=t.filter(f=>f._id!==s),t.length==0)return null;const r=t.length>1,l=t.slice(0,4);return e.jsx("div",{className:"user-card",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:l.map((f,x)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:f.avatar,alt:"Profile",className:"group-profile-picture"})},x))}),e.jsxs("div",{className:"profile-names",children:[l.length>0&&e.jsx("h3",{children:l.map(f=>f.fullname).join(", ")}),t.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",t.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("div",{className:"user-info ",children:[e.jsxs("h3",{children:[t[0].fullname+"  ",e.jsx("span",{className:t[0].isOnline?"online":"offline",children:"â€¢"})]}),t[0].bio&&e.jsx("p",{children:t[0].bio})]})]})})};const F=t=>new Promise((s,r)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(l=>{if(l.ok)return l.json().then(f=>{s(f)});throw l.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(l=>{r(l)})}),A=({userId:t,currentRoomIndex:s,token:r,onRoomChange:l,onUpdateStatus:f})=>{const[x,d]=c.useState([]),a=c.useRef(""),u=c.useRef(null),b=I(),y=g=>{const m=g;"onl"+m!=a.current&&(a.current="onl"+m,d(i=>i&&i.map(h=>{const n=h.participants.map(o=>o._id===m?{...o,isOnline:!0}:o);return{...h,participants:n}})))},j=g=>{const m=g;"off"+m!=a.current&&(a.current="off"+m,d(i=>i&&i.map(h=>{const n=h.participants.map(o=>o._id===m?{...o,isOnline:!1}:o);return{...h,participants:n}})))},C=()=>{F(r).then(g=>{d(g)}).catch(()=>{b("/auth")})},E=g=>{var i,h;const m=document.querySelectorAll(".chat-room");m==null||m.forEach(n=>{var o;(o=n.classList)==null||o.remove("active")}),(h=(i=m[g])==null?void 0:i.classList)==null||h.add("active"),l(g)};c.useEffect(()=>{x.length>0&&f(x)},[x]),c.useEffect(()=>(r&&F(r).then(g=>{d(g);const m=k(r);m.on("onl",y),m.on("off",j),m.on("room",C),u.current=m}).catch(()=>{b("/auth")}),()=>{var g;(g=u.current)==null||g.disconnect()}),[r]);const R=c.useMemo(()=>x.map((g,m)=>e.jsx("div",{className:`chat-room ${m==s?"active":""}`,onClick:()=>E(m),children:e.jsx(M,{userId:t,participants:g.participants})},g._id)),[x]);return e.jsx("div",{id:"rooms-list",children:x&&x.length>0?e.jsx("div",{children:R}):e.jsx("p",{children:"No rooms to display"})})};const T={text:"#000",bg:"#ffffff"},U={text:"#ffffff",bg:"#000"},O=()=>{const[t,s]=c.useState(sessionStorage.getItem("theme")==="light"),r=()=>{s(!t)};return c.useEffect(()=>{var l,f;t?(sessionStorage.setItem("theme","light"),(l=document.querySelector(".switcher-label"))==null||l.classList.remove("active"),document.documentElement.style.setProperty("--text-color",U.text),document.documentElement.style.setProperty("--background-color",U.bg)):(sessionStorage.setItem("theme","dark"),(f=document.querySelector(".switcher-label"))==null||f.classList.add("active"),document.documentElement.style.setProperty("--text-color",T.text),document.documentElement.style.setProperty("--background-color",T.bg))},[t]),e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:t,onChange:r}),e.jsxs("label",{className:"switcher-label",htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})},z=(t,s)=>fetch(`/api/v1/rooms/${t}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(r=>{if(r.ok)return r.json();throw r.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let v;const q=({room:t,token:s,profile:r})=>{const[l,f]=c.useState(""),[x,d]=c.useState(null),[a,u]=c.useState(),b=c.useRef(t._id),y=I(),j=n=>{f(n.target.value),console.log("typing ...")},C=()=>{l.trim()!==""&&(v==null||v.emit("msg",[t._id,l,new Date]),f(""))},E=n=>{if(n[1]===b.current){const o=n[0];if(o!==(r==null?void 0:r._id)&&!t.participants.some(N=>N._id===o))return;const p=n[2],w=n[3];d(N=>N!==null?[...N,{sender:o,content:p,timestamp:w}]:[{sender:o,content:p,timestamp:w}])}else console.log("New message, room: "+n[1])},R=()=>{v==null||v.emit("meet",[t._id,new Date])},g=n=>{const o=`/meet/${n}?token=${s}&room=${t._id}`;window.open(o)},m=n=>{if(n[1]==t._id&&u(n[2]),n[0]==(r==null?void 0:r._id))return n[3]?void 0:g(n[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{g(n[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&m(n)})},i=()=>{u(null)};c.useEffect(()=>{try{if(!s||!t)return;z(t._id,s).then(n=>{d(n.messages),n.meeting_uuid?u(n.meeting_uuid):u(null)}).catch(()=>{y("/auth")})}catch(n){console.error(n)}},[s,t._id]),c.useEffect(()=>{s&&(v=k(s),v==null||v.on("msg",E),v==null||v.on("meet",m),v==null||v.on("end_meet",i))},[s]),c.useEffect(()=>{b.current=t._id},[t._id]);const h=c.useMemo(()=>e.jsx("div",{className:"message-container",children:Array.isArray(x)&&x.map((n,o)=>{let p;if(n.sender&&n.sender==(r==null?void 0:r._id))p=r.avatar;else{const w=t.participants.find(N=>N._id===n.sender);p=w?w.avatar:""}return e.jsxs("div",{className:`message ${n.sender==(r==null?void 0:r._id)?"own":""}`,children:[p&&e.jsx("img",{className:"inchat-avatar",src:p,alt:"Sender Avatar"}),e.jsx("span",{children:n.content}),e.jsx("span",{children:n.timestamp})]},o)})}),[x]);return e.jsxs("div",{id:"chat-box",children:[e.jsxs("div",{className:"flex",children:[e.jsx(O,{}),e.jsx("button",{onClick:R,children:"Make call"})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>g(a),children:"Join"})]}),h,e.jsxs("div",{className:"input-container flex",children:[e.jsx("input",{type:"text",value:l,onChange:j,className:"input-field"}),e.jsx("button",{onClick:C,className:"send-button",children:"Send"})]})]})};const J=({token:t,profileData:s,onRefresh:r})=>{const[l,f]=c.useState(!1),[x,d]=c.useState(!1),a=c.useRef(null),u=c.useRef(null),b=c.useRef(null),y=I();c.useEffect(()=>{if(t){const i=k(t);i.on("inv",r),b.current=i}return()=>{var i;(i=b.current)==null||i.disconnect()}},[t]);const j=()=>{sessionStorage.removeItem("token"),y("/auth")},C=i=>{fetch(`/api/v1/rooms/${i}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!0})})},E=i=>{fetch(`/api/v1/rooms/${i}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!1})})},R=async i=>{i.preventDefault();let h={};if(i.target.bio.value&&(h.bio=i.target.bio.value),i.target.fullname.value&&(h.fullname=i.target.fullname.value),i.target.password.value)if(h.password=i.target.password.value,i.target.current_password.value)h.current_password=i.target.current_password.value;else return alert("Please enter current password");if(u.current&&(h.avatar=u.current),!h.bio&&!h.fullname&&!h.password&&!h.avatar)return alert("Empty form");const n=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify(h)});if(d(!1),n.ok)return alert("Updated successfully!"),r();const o=await n.json();if(o.message)return alert(o.message);alert("Error updating profile")},g=async()=>{if(window.confirm("Are you sure you want to delete your account?")){const h=window.prompt("Enter your password:");if(h!==null)try{const n={password:h},o=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify(n)});if(o.ok)sessionStorage.removeItem("token"),alert("You deleted your account successfully"),y("/auth");else{const p=await o.json();p.message?alert(p.message):alert("Wrong password!")}}catch(n){console.error("Error deleting account:",n)}}},m=()=>{if(a!=null&&a.current&&a.current.length>0){const i=a.current.files[0],h=new FileReader;h.onload=async n=>{var o;if((o=n.target)!=null&&o.result){const p=new Image;p.onload=async()=>{const w=document.createElement("canvas"),N=200,P=200;let _=p.width,S=p.height;_>N&&(S*=N/_,_=N),S>P&&(_*=P/S,S=P),w.width=_,w.height=S;const L=w.getContext("2d");L==null||L.drawImage(p,0,0,_,S);const B=w.toDataURL("image/jpeg");u.current=B},p.src=n.target.result}},h.readAsDataURL(i)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"profile",children:[e.jsx("img",{src:s==null?void 0:s.avatar,alt:"Profile",id:"profile_img",className:"cover"}),x?e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:"btn_profile",htmlFor:"upload-img",children:[e.jsx("i",{className:"bx bxs-pencil"}),e.jsx("input",{id:"upload-img",type:"file",accept:"image/*",ref:a,onChange:m})]}),e.jsx("button",{className:"btn_profile",onClick:()=>d(!1),children:e.jsx("i",{className:"bx bxs-pencil"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h3",{children:s==null?void 0:s.fullname}),(s==null?void 0:s.bio)&&e.jsx("p",{children:s==null?void 0:s.bio})]}),e.jsx("button",{className:"btn_profile",onClick:()=>d(!0),children:e.jsx("i",{className:"bx bxs-pencil"})})]}),e.jsx("button",{className:"btn_profile",onClick:()=>f(i=>!i),children:l?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),s!=null&&s.invitations.length&&(s==null?void 0:s.invitations.length)>0?e.jsx("span",{id:"nofcount",children:s==null?void 0:s.invitations.length}):null]})}),l&&e.jsx("div",{id:"notify-container",children:s&&s.invitations.length>0?s.invitations.map(i=>e.jsxs("div",{children:[e.jsx("p",{children:i}),e.jsx("button",{onClick:()=>C(i),children:"Accept"}),e.jsx("button",{onClick:()=>E(i),children:"Refuse"})]},i)):e.jsx("p",{children:"No invitations"})}),e.jsx("button",{id:"logout-btn",className:"btn_profile",onClick:j,children:e.jsx("i",{className:"bx bx-log-in"})})]}),x&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:R,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]}),e.jsx("button",{type:"submit",children:"Save"})]}),e.jsx("button",{onClick:g,children:"Delete account"})]})]})},G=c.memo(J);const Y=({token:t,onChoose:s})=>{const r=c.useRef(null),[l,f]=c.useState([]),x=()=>{var b;const u=(b=r.current)==null?void 0:b.value;u&&fetch(`/api/v1/search/${u}`,{headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(y=>{if(y.ok)return y.json().then(j=>{f(j)});console.log(y.status)})},d=u=>{u.key==="Enter"&&x()},a=u=>{r.current&&!r.current.contains(u.target)&&(f([]),r.current.value="")};return c.useEffect(()=>(document.addEventListener("click",a),()=>{document.removeEventListener("click",a)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:r,onKeyPress:d}),e.jsx("button",{className:"btn_profile",onClick:x,children:e.jsx("i",{className:"bx bx-search"})}),l.length>0&&e.jsx("div",{id:"search_dropdown",children:l.map(u=>e.jsxs("div",{onClick:()=>{s({_id:u._id,fullname:u.fullname})},children:[e.jsx("img",{className:"profile-picture",src:u.avatar,alt:"Avatar"}),u.fullname]},u._id))})]})};const K=({token:t})=>{const[s,r]=c.useState([]),l=d=>{if(s.some(a=>a._id==d._id))return alert("already selected this user");r(a=>[...a,d])},f=d=>{console.log("remove user from users list"),d>=0&&d<s.length&&r(a=>a.filter((b,y)=>y!==d))},x=async()=>{if(s.length==0)return alert("Please select a user");const d=s.map(a=>a._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({invited:d})})).ok?r([]):alert("deo biet sao bug luon")}catch(a){console.error(a)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(Y,{token:t,onChoose:l}),s.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:s.map((d,a)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",d.fullname]}),e.jsx("span",{onClick:()=>f(a),children:"X"})]},d.fullname))}),e.jsx("button",{className:"btn_profile",onClick:x,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})},$=t=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(s=>{if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),H=({token:t})=>{const[s,r]=c.useState(null),[l,f]=c.useState([]),[x,d]=c.useState(0),a=I(),u=async()=>{try{const j=await $(t);r(j)}catch{a("/auth")}},b=j=>{d(j)},y=j=>{f(j)};return c.useEffect(()=>{t&&$(t).then(j=>{r(j)}).catch(j=>{console.error(j),a("/auth")})},[t]),e.jsx("div",{id:"main-page",className:"flex",children:s?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(G,{token:t,profileData:s,onRefresh:u}),e.jsx(K,{token:t}),e.jsx(A,{userId:s._id,currentRoomIndex:x,token:t,onRoomChange:b,onUpdateStatus:y})]}),e.jsxs("section",{id:"section-right",children:[l.length>0&&e.jsx(q,{profile:s,token:t,room:l[x]}),e.jsx("img",{id:"chat-bg",src:"/assets/img/img_new/pattern.png"})]})]})}):e.jsx("div",{children:"Loading skeleton ..."})})};export{H as default,$ as getProfile};
