import{j as e,P as S,r as c,u as k}from"./index-d3df8d87.js";import{g as B}from"./getSocket-8aa47fbe.js";const A=({roomData:t,userId:a})=>{t=t.filter(d=>d._id!==a);const n=t.length>1,i=t.slice(0,4);return e.jsx("div",{className:"user-card",children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:i.map((d,f)=>e.jsx("div",{className:"profile",children:d.avatar?e.jsx("img",{src:d.avatar,alt:"Profile",className:"group-profile-picture"}):e.jsx(S,{size:5})},f))}),e.jsxs("div",{className:"profile-names",children:[i.length>0&&e.jsx("h3",{children:i.map(d=>d.fullname).join(", ")}),t.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",t.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[t[0]&&t[0].avatar?e.jsx("img",{src:t[0].avatar,alt:"Profile",className:"profile-picture"}):e.jsx(S,{size:30}),e.jsxs("div",{className:"user-info",children:[t[0]&&t[0].fullname?e.jsx("h3",{children:t[0].fullname}):e.jsx(S,{size:30}),t[0]&&t[0].isOnline!==void 0?e.jsx("p",{className:t[0].isOnline?"online":"offline",children:t[0].isOnline?"Online":"Offline"}):e.jsx(S,{size:15})]})]})})};const M=({token:t,onChoose:a})=>{const n=c.useRef(null),[i,d]=c.useState([]),f=()=>{var o;const r=(o=n.current)==null?void 0:o.value;r&&fetch(`/api/v1/search/${r}`,{headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(v=>{if(v.ok)return v.json().then(y=>{d(y)});console.log(v.status)})},p=r=>{r.key==="Enter"&&f()},g=r=>{n.current&&!n.current.contains(r.target)&&(d([]),n.current.value="")};return c.useEffect(()=>(document.addEventListener("click",g),()=>{document.removeEventListener("click",g)}),[]),e.jsxs("div",{id:"search",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:n,onKeyPress:p}),e.jsx("button",{onClick:f,children:"Search"}),i.length>0&&e.jsx("div",{className:"search_dropdown",children:i.map(r=>e.jsxs("div",{onClick:()=>{a({_id:r._id,fullname:r.fullname})},children:[e.jsx("img",{src:r.avatar,alt:"Avatar"}),r.fullname]},r._id))})]})};const q=({token:t})=>{const[a,n]=c.useState(!0),[i,d]=c.useState([]),f=r=>{if(i.some(o=>o._id==r._id))return alert("already selected this user");d(o=>[...o,r])},p=r=>{console.log("remove user from users list"),r>=0&&r<i.length&&d(o=>o.filter((y,N)=>N!==r))},g=async()=>{if(i.length==0)return alert("Please select a user");const r=i.map(o=>o._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({invited:r})})).ok?(d([]),n(!1)):alert("deo biet sao bug luon")}catch(o){console.error(o)}};return e.jsxs("div",{id:"featuresBox",children:[a&&e.jsxs(e.Fragment,{children:[e.jsx(M,{token:t,onChoose:f}),i.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{id:"chosenList",className:"flex",children:i.map((r,o)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",r.fullname]}),e.jsx("span",{onClick:()=>p(o),children:"X"})]},r.fullname))}),e.jsx("button",{onClick:g,children:"Create"})]})]}),e.jsx("button",{onClick:()=>n(r=>!r),children:a?"X":"Create new room"})]})},F=t=>new Promise((a,n)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(i=>{if(i.ok)return i.json().then(d=>{a(d)});throw i.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(i=>{n(i)})}),J=({userId:t,currentRoomIndex:a,token:n,onRoomChange:i,onUpdateStatus:d})=>{const[f,p]=c.useState([]),g=c.useRef(""),r=c.useRef(null),o=k(),v=l=>{const s=l;"onl"+s!=g.current&&(g.current="onl"+s,p(h=>h&&h.map(m=>{const w=m.participants.map(x=>x._id===s?{...x,isOnline:!0}:x);return{...m,participants:w}})))},y=l=>{const s=l;"off"+s!=g.current&&(g.current="off"+s,p(h=>h&&h.map(m=>{const w=m.participants.map(x=>x._id===s?{...x,isOnline:!1}:x);return{...m,participants:w}})))},N=()=>{F(n).then(l=>{console.log(l),p(l)}).catch(()=>{o("/auth")})},R=l=>{var h,m;const s=document.querySelectorAll(".chat-room");s==null||s.forEach(w=>{var x;(x=w.classList)==null||x.remove("active")}),(m=(h=s[l])==null?void 0:h.classList)==null||m.add("active"),i(l)};c.useEffect(()=>{f.length>0&&d(f)},[f]),c.useEffect(()=>(n&&F(n).then(l=>{p(l);const s=B(n);s.on("onl",v),s.on("off",y),s.on("room",N),r.current=s}).catch(()=>{o("/auth")}),()=>{var l;(l=r.current)==null||l.disconnect()}),[n]);const u=c.useMemo(()=>f.map((l,s)=>e.jsx("div",{className:`chat-room ${s==a?"active":""}`,onClick:()=>R(s),children:e.jsx(A,{userId:t,roomData:l.participants})},l._id)),[f]);return e.jsxs("div",{id:"SideBar",children:[e.jsx(q,{token:n}),f&&f.length>0?e.jsx("div",{children:u}):e.jsx("p",{children:"No rooms to display"})]})};const G=(t,a)=>fetch(`/api/v1/rooms/${t}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+a}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let j;const X=({room:t,token:a,profile:n})=>{const[i,d]=c.useState(""),[f,p]=c.useState(null),g=c.useRef(t._id),r=k(),o=u=>{d(u.target.value),console.log("typing ...")},v=()=>{i.trim()!==""&&(j==null||j.emit("msg",[t._id,i,new Date]),d(""))},y=u=>{if(u[1]===g.current){const l=u[0];if(l!==(n==null?void 0:n._id)&&!t.participants.some(m=>m._id===l))return;const s=u[2],h=u[3];p(m=>m!==null?[...m,{sender:l,content:s,timestamp:h}]:[{sender:l,content:s,timestamp:h}])}else console.log("New message, room: "+u[1])},N=()=>{j==null||j.emit("call",[t._id,new Date])},R=u=>{console.log("Receive call"),console.log(u);const l=`/call/${u[1]}?token=${a}`;if(u[0]==(n==null?void 0:n._id))return window.open(l);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{window.open(l)}):Notification.permission!=="denied"&&Notification.requestPermission().then(s=>{s==="granted"&&R(u)})};return c.useEffect(()=>{try{if(!a||!t)return;G(t._id,a).then(u=>{p(u.messages)}).catch(()=>{r("/auth")})}catch(u){console.error(u)}},[a,t._id]),c.useEffect(()=>{a&&(j=B(a),j==null||j.on("msg",y),j==null||j.on("call",R))},[a]),c.useEffect(()=>{g.current=t._id},[t._id]),e.jsxs("div",{className:"chat-box",children:[e.jsx("button",{onClick:N,children:"Make call"}),e.jsx("div",{className:"message-container",children:Array.isArray(f)&&f.map((u,l)=>{let s;if(u.sender&&u.sender==(n==null?void 0:n._id))s=n.avatar;else{const h=t.participants.find(m=>m._id===u.sender);s=h?h.avatar:""}return e.jsxs("div",{className:`message ${u.sender==(n==null?void 0:n._id)?"own":""}`,children:[s&&e.jsx("img",{className:"inchat-avatar",src:s,alt:"Sender Avatar"}),e.jsx("span",{children:u.content}),e.jsx("span",{children:u.timestamp})]},l)})}),e.jsxs("div",{className:"input-container flex",children:[e.jsx("input",{type:"text",value:i,onChange:o,className:"input-field"}),e.jsx("button",{onClick:v,className:"send-button",children:"Send"})]})]})};const T={text:"#000",bg:"#ffffff"},U={text:"#ffffff",bg:"#000"},K=()=>{const[t,a]=c.useState(sessionStorage.getItem("theme")==="light"),n=()=>{a(!t)};return c.useEffect(()=>{var i,d;t?(sessionStorage.setItem("theme","light"),(i=document.querySelector(".switcher-label"))==null||i.classList.remove("active"),document.documentElement.style.setProperty("--text-color",U.text),document.documentElement.style.setProperty("--background-color",U.bg)):(sessionStorage.setItem("theme","dark"),(d=document.querySelector(".switcher-label"))==null||d.classList.add("active"),document.documentElement.style.setProperty("--text-color",T.text),document.documentElement.style.setProperty("--background-color",T.bg))},[t]),e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:t,onChange:n}),e.jsxs("label",{className:"switcher-label",htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const V=({token:t,profileData:a})=>{const[n,i]=c.useState(a),[d,f]=c.useState(!1),p=c.useRef(null),g=c.useRef(null),r=c.useRef(null),o=k(),v=()=>{$(t).then(s=>i(s)).catch(s=>{console.error(s),o("/auth")})};c.useEffect(()=>{if(t){const s=B(t);s.on("inv",v),r.current=s}return()=>{var s;(s=r.current)==null||s.disconnect()}},[t]);const y=()=>{sessionStorage.removeItem("token"),o("/auth")},N=async s=>{try{console.log("Accepted invitation:",s),(await fetch(`/api/v1/rooms/${s}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!0})})).ok&&alert("ok")}catch(h){console.error(h)}},R=async s=>{try{console.log("Refused invitation:",s),(await fetch(`/api/v1/rooms/${s}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!1})})).ok&&alert("ok")}catch(h){console.error(h)}},u=async()=>{var s;try{const h=(s=g.current)==null?void 0:s.value;(await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({fullname:h})})).ok&&v()}catch(h){console.error(h)}},l=()=>{var s;if((s=p.current)!=null&&s.files&&p.current.files.length>0){const h=p.current.files[0],m=new FileReader;m.onload=async w=>{var x;if((x=w.target)!=null&&x.result){const _=new Image;_.onload=async()=>{const E=document.createElement("canvas"),I=200,P=200;let b=_.width,C=_.height;b>I&&(C*=I/b,b=I),C>P&&(b*=P/C,C=P),E.width=b,E.height=C;const L=E.getContext("2d");L==null||L.drawImage(_,0,0,b,C);const O=E.toDataURL("image/jpeg");try{(await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({avatar:O})})).ok&&v()}catch(z){console.error(z)}},_.src=w.target.result}},m.readAsDataURL(h)}};return e.jsx(e.Fragment,{children:e.jsxs("header",{children:[e.jsxs("div",{id:"profile",children:[n&&n.avatar?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:n.avatar,alt:"Profile",id:"profile_img"}),e.jsx("input",{type:"file",accept:"image/*",ref:p,onChange:l})]}):e.jsx(S,{size:30}),e.jsx("div",{id:"profile_info",children:n&&n.fullname?e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:n.fullname}),e.jsx("input",{type:"text",ref:g}),e.jsx("button",{onClick:u,children:"Change Fullname"})]}):e.jsx(S,{size:30})})]}),e.jsx("button",{onClick:()=>f(s=>!s),children:d?"X":`Show invitations (${n==null?void 0:n.invitations.length})`}),d&&e.jsx("div",{children:n&&n.invitations.length>0?n.invitations.map(s=>e.jsxs("div",{children:[e.jsx("p",{children:s}),e.jsx("button",{onClick:()=>N(s),children:"Accept"}),e.jsx("button",{onClick:()=>R(s),children:"Refuse"})]},s)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:"flex",children:[e.jsx(K,{}),e.jsx("button",{id:"logout-btn",onClick:y,children:"Logout"})]})]})})},H=c.memo(V),$=t=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(a=>{if(a.ok)return a.json();throw a.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Q=({token:t})=>{const[a,n]=c.useState(null),[i,d]=c.useState([]),[f,p]=c.useState(0),g=o=>{p(o)},r=o=>{d(o)};return c.useEffect(()=>{t&&$(t).then(o=>{n(o)}).catch(o=>{console.error(o)})},[t]),e.jsxs(e.Fragment,{children:[a?e.jsx(H,{token:t,profileData:a}):e.jsx(S,{size:100}),a?e.jsxs("main",{className:"flex",children:[e.jsx(J,{userId:a._id,currentRoomIndex:f,token:t,onRoomChange:g,onUpdateStatus:r}),i.length>0&&e.jsx(X,{profile:a,token:t,room:i[f]})]}):e.jsx(S,{size:500}),e.jsx("footer",{style:{display:"none"},children:e.jsx("p",{children:"© 2023 Messaging App. All rights reserved."})})]})};export{Q as default,$ as getProfile};
