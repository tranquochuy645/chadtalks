import{r as p,j as e,u as W,a as te,c as ne,g as se,P as re}from"./index-9771725a.js";import{useSocket as B}from"./index-2f44945a.js";const ie=({participants:s,userId:t})=>{if(s=s.filter(i=>i._id!==t),s.length===0)return e.jsx("div",{className:"card",children:e.jsx("h3",{children:"No other participants in this room."})});const c=s.length>1,f=s.slice(0,4);return e.jsx("div",{className:"card",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:f.map((i,o)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:i.avatar,alt:"Profile",className:"group-profile-picture"})},o))}),e.jsxs("div",{className:"profile-names",children:[f.length>0&&e.jsx("h3",{children:f.map(i=>i.fullname).join(", ")}),s.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",s.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[s[0].fullname+"  ",e.jsx("span",{className:s[0].isOnline?"online":"offline",children:"â€¢"})]}),s[0].bio&&e.jsx("p",{children:s[0].bio})]})})},X=p.memo(ie),oe=({roomId:s,handleAction:t})=>e.jsxs(e.Fragment,{children:[e.jsx("input",{className:"checkbox",type:"checkbox",id:`${s}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${s}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{onClick:()=>t("leave",s),children:"Leave"}),e.jsx("button",{onClick:()=>t("delete",s),children:"Delete"})]})]});const H=s=>new Promise((t,c)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(f=>{if(f.ok)return f.json().then(i=>{t(i)});if(f.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(f=>{c(f)})}),ae=({userId:s,currentRoomIndex:t,token:c,onRoomChange:f,onUpdateStatus:i})=>{const[o,r]=p.useState([]),n=B(),l=W(),y=a=>{const g=a;r(b=>b&&b.map(M=>{const L=M.participants.map(S=>S._id===g?{...S,isOnline:!0}:S);return{...M,participants:L}}))},x=a=>{const g=a;r(b=>b&&b.map(M=>{const L=M.participants.map(S=>S._id===g?{...S,isOnline:!1}:S);return{...M,participants:L}}))},_=a=>{r(g=>g&&g.map(b=>b._id===a[1]?{...b,isMeeting:!0,meeting_uuid:a[2]}:b))},u=a=>{r(g=>g&&g.map(b=>b._id===a[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},m=()=>{H(c).then(a=>{r(a)}).catch(()=>{l("/auth")})},w=a=>{var b,M;const g=document.querySelectorAll(".chat-room");g==null||g.forEach(L=>{var S;(S=L.classList)==null||S.remove("active")}),(M=(b=g[a])==null?void 0:b.classList)==null||M.add("active"),f(a)},E=a=>{r(g=>g&&g.map(b=>b._id===a[1]?{...b,latestMessage:{sender:a[0],content:a[2],timestamp:a[3],urls:a[4]}}:b))},v=a=>{a[1]===s&&r(g=>g.map(b=>b._id===a[0]?{...b,lastReadTimeStamp:a[2]}:b))};p.useEffect(()=>{o.length>0&&i(o)},[o]),p.useEffect(()=>{if(n)return n.on("onl",y),n.on("off",x),n.on("meet",_),n.on("end_meet",u),n.on("room",m),n.on("msg",E),n.on("seen",v),()=>{n.off("onl",y),n.off("off",x),n.off("meet",_),n.off("end_meet",u),n.off("room",m),n.off("msg",E),n.off("seen",v)}},[n]),p.useEffect(()=>{H(c).then(a=>{r(a)}).catch(()=>{l("/auth")})},[]);const h=async(a,g)=>{switch(a){case"leave":return fetch(`/api/v1/rooms/${g}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+c},body:JSON.stringify({action:a})});case"delete":return fetch(`/api/v1/rooms/${g}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+c}})}},N=p.useMemo(()=>o.map((a,g)=>{var V,U;const b=a==null?void 0:a.lastReadTimeStamp,M=(V=a==null?void 0:a.latestMessage)==null?void 0:V.content,L=(U=a==null?void 0:a.latestMessage)==null?void 0:U.timestamp,S=L&&b&&new Date(L)>new Date(b)&&g!==t;return e.jsxs("div",{className:`chat-room ${g==t?"active":""}`,children:[e.jsxs("div",{onClick:()=>w(g),children:[e.jsx(X,{userId:s,participants:a.participants}),e.jsx("p",{children:M}),e.jsx("p",{children:S?"Unread":"All Read"})]}),e.jsx(oe,{handleAction:h,roomId:a._id})]},a._id)}),[o]);return e.jsx("div",{id:"rooms-nav",children:o&&o.length>0?e.jsx("div",{children:N}):e.jsx("p",{children:"No rooms to display"})})};const D=({onChange:s,accept:t,id:c,icon:f})=>{const i=p.useRef(null),o=r=>{if(r.target.files){const n=r.target.files[0];s(n)}};return e.jsxs("label",{id:`btn_${c}`,className:"btn_fileinput",htmlFor:c,children:[f,e.jsx("input",{id:c,className:"fileinput",type:"file",accept:t,ref:i,onChange:o,style:{display:"none"}})]})};const le=({token:s,userId:t,roomId:c,onJustSent:f})=>{const[i,o]=p.useState(""),[r,n]=p.useState([]),[l,y]=p.useState([]),x=B(),_=async v=>{try{const h=new FormData;return v.forEach(g=>{h.append(`file${v.length>1?"s":""}`,g)}),await(await fetch(`/media/${t}/${c}?token=${s}&count=${v.length}`,{method:"POST",body:h})).json()}catch(h){throw h}},u=v=>{o(v.target.value),console.log("typing ...")},m=async()=>{let v=[],h=[];if(r.length>0&&(console.log(r.length),v=r,n([])),l.length>0&&(console.log(l.length),v=[...v,...l],y([])),v.length>0)try{const N=await _(v);N.urls&&(h=N.urls)}catch(N){return alert("error uploading files: "+N.message)}(i.trim()!==""||h.length!==0)&&(console.log(h),x==null||x.emit("msg",[c,i,new Date,h]),f(),o(""))},w=v=>{y(h=>[...h,v])},E=v=>{n(h=>[...h,v])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(D,{accept:"image/*",onChange:w,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(D,{accept:"*",onChange:E,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),l.length>0&&e.jsx("div",{children:l.map((v,h)=>e.jsx("span",{children:v.name},h))}),r.length>0&&e.jsx("div",{children:r.map((v,h)=>e.jsx("span",{children:v.name},h))}),e.jsx("input",{type:"text",value:i,id:"input_message",onChange:u,onKeyDown:v=>{v.key=="Enter"&&m()}}),e.jsx("button",{onClick:m,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},ce=p.memo(le);const ue={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},de=()=>{const[s,t]=p.useState(sessionStorage.getItem("theme")||"light");return p.useEffect(()=>{const c=ue[s];Object.entries(c).forEach(([f,i])=>{document.documentElement.style.setProperty(`--${f}-color`,i)}),sessionStorage.setItem("theme",s)},[s]),[s,t]},fe=()=>{const[s,t]=de(),c=s==="light",f=()=>{t(c?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:c,onChange:f}),e.jsxs("label",{className:`switcher-label ${c?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const K=(s,t,c)=>{const f=`/meet/${t}?token=${s}&room=${c}`;window.open(f)},he=({token:s,room:t,userId:c})=>{const f=B(),i=()=>{f==null||f.emit("meet",[t._id,new Date])},o=r=>{if(console.log(r),r[0]==c)return r[3]?void 0:K(s,r[2],r[1]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{K(s,r[2],r[1])}):Notification.permission!=="denied"&&Notification.requestPermission().then(n=>{n==="granted"&&o(r)})};return p.useEffect(()=>{if(t&&f)return f.on("meet",o),()=>{f.off("meet",o)}},[f,t]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[t&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:c,participants:t.participants}),t.isMeeting&&t.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>K(s,t.meeting_uuid,t._id),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:i,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(fe,{})]})},pe=p.memo(he);var Z={exports:{}};(function(s,t){(function(f,i){s.exports=i(p,te)})(ne,function(c,f){return function(i){var o={};function r(n){if(o[n])return o[n].exports;var l=o[n]={i:n,l:!1,exports:{}};return i[n].call(l.exports,l,l.exports,r),l.l=!0,l.exports}return r.m=i,r.c=o,r.d=function(n,l,y){r.o(n,l)||Object.defineProperty(n,l,{enumerable:!0,get:y})},r.r=function(n){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},r.t=function(n,l){if(l&1&&(n=r(n)),l&8||l&4&&typeof n=="object"&&n&&n.__esModule)return n;var y=Object.create(null);if(r.r(y),Object.defineProperty(y,"default",{enumerable:!0,value:n}),l&2&&typeof n!="string")for(var x in n)r.d(y,x,(function(_){return n[_]}).bind(null,x));return y},r.n=function(n){var l=n&&n.__esModule?function(){return n.default}:function(){return n};return r.d(l,"a",l),l},r.o=function(n,l){return Object.prototype.hasOwnProperty.call(n,l)},r.p="",r(r.s=4)}([function(i,o,r){i.exports=r(5)()},function(i,o){i.exports=c},function(i,o){i.exports=f},function(i,o){i.exports=function(r,n,l){var y=r.direction,x=r.value;switch(y){case"top":return l.top+x<n.top&&l.bottom>n.bottom&&l.left<n.left&&l.right>n.right;case"left":return l.left+x<n.left&&l.bottom>n.bottom&&l.top<n.top&&l.right>n.right;case"bottom":return l.bottom-x>n.bottom&&l.left<n.left&&l.right>n.right&&l.top<n.top;case"right":return l.right-x>n.right&&l.left<n.left&&l.top<n.top&&l.bottom>n.bottom}}},function(i,o,r){r.r(o),r.d(o,"default",function(){return U});var n=r(1),l=r.n(n),y=r(2),x=r.n(y),_=r(0),u=r.n(_),m=r(3),w=r.n(m);function E(j){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?E=function(T){return typeof T}:E=function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},E(j)}function v(j,C){if(!(j instanceof C))throw new TypeError("Cannot call a class as a function")}function h(j,C){for(var T=0;T<C.length;T++){var d=C[T];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(j,d.key,d)}}function N(j,C,T){return C&&h(j.prototype,C),T&&h(j,T),j}function a(j,C){return C&&(E(C)==="object"||typeof C=="function")?C:b(j)}function g(j){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},g(j)}function b(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}function M(j,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(C&&C.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),C&&L(j,C)}function L(j,C){return L=Object.setPrototypeOf||function(d,R){return d.__proto__=R,d},L(j,C)}function S(j,C,T){return C in j?Object.defineProperty(j,C,{value:T,enumerable:!0,configurable:!0,writable:!0}):j[C]=T,j}function V(j){return j.width===void 0&&(j.width=j.right-j.left),j.height===void 0&&(j.height=j.bottom-j.top),j}var U=function(j){M(C,j);function C(T){var d;return v(this,C),d=a(this,g(C).call(this,T)),S(b(d),"getContainer",function(){return d.props.containment||window}),S(b(d),"addEventListener",function(R,O,P,z){d.debounceCheck||(d.debounceCheck={});var k,F,I=function(){k=null,d.check()};z>-1?F=function(){k||(k=setTimeout(I,z||0))}:F=function(){clearTimeout(k),k=setTimeout(I,P||0)};var A={target:R,fn:F,getLastTimeout:function(){return k}};R.addEventListener(O,A.fn),d.debounceCheck[O]=A}),S(b(d),"startWatching",function(){d.debounceCheck||d.interval||(d.props.intervalCheck&&(d.interval=setInterval(d.check,d.props.intervalDelay)),d.props.scrollCheck&&d.addEventListener(d.getContainer(),"scroll",d.props.scrollDelay,d.props.scrollThrottle),d.props.resizeCheck&&d.addEventListener(window,"resize",d.props.resizeDelay,d.props.resizeThrottle),!d.props.delayedCall&&d.check())}),S(b(d),"stopWatching",function(){if(d.debounceCheck){for(var R in d.debounceCheck)if(d.debounceCheck.hasOwnProperty(R)){var O=d.debounceCheck[R];clearTimeout(O.getLastTimeout()),O.target.removeEventListener(R,O.fn),d.debounceCheck[R]=null}}d.debounceCheck=null,d.interval&&(d.interval=clearInterval(d.interval))}),S(b(d),"check",function(){var R=d.node,O,P;if(!R)return d.state;if(O=V(d.roundRectDown(R.getBoundingClientRect())),d.props.containment){var z=d.props.containment.getBoundingClientRect();P={top:z.top,left:z.left,bottom:z.bottom,right:z.right}}else P={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var k=d.props.offset||{},F=E(k)==="object";F&&(P.top+=k.top||0,P.left+=k.left||0,P.bottom-=k.bottom||0,P.right-=k.right||0);var I={top:O.top>=P.top,left:O.left>=P.left,bottom:O.bottom<=P.bottom,right:O.right<=P.right},A=O.height>0&&O.width>0,$=A&&I.top&&I.left&&I.bottom&&I.right;if(A&&d.props.partialVisibility){var G=O.top<=P.bottom&&O.bottom>=P.top&&O.left<=P.right&&O.right>=P.left;typeof d.props.partialVisibility=="string"&&(G=I[d.props.partialVisibility]),$=d.props.minTopValue?G&&O.top<=P.bottom-d.props.minTopValue:G}typeof k.direction=="string"&&typeof k.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",k.direction,k.value),$=w()(k,O,P));var J=d.state;return d.state.isVisible!==$&&(J={isVisible:$,visibilityRect:I},d.setState(J),d.props.onChange&&d.props.onChange($)),J}),d.state={isVisible:null,visibilityRect:{}},d}return N(C,[{key:"componentDidMount",value:function(){this.node=x.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(d){this.node=x.a.findDOMNode(this),this.props.active&&!d.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(d){return{top:Math.floor(d.top),left:Math.floor(d.left),bottom:Math.floor(d.bottom),right:Math.floor(d.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):l.a.Children.only(this.props.children)}}]),C}(l.a.Component);S(U,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:l.a.createElement("span",null)}),S(U,"propTypes",{onChange:u.a.func,active:u.a.bool,partialVisibility:u.a.oneOfType([u.a.bool,u.a.oneOf(["top","right","bottom","left"])]),delayedCall:u.a.bool,offset:u.a.oneOfType([u.a.shape({top:u.a.number,left:u.a.number,bottom:u.a.number,right:u.a.number}),u.a.shape({direction:u.a.oneOf(["top","right","bottom","left"]),value:u.a.number})]),scrollCheck:u.a.bool,scrollDelay:u.a.number,scrollThrottle:u.a.number,resizeCheck:u.a.bool,resizeDelay:u.a.number,resizeThrottle:u.a.number,intervalCheck:u.a.bool,intervalDelay:u.a.number,containment:typeof window<"u"?u.a.instanceOf(window.Element):u.a.any,children:u.a.oneOfType([u.a.element,u.a.func]),minTopValue:u.a.number})},function(i,o,r){var n=r(6);function l(){}function y(){}y.resetWarningCache=l,i.exports=function(){function x(m,w,E,v,h,N){if(N!==n){var a=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw a.name="Invariant Violation",a}}x.isRequired=x;function _(){return x}var u={array:x,bool:x,func:x,number:x,object:x,string:x,symbol:x,any:x,arrayOf:_,element:x,elementType:x,instanceOf:_,node:x,objectOf:_,oneOf:_,oneOfType:_,shape:_,exact:_,checkPropTypes:y,resetWarningCache:l};return u.PropTypes=u,u}},function(i,o,r){var n="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";i.exports=n}])})})(Z);var me=Z.exports;const ge=se(me);const xe=({src:s,alt:t})=>{const[c,f]=p.useState(!1);return p.useEffect(()=>{const i=new IntersectionObserver(r=>{r.forEach(n=>{n.isIntersecting&&(f(!0),i.unobserve(n.target))})}),o=document.getElementById(`lazyload-element-${s}`);return o&&i.observe(o),()=>{o&&i.unobserve(o)}},[s]),e.jsx("video",{id:`lazyload-element-${s}`,controls:!0,autoPlay:!1,playsInline:!0,src:c?s:"",children:t})},be=({src:s,alt:t})=>{const[c,f]=p.useState(!1);return p.useEffect(()=>{const i=new IntersectionObserver(r=>{r.forEach(n=>{n.isIntersecting&&(f(!0),i.unobserve(n.target))})}),o=document.getElementById(`lazyload-element-${s}`);return o&&i.observe(o),()=>{o&&i.unobserve(o)}},[s]),e.jsx("img",{id:`lazyload-element-${s}`,src:c?s:"",loading:"lazy",alt:t})},ee=({url:s,token:t})=>{var n;const[c,f]=p.useState(!1),[i,o]=p.useState(!1),r=((n=s.split("/").pop())==null?void 0:n.substring(23))||"File";return p.useEffect(()=>{var y;const l=(y=s.split(".").pop())==null?void 0:y.toLowerCase();f(["jpg","jpeg","png","gif","bmp","svg"].includes(l||"")),o(["mp4","webm","ogg"].includes(l||""))},[s]),c?e.jsx(be,{src:s+"?token="+t,alt:r}):i?e.jsx(xe,{src:s+"?token="+t,alt:r}):e.jsx("a",{href:s+"?token="+t,target:"_blank",rel:"noopener noreferrer",children:r})},ve=({token:s,content:t,timestamp:c,urls:f,seenList:i})=>e.jsxs("div",{className:"message out",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:t})}),e.jsx("p",{className:"message_timestamp",children:c}),f&&f.length>0&&f.map((o,r)=>e.jsx(ee,{token:s,url:o},c+r)),i&&i.length>0&&e.jsxs("p",{children:["Seen by:",i.map((o,r)=>e.jsx("span",{children:o},r))]})]}),ye=({token:s,avatarSRC:t,content:c,timestamp:f,urls:i,seenList:o})=>e.jsxs("div",{className:"message in",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:t,alt:"Sender Avatar"}),e.jsx("p",{children:c}),i&&i.length>0&&i.map((r,n)=>e.jsx(ee,{token:s,url:r},f+n))]}),e.jsx("p",{className:"message_timestamp",children:f}),o&&o.length>0&&e.jsxs("p",{children:["Seen by:",o.map((r,n)=>e.jsx("span",{children:r},n))]})]}),je=({readCursors:s,token:t,messages:c,roomId:f,userId:i,participants:o})=>{const[r,n]=p.useState({}),l=p.useRef(c.length),y=B(),x=p.useMemo(()=>Object.fromEntries(o.map(m=>[m._id,m])),[o]),_=p.useMemo(()=>(m,w)=>{const E=w[m];return E?E.avatar:""},[]),u=p.useCallback(m=>{m[0]===f&&n(w=>({...w,[m[1]]:l.current-1}))},[f]);return p.useEffect(()=>{l.current=c.length},[c.length]),p.useEffect(()=>{if(y)return y.on("seen",u),()=>{y.off("seen",u)}},[y,f]),p.useEffect(()=>{const m={};s.filter(w=>w._id!==i).forEach(w=>{const E=new Date(w.lastReadTimeStamp).getTime();let v=0,h=c.length-1,N=-1;for(;v<=h;){const a=Math.floor((v+h)/2);new Date(c[a].timestamp).getTime()<=E?(N=a,v=a+1):h=a-1}N!==-1&&(m[w._id]=N)}),n(m)},[s]),e.jsx(e.Fragment,{children:c.map((m,w)=>{const E=o.filter(v=>r[v._id]===w).map(v=>v.fullname);return m.sender&&m.sender===i?e.jsx(ve,{token:t,content:m.content,timestamp:m.timestamp,urls:m.urls,seenList:E},w):e.jsx(ye,{token:t,avatarSRC:_(m.sender,x),content:m.content,timestamp:m.timestamp,urls:m.urls,seenList:E},w)})})},_e=p.memo(je);const Y=(s,t,c,f)=>fetch(`/api/v1/rooms/${s}?limit=${c}&skip=${f}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(i=>{if(i.status===304)throw new Error("Already got this");if(i.ok)return i.json();throw i.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),q=30,we=({token:s,room:t,userId:c,justSent:f})=>{const[i,o]=p.useState([]),[r,n]=p.useState(0),[l,y]=p.useState([]),x=p.useRef(null),_=p.useRef(null),u=p.useRef(null),m=p.useRef(null),w=B(),E=W(),v=a=>{if(a[1]===t._id){const g=a[0];if(g!==c&&!t.participants.some(S=>S._id===g))return;u.current&&(u.current.style.display="block");const b=a[2],M=a[3],L=a[4];w==null||w.emit("seen",[t._id,new Date]),n(S=>S++),o(S=>S!==null?[...S,{sender:g,content:b,timestamp:M,urls:L}]:[{sender:g,content:b,timestamp:M,urls:L}])}},h=()=>{_.current&&(_.current.scrollIntoView({behavior:"smooth"}),u.current&&(u.current.style.display="none"))},N=a=>{if(!a||!i||i.length==0)return;if(i.length>=r){x.current&&(x.current.style.display="none");return}let g,b=q;g=r-i.length-b,g<0&&(b+=g,g=0),Y(t._id,s,`${b}`,`${g}`).then(M=>{m.current&&(m.current.scrollTop=300),o(L=>L?M.messages.concat(L):M.messages),M.conversationLength&&n(M.conversationLength),M.readCursors&&y(M.readCursors)}).catch(()=>{E("/auth")})};return p.useEffect(()=>{try{if(!s||!t)return;Y(t._id,s).then(a=>{a.messages&&o(a.messages),a.conversationLength&&n(a.conversationLength),a.readCursors&&y(a.readCursors)}).catch(()=>{E("/auth")})}catch(a){console.error(a)}},[s,t._id]),p.useEffect(()=>{if(w)return w.on("msg",v),()=>{w.off("msg",v)}},[w,t]),p.useEffect(()=>{x.current&&(x.current.style.display="none");const a=setTimeout(()=>{x.current&&m.current&&m.current.scrollHeight>m.current.clientHeight&&(x.current.style.display="flex")},1e3);return()=>{clearTimeout(a)}},[t._id]),p.useEffect(()=>{if(!(!m.current||!i)){if(i.length<=q||Math.abs(m.current.scrollHeight-m.current.scrollTop-m.current.clientHeight)<300)return h();if(i[i.length-1].sender==c&&f)return f=!1,h()}},[i]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:m,id:"messages-container",children:[e.jsx(ge,{onChange:N,children:e.jsx("div",{ref:x,id:"topRef",children:e.jsx(re,{size:50})})}),i&&e.jsx(_e,{readCursors:l,token:s,messages:i,roomId:t._id,userId:c,participants:t.participants}),e.jsx("div",{ref:_})]}),e.jsxs("button",{id:"btn_scroll",ref:u,onClick:()=>{h()},children:[Array.isArray(i)&&i.length>1&&i[i.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const Ce=({room:s,token:t,profile:c})=>{const[f,i]=p.useState(!1),o=p.useCallback(()=>{i(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(pe,{token:t,userId:c._id,room:s}),s&&e.jsx(we,{justSent:f,room:s,token:t,userId:c._id}),s&&e.jsx(ce,{token:t,userId:c._id,roomId:s._id,onJustSent:o})]})},Ee=s=>new Promise(async(t,c)=>{if(!window.confirm("Are you sure you want to delete your account?"))return c("Account deletion canceled");const i=window.prompt("Enter your password:");if(!i)return c("Password input canceled");try{const o={password:i},r=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(o)});if(r.ok)return sessionStorage.removeItem("token"),t("Account deletion successful");const n=await r.json();if(n.message)return c(n.message);c("Wrong password")}catch(o){c(o)}});const Se=({token:s,profileData:t,onRefresh:c})=>{const[f,i]=p.useState(!1),[o,r]=p.useState(!1),n=p.useRef(null),l=p.useRef(null),y=W(),x=B();p.useEffect(()=>{if(x)return x.on("inv",c),()=>{x.off("inv",c)}},[x]);const _=()=>{sessionStorage.removeItem("token"),y("/auth")},u=h=>{fetch(`/api/v1/rooms/${h}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({action:"join"})})},m=h=>{fetch(`/api/v1/rooms/${h}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({action:"refuse"})})},w=async()=>{if(!l.current)return;let h={};if(l.current.bio.value&&(h.bio=l.current.bio.value),l.current.fullname.value&&(h.fullname=l.current.fullname.value),l.current.password.value)if(h.password=l.current.password.value,l.current.current_password.value)h.current_password=l.current.current_password.value;else return alert("Please enter current password");if(n.current&&(h.avatar=n.current),!h.bio&&!h.fullname&&!h.password&&!h.avatar)return alert("Empty form");const N=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(h)});if(r(!1),N.ok)return alert("Updated successfully!"),c();const a=await N.json();if(a.message)return alert(a.message);alert("Error updating profile")},E=async h=>{const N=new FormData;N.append("file",h);const a=await fetch(`/media/${t==null?void 0:t._id}/public?token=${s}&count=1`,{method:"POST",body:N}),g=await a.json();!a.ok&&g.message&&alert(g.message),g.urls&&(n.current=g.urls[0],w())},v=async()=>{try{const h=await Ee(s);alert(h),y("/auth")}catch(h){alert(h)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:t==null?void 0:t.avatar,alt:"Profile",id:"profile_img",className:"cover"}),o?e.jsx(D,{accept:"image/*",onChange:E,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:t==null?void 0:t.fullname}),(t==null?void 0:t.bio)&&e.jsx("p",{children:t==null?void 0:t.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{i(!1),r(h=>!h)},children:o?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{r(!1),i(h=>!h)},children:f?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t!=null&&t.invitations.length&&(t==null?void 0:t.invitations.length)>0?e.jsx("span",{id:"nofcount",children:t==null?void 0:t.invitations.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:_,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${f?"active":""}`,children:t&&t.invitations.length>0?t.invitations.map(h=>e.jsxs("div",{children:[e.jsx("p",{children:h}),e.jsx("button",{onClick:()=>u(h),children:"Accept"}),e.jsx("button",{onClick:()=>m(h),children:"Refuse"})]},h)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:`profile_dropdown ${o?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:l,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:t==null?void 0:t.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:t==null?void 0:t.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:v,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:w,children:"Save"})]})]})]})},Te=p.memo(Se);const Ne=({token:s})=>{const[t,c]=p.useState([]),[f,i]=p.useState([]),o=p.useRef(null),r=u=>{if(t.some(m=>m._id==u._id))return alert("already selected this user");c(m=>[...m,u])},n=u=>{console.log("remove user from users list"),u>=0&&u<t.length&&c(m=>m.filter((E,v)=>v!==u))},l=async()=>{if(t.length==0)return alert("Please select a user");const u=t.map(m=>m._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({invited:u})})).ok?c([]):alert("deo biet sao bug luon")}catch(m){console.error(m)}},y=()=>{var m;const u=(m=o.current)==null?void 0:m.value;u&&fetch(`/api/v1/search/${u}`,{headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(w=>{if(w.ok)return w.json().then(E=>{i(E)});console.log(w.status)})},x=u=>{u.key==="Enter"&&y()},_=u=>{o.current&&!o.current.contains(u.target)&&(i([]),o.current.value="")};return p.useEffect(()=>(document.addEventListener("click",_),()=>{document.removeEventListener("click",_)}),[]),e.jsxs("div",{id:"room-maker",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{id:"search-bar",children:[e.jsx("div",{id:"chosenList",className:"flex",children:t.map((u,m)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",u.fullname]}),e.jsx("span",{onClick:()=>n(m),children:e.jsx("i",{className:"bx bx-x-circle"})})]},u.fullname))}),e.jsx("input",{type:"text",placeholder:"Search for users...",ref:o,onKeyPress:x})]}),t.length>0&&e.jsx("div",{className:"flex",children:e.jsx("button",{className:"btn",onClick:l,children:e.jsx("i",{className:"bx bxs-message-square-add ",id:"btn_createroom"})})})]}),f.length>0&&e.jsx("div",{id:"search_dropdown",children:f.map(u=>e.jsxs("div",{onClick:()=>{r({_id:u._id,fullname:u.fullname})},children:[e.jsx("img",{className:"profile-picture",src:u.avatar,alt:"Avatar"}),u.fullname]},u._id))})]})};function Me(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const Q=s=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(t=>{if(t.ok)return t.json();throw t.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Oe=({token:s})=>{const[t,c]=p.useState(null),[f,i]=p.useState([]),[o,r]=p.useState(0);console.log("render main");const n=W(),l=async()=>{try{console.log("Loading profile again...");const _=await Q(s);c(_)}catch{n("/auth")}},y=p.useCallback(_=>{r(_)},[]),x=p.useCallback(_=>{i(_)},[]);return p.useEffect(()=>{s&&Q(s).then(_=>{c(_)}).catch(_=>{console.error(_),n("/auth")})},[s]),e.jsx("div",{id:"main-page",className:"flex",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Te,{token:s,profileData:t,onRefresh:l}),e.jsx(Ne,{token:s}),e.jsx(ae,{userId:t._id,currentRoomIndex:o,token:s,onRoomChange:y,onUpdateStatus:x})]}),e.jsx("section",{id:"section-right",children:e.jsx(Ce,{profile:t,token:s,room:f[o]})})]}),e.jsx(Me,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})},ke=p.memo(Oe);export{ke as default,Q as getProfile};
