var y=Object.defineProperty;var b=(n,t,e)=>t in n?y(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var g=(n,t,e)=>(b(n,typeof t!="symbol"?t+"":t,e),e);import{j as s,r,b as v,u as I}from"./index-9771725a.js";import P,{useSocket as R}from"./index-2f44945a.js";const T=({onReady:n})=>{const t=async()=>{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});if(e)n(e);else throw new Error("Can not get user media")};return s.jsxs(s.Fragment,{children:[s.jsx("p",{children:" You need to allow access to camera and mic"}),s.jsx("button",{onClick:()=>t(),children:"Allow"})]})};const D=({peerId:n,remoteStream:t})=>{console.log("render remote video screen");const e=r.useRef(null),[i,a]=r.useState(!1),m=()=>{e.current&&(e.current.muted=!e.current.muted,a(e.current.muted))};return r.useEffect(()=>{e.current&&t&&(e.current.srcObject=t)},[t,e]),s.jsxs(s.Fragment,{children:[s.jsxs("p",{children:["Peer ID: ",n]}),s.jsx("div",{className:"flex meeting-page_ctrl",children:s.jsx("button",{onClick:m,children:i?"Unmute":"Mute"})}),s.jsx("video",{className:"remote-video",ref:e,autoPlay:!0,playsInline:!0})]})},O=r.memo(D),C=class C{constructor(t,e){g(this,"_rtcConnection");g(this,"_remoteStream");g(this,"createAnswer",async t=>{await this._rtcConnection.setRemoteDescription(t);const e=await this._rtcConnection.createAnswer();return await this._rtcConnection.setLocalDescription(e),e});g(this,"createOffer",async()=>{const t=await this._rtcConnection.createOffer();return await this._rtcConnection.setLocalDescription(t),t});g(this,"addIce",t=>{this._rtcConnection.addIceCandidate(t)});g(this,"setRemoteDescription",async t=>{await this._rtcConnection.setRemoteDescription(t)});this._rtcConnection=new RTCPeerConnection(C._CONFIG),t.getTracks().forEach(i=>{this._rtcConnection.addTrack(i,t)}),this._remoteStream=new MediaStream,this._rtcConnection.ontrack=i=>{i.streams[0].getTracks().forEach(a=>{this._remoteStream.addTrack(a)})},this._rtcConnection.onicecandidate=i=>{e(i.candidate)}}get remoteStream(){return this._remoteStream}};g(C,"_CONFIG",{iceServers:[{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10});let _=C;const S=({localStream:n})=>{const t=r.useRef(null),e=R(),[i,a]=r.useState({}),m=r.useCallback(()=>{n&&n.getVideoTracks().forEach(o=>{o.enabled=!o.enabled})},[n]),u=r.useCallback(()=>{n&&n.getAudioTracks().forEach(o=>{o.enabled=!o.enabled})},[n]),h=r.useCallback(c=>{a(o=>{const l={...o};return delete l[c],l})},[]),w=r.useCallback(async c=>{const o=new _(n,d=>{e==null||e.emit("ice_candidate",[c,d])}),l=await o.createOffer();e==null||e.emit("offer",[c,l]),a(d=>({...d,[c]:{id:c,client:o}}))},[n,e]),p=r.useCallback(async c=>{const[o,l]=c,d=new _(n,k=>{e==null||e.emit("ice_candidate",[o,k])}),f=await d.createAnswer(l);e==null||e.emit("answer",[o,f]),a(k=>({...k,[o]:{id:o,client:d}}))},[n,e]),j=r.useCallback(async c=>{const[o,l]=c;a(d=>{const f={...d[o]};return f.client.setRemoteDescription(l),{...d,[o]:f}})},[]),x=r.useCallback(async c=>{const[o,l]=c;a(d=>{const f={...d[o]};return f.client?(f.client.addIce(l),{...d,[o]:f}):d})},[]);return r.useEffect(()=>{t.current&&n instanceof MediaStream&&(t.current.srcObject=n)},[n]),r.useEffect(()=>{if(e&&n)return console.log("setup listeners"),e.on("new_peer",w),e.on("off_peer",h),e.on("offer",p),e.on("answer",j),e.on("ice_candidate",x),()=>{console.log("clean up listeners"),e.off("new_peer",w),e.off("off_peer",h),e.off("offer",p),e.off("answer",j),e.off("ice_candidate",x)}},[e,n,w,h,p,j,x]),s.jsxs(s.Fragment,{children:[s.jsxs("section",{id:"meeting-page_section_local",className:`${Object.keys(i).length>0?" aside":""}`,children:[s.jsxs("div",{className:"flex meeting-page_ctrl",children:[s.jsx("button",{onClick:m,children:"Toggle camera"}),s.jsx("button",{onClick:u,children:"Toggle sound"})]}),s.jsx("video",{id:"local-video",ref:t,autoPlay:!0,playsInline:!0,muted:!0})]}),Object.keys(i).length>0&&s.jsx("section",{id:"meeting-page_section_remote",className:`${Object.keys(i).length>1?"stacked":""}`,children:Object.values(i).map(c=>s.jsx("div",{className:`remote-peer-container ${c.id}`,children:s.jsx(O,{peerId:c.id,remoteStream:c.client.remoteStream})},c.id))})]})};const $=()=>{const{meetId:n}=v(),[t,e]=r.useState(null),i=I();console.log("meet page render");let a=sessionStorage.getItem("token"),m=sessionStorage.getItem("room");if(!n)i("/auth");else if(!a||!m){const u=new URLSearchParams(window.location.search),h=u.get("token"),w=u.get("room");if(!h||!w)i("/auth");else{u.delete("token"),u.delete("room");const p=`${window.location.pathname}?${u.toString()}`;window.history.replaceState({},"",p),a=h,m=w,sessionStorage.setItem("token",h),sessionStorage.setItem("room",w)}}return console.log("render"),s.jsx("div",{id:"meeting-page",children:a&&m&&n&&t?s.jsx(P,{token:a,joinMeet:{roomId:m,meetId:n},children:s.jsx(S,{localStream:t})}):s.jsx(T,{onReady:u=>{e(u)}})})};export{$ as default};
