import{j as e,r as c,u as E}from"./index-84eeaa5e.js";import{g as k}from"./getSocket-8aa47fbe.js";const F=({participants:s,userId:n})=>{if(s=s.filter(h=>h._id!==n),s.length==0)return null;const r=s.length>1,i=s.slice(0,4);return e.jsx("div",{className:"user-card",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:i.map((h,f)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:h.avatar,alt:"Profile",className:"group-profile-picture"})},f))}),e.jsxs("div",{className:"profile-names",children:[i.length>0&&e.jsx("h3",{children:i.map(h=>h.fullname).join(", ")}),s.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",s.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("div",{className:"user-info ",children:[e.jsxs("h3",{children:[s[0].fullname+"  ",e.jsx("span",{className:s[0].isOnline?"online":"offline",children:"â€¢"})]}),s[0].bio&&e.jsx("p",{children:s[0].bio})]})]})})};const L=s=>new Promise((n,r)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(i=>{if(i.ok)return i.json().then(h=>{n(h)});throw i.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(i=>{r(i)})}),A=({userId:s,currentRoomIndex:n,token:r,onRoomChange:i,onUpdateStatus:h})=>{const[f,d]=c.useState([]),a=c.useRef(""),m=c.useRef(null),p=E(),v=l=>{const t=l;"onl"+t!=a.current&&(a.current="onl"+t,d(o=>o&&o.map(g=>{const w=g.participants.map(j=>j._id===t?{...j,isOnline:!0}:j);return{...g,participants:w}})))},x=l=>{const t=l;"off"+t!=a.current&&(a.current="off"+t,d(o=>o&&o.map(g=>{const w=g.participants.map(j=>j._id===t?{...j,isOnline:!1}:j);return{...g,participants:w}})))},R=()=>{L(r).then(l=>{d(l)}).catch(()=>{p("/auth")})},b=l=>{var o,g;const t=document.querySelectorAll(".chat-room");t==null||t.forEach(w=>{var j;(j=w.classList)==null||j.remove("active")}),(g=(o=t[l])==null?void 0:o.classList)==null||g.add("active"),i(l)};c.useEffect(()=>{f.length>0&&h(f)},[f]),c.useEffect(()=>(r&&L(r).then(l=>{d(l);const t=k(r);t.on("onl",v),t.on("off",x),t.on("room",R),m.current=t}).catch(()=>{p("/auth")}),()=>{var l;(l=m.current)==null||l.disconnect()}),[r]);const u=c.useMemo(()=>f.map((l,t)=>e.jsx("div",{className:`chat-room ${t==n?"active":""}`,onClick:()=>b(t),children:e.jsx(F,{userId:s,participants:l.participants})},l._id)),[f]);return e.jsx("div",{id:"rooms-list",children:f&&f.length>0?e.jsx("div",{children:u}):e.jsx("p",{children:"No rooms to display"})})};const M=(s,n)=>fetch(`/api/v1/rooms/${s}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+n}}).then(r=>{if(r.ok)return r.json();throw r.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let y;const O=({room:s,token:n,profile:r})=>{const[i,h]=c.useState(""),[f,d]=c.useState(null),a=c.useRef(s._id),m=E(),p=u=>{h(u.target.value),console.log("typing ...")},v=()=>{i.trim()!==""&&(y==null||y.emit("msg",[s._id,i,new Date]),h(""))},x=u=>{if(u[1]===a.current){const l=u[0];if(l!==(r==null?void 0:r._id)&&!s.participants.some(g=>g._id===l))return;const t=u[2],o=u[3];d(g=>g!==null?[...g,{sender:l,content:t,timestamp:o}]:[{sender:l,content:t,timestamp:o}])}else console.log("New message, room: "+u[1])},R=()=>{y==null||y.emit("call",[s._id,new Date])},b=u=>{console.log("Receive call"),console.log(u);const l=`/call/${u[1]}?token=${n}`;if(u[0]==(r==null?void 0:r._id))return window.open(l);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{window.open(l)}):Notification.permission!=="denied"&&Notification.requestPermission().then(t=>{t==="granted"&&b(u)})};return c.useEffect(()=>{try{if(!n||!s)return;M(s._id,n).then(u=>{d(u.messages)}).catch(()=>{m("/auth")})}catch(u){console.error(u)}},[n,s._id]),c.useEffect(()=>{n&&(y=k(n),y==null||y.on("msg",x),y==null||y.on("call",b))},[n]),c.useEffect(()=>{a.current=s._id},[s._id]),e.jsxs("div",{id:"chat-box",children:[e.jsx("button",{onClick:R,children:"Make call"}),e.jsx("div",{className:"message-container",children:Array.isArray(f)&&f.map((u,l)=>{let t;if(u.sender&&u.sender==(r==null?void 0:r._id))t=r.avatar;else{const o=s.participants.find(g=>g._id===u.sender);t=o?o.avatar:""}return e.jsxs("div",{className:`message ${u.sender==(r==null?void 0:r._id)?"own":""}`,children:[t&&e.jsx("img",{className:"inchat-avatar",src:t,alt:"Sender Avatar"}),e.jsx("span",{children:u.content}),e.jsx("span",{children:u.timestamp})]},l)})}),e.jsxs("div",{className:"input-container flex",children:[e.jsx("input",{type:"text",value:i,onChange:p,className:"input-field"}),e.jsx("button",{onClick:v,className:"send-button",children:"Send"})]})]})};const T={text:"#000",bg:"#ffffff"},$={text:"#ffffff",bg:"#000"},z=()=>{const[s,n]=c.useState(sessionStorage.getItem("theme")==="light"),r=()=>{n(!s)};return c.useEffect(()=>{var i,h;s?(sessionStorage.setItem("theme","light"),(i=document.querySelector(".switcher-label"))==null||i.classList.remove("active"),document.documentElement.style.setProperty("--text-color",$.text),document.documentElement.style.setProperty("--background-color",$.bg)):(sessionStorage.setItem("theme","dark"),(h=document.querySelector(".switcher-label"))==null||h.classList.add("active"),document.documentElement.style.setProperty("--text-color",T.text),document.documentElement.style.setProperty("--background-color",T.bg))},[s]),e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:s,onChange:r}),e.jsxs("label",{className:"switcher-label",htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const q=({token:s,profileData:n,onRefresh:r})=>{const[i,h]=c.useState(!1),[f,d]=c.useState(!1),a=c.useRef(null),m=c.useRef(null),p=c.useRef(null),v=E();c.useEffect(()=>{if(s){const t=k(s);t.on("inv",r),p.current=t}return()=>{var t;(t=p.current)==null||t.disconnect()}},[s]);const x=()=>{sessionStorage.removeItem("token"),v("/auth")},R=async t=>{try{console.log("Accepted invitation:",t),(await fetch(`/api/v1/rooms/${t}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({accept:!0})})).ok&&alert("ok")}catch(o){console.error(o)}},b=async t=>{try{console.log("Refused invitation:",t),(await fetch(`/api/v1/rooms/${t}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({accept:!1})})).ok&&alert("ok")}catch(o){console.error(o)}},u=async t=>{t.preventDefault();let o={};if(t.target.bio.value&&(o.bio=t.target.bio.value),t.target.fullname.value&&(o.fullname=t.target.fullname.value),t.target.password.value&&(o.password=t.target.password.value),m.current&&(o.avatar=m.current),!o.bio&&!o.fullname&&!o.password&&!o.avatar)return alert("Empty form");(await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(o)})).ok?r():(alert("Error while updating profile"),d(!1))},l=()=>{if(a!=null&&a.current&&a.current.length>0){const t=a.current.files[0],o=new FileReader;o.onload=async g=>{var w;if((w=g.target)!=null&&w.result){const j=new Image;j.onload=async()=>{const C=document.createElement("canvas"),_=200,I=200;let S=j.width,N=j.height;S>_&&(N*=_/S,S=_),N>I&&(S*=I/N,N=I),C.width=S,C.height=N;const P=C.getContext("2d");P==null||P.drawImage(j,0,0,S,N);const B=C.toDataURL("image/jpeg");m.current=B},j.src=g.target.result}},o.readAsDataURL(t)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"profile",children:[e.jsx("img",{src:n==null?void 0:n.avatar,alt:"Profile",id:"profile_img"}),f?e.jsx("input",{type:"file",accept:"image/*",ref:a,onChange:l}):e.jsx("button",{onClick:()=>d(!0),children:"Edit"}),e.jsxs("div",{children:[e.jsx("h3",{children:n==null?void 0:n.fullname}),(n==null?void 0:n.bio)&&e.jsx("p",{children:n==null?void 0:n.bio})]}),e.jsx("button",{onClick:()=>h(t=>!t),children:i?"X":`TB (${n==null?void 0:n.invitations.length})`}),i&&e.jsx("div",{children:n&&n.invitations.length>0?n.invitations.map(t=>e.jsxs("div",{children:[e.jsx("p",{children:t}),e.jsx("button",{onClick:()=>R(t),children:"Accept"}),e.jsx("button",{onClick:()=>b(t),children:"Refuse"})]},t)):e.jsx("p",{children:"No invitations"})}),e.jsx(z,{}),e.jsx("button",{id:"logout-btn",onClick:x,children:"Logout"})]}),f&&e.jsxs("form",{onSubmit:u,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"Password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]}),e.jsx("button",{type:"submit",children:"Save"}),e.jsx("button",{onClick:()=>d(!1),children:"Cancel"})]})]})},G=c.memo(q);const J=({token:s,onChoose:n})=>{const r=c.useRef(null),[i,h]=c.useState([]),f=()=>{var p;const m=(p=r.current)==null?void 0:p.value;m&&fetch(`/api/v1/search/${m}`,{headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(v=>{if(v.ok)return v.json().then(x=>{h(x)});console.log(v.status)})},d=m=>{m.key==="Enter"&&f()},a=m=>{r.current&&!r.current.contains(m.target)&&(h([]),r.current.value="")};return c.useEffect(()=>(document.addEventListener("click",a),()=>{document.removeEventListener("click",a)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:r,onKeyPress:d}),e.jsx("button",{onClick:f,children:"Search"}),i.length>0&&e.jsx("div",{className:"search_dropdown",children:i.map(m=>e.jsxs("div",{onClick:()=>{n({_id:m._id,fullname:m.fullname})},children:[e.jsx("img",{src:m.avatar,alt:"Avatar"}),m.fullname]},m._id))})]})};const K=({token:s})=>{const[n,r]=c.useState([]),i=d=>{if(n.some(a=>a._id==d._id))return alert("already selected this user");r(a=>[...a,d])},h=d=>{console.log("remove user from users list"),d>=0&&d<n.length&&r(a=>a.filter((p,v)=>v!==d))},f=async()=>{if(n.length==0)return alert("Please select a user");const d=n.map(a=>a._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({invited:d})})).ok?r([]):alert("deo biet sao bug luon")}catch(a){console.error(a)}};return e.jsxs("div",{id:"room-maker",children:[n.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:n.map((d,a)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",d.fullname]}),e.jsx("span",{onClick:()=>h(a),children:"X"})]},d.fullname))}),e.jsx("button",{onClick:f,children:"Create"})]}),e.jsx(J,{token:s,onChoose:i})]})},U=s=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),H=({token:s})=>{const[n,r]=c.useState(null),[i,h]=c.useState([]),[f,d]=c.useState(0),a=E(),m=async()=>{try{const x=await U(s);r(x)}catch{a("/auth")}},p=x=>{d(x)},v=x=>{h(x)};return c.useEffect(()=>{s&&U(s).then(x=>{r(x)}).catch(x=>{console.error(x),a("/auth")})},[s]),e.jsxs("div",{id:"main-page",className:"flex",children:[" ",n?e.jsxs(e.Fragment,{children:[e.jsxs("section",{id:"section-left",children:[e.jsx(G,{token:s,profileData:n,onRefresh:m}),e.jsx(K,{token:s}),e.jsx(A,{userId:n._id,currentRoomIndex:f,token:s,onRoomChange:p,onUpdateStatus:v})]}),e.jsx("section",{id:"section-right",children:i.length>0&&e.jsx(O,{profile:n,token:s,room:i[f]})})]}):e.jsx("div",{children:"Loading skeleton ..."})]})};export{H as default,U as getProfile};
