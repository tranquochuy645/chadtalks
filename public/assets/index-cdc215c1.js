import{r as h,j as e,u as D,a as ne,c as se,g as re,P as ie}from"./index-a2d0ecdf.js";import{useSocket as B}from"./index-8e16f3f9.js";const oe=({participants:r,userId:s})=>{if(r=r.filter(o=>o._id!==s),r.length===0)return e.jsx("div",{className:"card",children:e.jsx("h3",{children:"No other participants in this room."})});const u=r.length>1,f=r.slice(0,4);return e.jsx("div",{className:"card",children:u?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:f.map((o,a)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:o.avatar,alt:"img",className:"group-profile-picture"})},a))}),e.jsxs("div",{className:"profile-names",children:[f.length>0&&e.jsx("h3",{children:f.map(o=>o.fullname).join(", ")}),r.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",r.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:r[0].avatar,alt:"img",className:"profile-picture"}),e.jsxs("h3",{children:[r[0].fullname+"  ",e.jsx("span",{className:r[0].isOnline?"online":"offline",children:"â€¢"})]}),r[0].bio&&e.jsx("p",{children:r[0].bio})]})})},Z=h.memo(oe);const ae=({roomId:r,handleAction:s})=>e.jsxs("div",{className:"opts-wrapper",children:[e.jsx("input",{className:"checkbox",type:"checkbox",id:`${r}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${r}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{className:"chat-room_opts_btn leave",onClick:()=>s("leave",r),children:"Leave"}),e.jsx("button",{className:"chat-room_opts_btn delete",onClick:()=>s("delete",r),children:"Delete"})]})]});const H=r=>new Promise((s,u)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+r}}).then(f=>{if(f.ok)return f.json().then(o=>{s(o)});if(f.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(f=>{u(f)})}),le=({userId:r,currentRoomIndex:s,token:u,onRoomChange:f,onUpdateStatus:o})=>{const[a,i]=h.useState([]),t=B(),d=D(),v=n=>{const g=n;i(b=>b&&b.map(N=>{const M=N.participants.map(S=>S._id===g?{...S,isOnline:!0}:S);return{...N,participants:M}}))},m=n=>{const g=n;i(b=>b&&b.map(N=>{const M=N.participants.map(S=>S._id===g?{...S,isOnline:!1}:S);return{...N,participants:M}}))},y=n=>{i(g=>g&&g.map(b=>b._id===n[1]?{...b,isMeeting:!0,meeting_uuid:n[2]}:b))},l=n=>{i(g=>g&&g.map(b=>b._id===n[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},p=()=>{H(u).then(n=>{i(n)}).catch(()=>{d("/auth")})},_=n=>{var b,N;const g=document.querySelectorAll(".chat-room");g==null||g.forEach(M=>{var S;(S=M.classList)==null||S.remove("active")}),(N=(b=g[n])==null?void 0:b.classList)==null||N.add("active"),f(n)},E=n=>{i(g=>g&&g.map(b=>b._id===n[1]?{...b,latestMessage:{sender:n[0],content:n[2],timestamp:n[3],urls:n[4]}}:b))},x=n=>{n[1]===r&&i(g=>g.map(b=>b._id===n[0]?{...b,lastReadTimeStamp:n[2]}:b))};h.useEffect(()=>{a.length>0&&o(a)},[a]),h.useEffect(()=>{if(t)return t.on("onl",v),t.on("off",m),t.on("meet",y),t.on("end_meet",l),t.on("room",p),t.on("msg",E),t.on("seen",x),()=>{t.off("onl",v),t.off("off",m),t.off("meet",y),t.off("end_meet",l),t.off("room",p),t.off("msg",E),t.off("seen",x)}},[t]),h.useEffect(()=>{H(u).then(n=>{i(n)}).catch(()=>{d("/auth")})},[]);const w=async(n,g)=>{switch(n){case"leave":return fetch(`/api/v1/rooms/${g}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+u},body:JSON.stringify({action:n})});case"delete":return fetch(`/api/v1/rooms/${g}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+u}})}},P=h.useMemo(()=>a.map((n,g)=>{var V,z;const b=n==null?void 0:n.lastReadTimeStamp,N=(V=n==null?void 0:n.latestMessage)==null?void 0:V.content,M=(z=n==null?void 0:n.latestMessage)==null?void 0:z.timestamp,S=M&&b&&new Date(M)>new Date(b)&&g!==s;return e.jsxs("div",{className:`chat-room ${g==s?"active":""}`,onClick:()=>_(g),children:[e.jsxs("div",{className:"chat-room_info",children:[e.jsx(Z,{userId:r,participants:n.participants}),e.jsx("p",{className:`last-msg ${S?"unread":""}`,children:N})]}),e.jsx(ae,{handleAction:w,roomId:n._id})]},n._id)}),[a]);return e.jsx("div",{id:"rooms-nav",children:a&&a.length>0?e.jsx("div",{children:P}):e.jsx("p",{children:"No rooms to display"})})};const G=({onChange:r,accept:s,id:u,icon:f})=>{const o=h.useRef(null),a=i=>{if(i.target.files){const t=i.target.files[0];r(t)}};return e.jsxs("label",{id:`btn_${u}`,className:"btn_fileinput",htmlFor:u,children:[f,e.jsx("input",{id:u,className:"fileinput",type:"file",accept:s,ref:o,onChange:a,style:{display:"none"}})]})};const ce=({token:r,userId:s,roomId:u,onJustSent:f})=>{const[o,a]=h.useState(""),[i,t]=h.useState([]),[d,v]=h.useState([]),m=B(),y=async x=>{try{const w=new FormData;return x.forEach(g=>{w.append(`file${x.length>1?"s":""}`,g)}),await(await fetch(`/media/${s}/${u}?token=${r}&count=${x.length}`,{method:"POST",body:w})).json()}catch(w){throw w}},l=x=>{a(x.target.value),console.log("typing ...")},p=async()=>{let x=[],w=[];if(i.length>0&&(console.log(i.length),x=i,t([])),d.length>0&&(console.log(d.length),x=[...x,...d],v([])),x.length>0)try{const P=await y(x);P.urls&&(w=P.urls)}catch(P){return alert("error uploading files: "+P.message)}(o.trim()!==""||w.length!==0)&&(console.log(w),m==null||m.emit("msg",[u,o,new Date,w]),f(),a(""))},_=x=>{v(w=>[...w,x])},E=x=>{t(w=>[...w,x])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(G,{accept:"image/*",onChange:_,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(G,{accept:"*",onChange:E,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),d.length>0&&e.jsx("div",{children:d.map((x,w)=>e.jsx("span",{children:x.name},w))}),i.length>0&&e.jsx("div",{children:i.map((x,w)=>e.jsx("span",{children:x.name},w))}),e.jsx("input",{type:"text",value:o,id:"input_message",onChange:l,onKeyDown:x=>{x.key=="Enter"&&p()}}),e.jsx("button",{onClick:p,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},ue=h.memo(ce);const K=(r,s,u)=>{const f=`/meet/${s}?token=${r}&room=${u}`;window.open(f)},de=({token:r,room:s,userId:u})=>{const f=B(),o=()=>{f==null||f.emit("meet",[s._id,new Date])},a=i=>{if(console.log(i),i[0]==u)return i[3]?void 0:K(r,i[2],i[1]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{K(r,i[2],i[1])}):Notification.permission!=="denied"&&Notification.requestPermission().then(t=>{t==="granted"&&a(i)})};return h.useEffect(()=>{if(s&&f)return f.on("meet",a),()=>{f.off("meet",a)}},[f,s]),e.jsx("div",{id:"chat-box_topbar",className:"flex",children:s&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(Z,{userId:u,participants:s.participants}),s.isMeeting&&s.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>K(r,s.meeting_uuid,s._id),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:o,children:e.jsx("i",{className:"bx bxs-video"})})]})})},fe=h.memo(de);var ee={exports:{}};(function(r,s){(function(f,o){r.exports=o(h,ne)})(se,function(u,f){return function(o){var a={};function i(t){if(a[t])return a[t].exports;var d=a[t]={i:t,l:!1,exports:{}};return o[t].call(d.exports,d,d.exports,i),d.l=!0,d.exports}return i.m=o,i.c=a,i.d=function(t,d,v){i.o(t,d)||Object.defineProperty(t,d,{enumerable:!0,get:v})},i.r=function(t){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,d){if(d&1&&(t=i(t)),d&8||d&4&&typeof t=="object"&&t&&t.__esModule)return t;var v=Object.create(null);if(i.r(v),Object.defineProperty(v,"default",{enumerable:!0,value:t}),d&2&&typeof t!="string")for(var m in t)i.d(v,m,(function(y){return t[y]}).bind(null,m));return v},i.n=function(t){var d=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(d,"a",d),d},i.o=function(t,d){return Object.prototype.hasOwnProperty.call(t,d)},i.p="",i(i.s=4)}([function(o,a,i){o.exports=i(5)()},function(o,a){o.exports=u},function(o,a){o.exports=f},function(o,a){o.exports=function(i,t,d){var v=i.direction,m=i.value;switch(v){case"top":return d.top+m<t.top&&d.bottom>t.bottom&&d.left<t.left&&d.right>t.right;case"left":return d.left+m<t.left&&d.bottom>t.bottom&&d.top<t.top&&d.right>t.right;case"bottom":return d.bottom-m>t.bottom&&d.left<t.left&&d.right>t.right&&d.top<t.top;case"right":return d.right-m>t.right&&d.left<t.left&&d.top<t.top&&d.bottom>t.bottom}}},function(o,a,i){i.r(a),i.d(a,"default",function(){return z});var t=i(1),d=i.n(t),v=i(2),m=i.n(v),y=i(0),l=i.n(y),p=i(3),_=i.n(p);function E(j){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?E=function(T){return typeof T}:E=function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},E(j)}function x(j,C){if(!(j instanceof C))throw new TypeError("Cannot call a class as a function")}function w(j,C){for(var T=0;T<C.length;T++){var c=C[T];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(j,c.key,c)}}function P(j,C,T){return C&&w(j.prototype,C),T&&w(j,T),j}function n(j,C){return C&&(E(C)==="object"||typeof C=="function")?C:b(j)}function g(j){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},g(j)}function b(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}function N(j,C){if(typeof C!="function"&&C!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(C&&C.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),C&&M(j,C)}function M(j,C){return M=Object.setPrototypeOf||function(c,R){return c.__proto__=R,c},M(j,C)}function S(j,C,T){return C in j?Object.defineProperty(j,C,{value:T,enumerable:!0,configurable:!0,writable:!0}):j[C]=T,j}function V(j){return j.width===void 0&&(j.width=j.right-j.left),j.height===void 0&&(j.height=j.bottom-j.top),j}var z=function(j){N(C,j);function C(T){var c;return x(this,C),c=n(this,g(C).call(this,T)),S(b(c),"getContainer",function(){return c.props.containment||window}),S(b(c),"addEventListener",function(R,O,k,U){c.debounceCheck||(c.debounceCheck={});var I,F,L=function(){I=null,c.check()};U>-1?F=function(){I||(I=setTimeout(L,U||0))}:F=function(){clearTimeout(I),I=setTimeout(L,k||0)};var A={target:R,fn:F,getLastTimeout:function(){return I}};R.addEventListener(O,A.fn),c.debounceCheck[O]=A}),S(b(c),"startWatching",function(){c.debounceCheck||c.interval||(c.props.intervalCheck&&(c.interval=setInterval(c.check,c.props.intervalDelay)),c.props.scrollCheck&&c.addEventListener(c.getContainer(),"scroll",c.props.scrollDelay,c.props.scrollThrottle),c.props.resizeCheck&&c.addEventListener(window,"resize",c.props.resizeDelay,c.props.resizeThrottle),!c.props.delayedCall&&c.check())}),S(b(c),"stopWatching",function(){if(c.debounceCheck){for(var R in c.debounceCheck)if(c.debounceCheck.hasOwnProperty(R)){var O=c.debounceCheck[R];clearTimeout(O.getLastTimeout()),O.target.removeEventListener(R,O.fn),c.debounceCheck[R]=null}}c.debounceCheck=null,c.interval&&(c.interval=clearInterval(c.interval))}),S(b(c),"check",function(){var R=c.node,O,k;if(!R)return c.state;if(O=V(c.roundRectDown(R.getBoundingClientRect())),c.props.containment){var U=c.props.containment.getBoundingClientRect();k={top:U.top,left:U.left,bottom:U.bottom,right:U.right}}else k={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var I=c.props.offset||{},F=E(I)==="object";F&&(k.top+=I.top||0,k.left+=I.left||0,k.bottom-=I.bottom||0,k.right-=I.right||0);var L={top:O.top>=k.top,left:O.left>=k.left,bottom:O.bottom<=k.bottom,right:O.right<=k.right},A=O.height>0&&O.width>0,$=A&&L.top&&L.left&&L.bottom&&L.right;if(A&&c.props.partialVisibility){var W=O.top<=k.bottom&&O.bottom>=k.top&&O.left<=k.right&&O.right>=k.left;typeof c.props.partialVisibility=="string"&&(W=L[c.props.partialVisibility]),$=c.props.minTopValue?W&&O.top<=k.bottom-c.props.minTopValue:W}typeof I.direction=="string"&&typeof I.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",I.direction,I.value),$=_()(I,O,k));var J=c.state;return c.state.isVisible!==$&&(J={isVisible:$,visibilityRect:L},c.setState(J),c.props.onChange&&c.props.onChange($)),J}),c.state={isVisible:null,visibilityRect:{}},c}return P(C,[{key:"componentDidMount",value:function(){this.node=m.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(c){this.node=m.a.findDOMNode(this),this.props.active&&!c.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(c){return{top:Math.floor(c.top),left:Math.floor(c.left),bottom:Math.floor(c.bottom),right:Math.floor(c.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):d.a.Children.only(this.props.children)}}]),C}(d.a.Component);S(z,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:d.a.createElement("span",null)}),S(z,"propTypes",{onChange:l.a.func,active:l.a.bool,partialVisibility:l.a.oneOfType([l.a.bool,l.a.oneOf(["top","right","bottom","left"])]),delayedCall:l.a.bool,offset:l.a.oneOfType([l.a.shape({top:l.a.number,left:l.a.number,bottom:l.a.number,right:l.a.number}),l.a.shape({direction:l.a.oneOf(["top","right","bottom","left"]),value:l.a.number})]),scrollCheck:l.a.bool,scrollDelay:l.a.number,scrollThrottle:l.a.number,resizeCheck:l.a.bool,resizeDelay:l.a.number,resizeThrottle:l.a.number,intervalCheck:l.a.bool,intervalDelay:l.a.number,containment:typeof window<"u"?l.a.instanceOf(window.Element):l.a.any,children:l.a.oneOfType([l.a.element,l.a.func]),minTopValue:l.a.number})},function(o,a,i){var t=i(6);function d(){}function v(){}v.resetWarningCache=d,o.exports=function(){function m(p,_,E,x,w,P){if(P!==t){var n=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw n.name="Invariant Violation",n}}m.isRequired=m;function y(){return m}var l={array:m,bool:m,func:m,number:m,object:m,string:m,symbol:m,any:m,arrayOf:y,element:m,elementType:m,instanceOf:y,node:m,objectOf:y,oneOf:y,oneOfType:y,shape:y,exact:y,checkPropTypes:v,resetWarningCache:d};return l.PropTypes=l,l}},function(o,a,i){var t="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";o.exports=t}])})})(ee);var he=ee.exports;const pe=re(he);const me=({src:r,alt:s})=>{const[u,f]=h.useState(!1);return h.useEffect(()=>{const o=new IntersectionObserver(i=>{i.forEach(t=>{t.isIntersecting&&(f(!0),o.unobserve(t.target))})}),a=document.getElementById(`lazyload-element-${r}`);return a&&o.observe(a),()=>{a&&o.unobserve(a)}},[r]),e.jsx("video",{id:`lazyload-element-${r}`,controls:!0,autoPlay:!1,playsInline:!0,src:u?r:"",children:s})},ge=({src:r,alt:s})=>{const[u,f]=h.useState(!1);return h.useEffect(()=>{const o=new IntersectionObserver(i=>{i.forEach(t=>{t.isIntersecting&&(f(!0),o.unobserve(t.target))})}),a=document.getElementById(`lazyload-element-${r}`);return a&&o.observe(a),()=>{a&&o.unobserve(a)}},[r]),e.jsx("img",{id:`lazyload-element-${r}`,src:u?r:"",loading:"lazy",alt:s})},te=({url:r,token:s})=>{var t;const[u,f]=h.useState(!1),[o,a]=h.useState(!1),i=((t=r.split("/").pop())==null?void 0:t.substring(23))||"File";return h.useEffect(()=>{var v;const d=(v=r.split(".").pop())==null?void 0:v.toLowerCase();f(["jpg","jpeg","png","gif","bmp","svg"].includes(d||"")),a(["mp4","webm","ogg"].includes(d||""))},[r]),u?e.jsx(ge,{src:r+"?token="+s,alt:i}):o?e.jsx(me,{src:r+"?token="+s,alt:i}):e.jsx("a",{href:r+"?token="+s,target:"_blank",rel:"noopener noreferrer",children:i})},be=({token:r,content:s,timestamp:u,urls:f,seenList:o})=>e.jsxs("div",{className:"message out",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:s})}),e.jsx("p",{className:"message_timestamp",children:u}),f&&f.length>0&&f.map((a,i)=>e.jsx(te,{token:r,url:a},u+i)),o&&o.length>0&&e.jsxs("p",{className:"message_seenby",children:["Seen by:",o.map((a,i)=>e.jsx("span",{children:" "+a},i))]})]}),xe=({token:r,avatarSRC:s,content:u,timestamp:f,urls:o,seenList:a})=>e.jsxs("div",{className:"message in",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:s,alt:"Sender Avatar"}),e.jsx("p",{children:u}),o&&o.length>0&&o.map((i,t)=>e.jsx(te,{token:r,url:i},f+t))]}),e.jsx("p",{className:"message_timestamp",children:f}),a&&a.length>0&&e.jsxs("p",{className:"message_seenby",children:["Seen by:",a.map((i,t)=>e.jsx("span",{children:i},t))]})]}),ve=({readCursors:r,token:s,messages:u,roomId:f,userId:o,participants:a})=>{const[i,t]=h.useState({}),d=h.useRef(u.length),v=B(),m=h.useMemo(()=>Object.fromEntries(a.map(p=>[p._id,p])),[a]),y=h.useMemo(()=>(p,_)=>{const E=_[p];return E?E.avatar:""},[]),l=h.useCallback(p=>{p[0]===f&&t(_=>({..._,[p[1]]:d.current-1}))},[f]);return h.useEffect(()=>{d.current=u.length},[u.length]),h.useEffect(()=>{if(v)return v.on("seen",l),()=>{v.off("seen",l)}},[v,f]),h.useEffect(()=>{const p={};r.filter(_=>_._id!==o).forEach(_=>{const E=new Date(_.lastReadTimeStamp).getTime();let x=0,w=u.length-1,P=-1;for(;x<=w;){const n=Math.floor((x+w)/2);new Date(u[n].timestamp).getTime()<=E?(P=n,x=n+1):w=n-1}P!==-1&&(p[_._id]=P)}),t(p)},[r]),e.jsx(e.Fragment,{children:u.map((p,_)=>{const E=a.filter(x=>i[x._id]===_).map(x=>x.fullname);return p.sender&&p.sender===o?e.jsx(be,{token:s,content:p.content,timestamp:p.timestamp,urls:p.urls,seenList:E},_):e.jsx(xe,{token:s,avatarSRC:y(p.sender,m),content:p.content,timestamp:p.timestamp,urls:p.urls,seenList:E},_)})})},ye=h.memo(ve);const Y=(r,s,u,f)=>fetch(`/api/v1/rooms/${r}?limit=${u}&skip=${f}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(o=>{if(o.status===304)throw new Error("Already got this");if(o.ok)return o.json();throw o.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),q=30,je=({token:r,room:s,userId:u,justSent:f})=>{const[o,a]=h.useState([]),[i,t]=h.useState(0),[d,v]=h.useState([]),m=h.useRef(null),y=h.useRef(null),l=h.useRef(null),p=h.useRef(null),_=B(),E=D(),x=n=>{if(n[1]===s._id){const g=n[0];if(g!==u&&!s.participants.some(S=>S._id===g))return;l.current&&(l.current.style.display="block");const b=n[2],N=n[3],M=n[4];_==null||_.emit("seen",[s._id,new Date]),t(S=>S++),a(S=>S!==null?[...S,{sender:g,content:b,timestamp:N,urls:M}]:[{sender:g,content:b,timestamp:N,urls:M}])}},w=()=>{y.current&&(y.current.scrollIntoView({behavior:"smooth"}),l.current&&(l.current.style.display="none"))},P=n=>{if(!n||!o||o.length==0)return;if(o.length>=i){m.current&&(m.current.style.display="none");return}let g,b=q;g=i-o.length-b,g<0&&(b+=g,g=0),Y(s._id,r,`${b}`,`${g}`).then(N=>{p.current&&(p.current.scrollTop=300),a(M=>M?N.messages.concat(M):N.messages),N.conversationLength&&t(N.conversationLength),N.readCursors&&v(N.readCursors)}).catch(()=>{E("/auth")})};return h.useEffect(()=>{try{if(!r||!s)return;Y(s._id,r).then(n=>{n.messages&&a(n.messages),n.conversationLength&&t(n.conversationLength),n.readCursors&&v(n.readCursors)}).catch(()=>{E("/auth")})}catch(n){console.error(n)}},[r,s._id]),h.useEffect(()=>{if(_)return _.on("msg",x),()=>{_.off("msg",x)}},[_,s]),h.useEffect(()=>{m.current&&(m.current.style.display="none");const n=setTimeout(()=>{m.current&&p.current&&p.current.scrollHeight>p.current.clientHeight&&(m.current.style.display="flex")},1e3);return()=>{clearTimeout(n)}},[s._id]),h.useEffect(()=>{if(!(!p.current||!o)){if(o.length<=q||Math.abs(p.current.scrollHeight-p.current.scrollTop-p.current.clientHeight)<300)return w();if(o[o.length-1].sender==u&&f)return f=!1,w()}},[o]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:p,id:"messages-container",children:[e.jsx(pe,{onChange:P,children:e.jsx("div",{ref:m,id:"topRef",children:e.jsx(ie,{size:50})})}),o&&e.jsx(ye,{readCursors:d,token:r,messages:o,roomId:s._id,userId:u,participants:s.participants}),e.jsx("div",{ref:y})]}),e.jsxs("button",{id:"btn_scroll",ref:l,onClick:()=>{w()},children:[Array.isArray(o)&&o.length>1&&o[o.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const _e=({room:r,token:s,profile:u})=>{const[f,o]=h.useState(!1),a=h.useCallback(()=>{o(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(fe,{token:s,userId:u._id,room:r}),r&&e.jsx(je,{justSent:f,room:r,token:s,userId:u._id}),r&&e.jsx(ue,{token:s,userId:u._id,roomId:r._id,onJustSent:a})]})},we=r=>new Promise(async(s,u)=>{if(!window.confirm("Are you sure you want to delete your account?"))return u("Account deletion canceled");const o=window.prompt("Enter your password:");if(!o)return u("Password input canceled");try{const a={password:o},i=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify(a)});if(i.ok)return sessionStorage.removeItem("token"),s("Account deletion successful");const t=await i.json();if(t.message)return u(t.message);u("Wrong password")}catch(a){u(a)}});const Q=async r=>{try{return await(await fetch("api/v1/users/invitations",{headers:{"content-type":"application/json",authorization:"Bearer "+r}})).json()}catch(s){console.error(s)}},Ce=({token:r,profileData:s,onRefresh:u})=>{const[f,o]=h.useState(!1),[a,i]=h.useState(!1),[t,d]=h.useState(null),v=h.useRef(null),m=h.useRef(null),y=D(),l=B();h.useEffect(()=>{r&&Q(r).then(n=>d(n))},[r]),h.useEffect(()=>{const n=()=>{r&&Q(r).then(g=>d(g))};if(l)return l.on("inv",n),()=>{l.off("inv",n)}},[l]);const p=()=>{sessionStorage.removeItem("token"),y("/auth")},_=n=>{fetch(`/api/v1/rooms/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({action:"join"})})},E=n=>{fetch(`/api/v1/rooms/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({action:"refuse"})})},x=async()=>{if(!m.current)return;let n={};if(m.current.bio.value&&(n.bio=m.current.bio.value),m.current.fullname.value&&(n.fullname=m.current.fullname.value),m.current.password.value)if(n.password=m.current.password.value,m.current.current_password.value)n.current_password=m.current.current_password.value;else return alert("Please enter current password");if(v.current&&(n.avatar=v.current),!n.bio&&!n.fullname&&!n.password&&!n.avatar)return alert("Empty form");const g=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify(n)});if(i(!1),g.ok)return alert("Updated successfully!"),u();const b=await g.json();if(b.message)return alert(b.message);alert("Error updating profile")},w=async n=>{const g=new FormData;g.append("file",n);const b=await fetch(`/media/${s==null?void 0:s._id}/public?token=${r}&count=1`,{method:"POST",body:g}),N=await b.json();!b.ok&&N.message&&alert(N.message),N.urls&&(v.current=N.urls[0],x())},P=async()=>{try{const n=await we(r);alert(n),y("/auth")}catch(n){alert(n)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:s==null?void 0:s.avatar,alt:"Profile",id:"profile_img",className:"cover"}),a?e.jsx(G,{accept:"image/*",onChange:w,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:s==null?void 0:s.fullname}),(s==null?void 0:s.bio)&&e.jsx("p",{children:s==null?void 0:s.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{o(!1),i(n=>!n)},children:a?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{i(!1),o(n=>!n)},children:f?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t&&t.length&&t.length>0?e.jsx("span",{id:"nofcount",children:t.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:p,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${f?"active":""}`,children:t&&t.length>0?t.map(n=>e.jsxs("div",{className:"flex invitation",children:[e.jsx("img",{className:"profile-picture",alt:"Avatar",src:n.invitor.avatar}),e.jsxs("p",{children:[n.invitor.fullname," invited you to a new conversation!"]}),e.jsx("button",{className:"btn_inv green",onClick:()=>_(n._id),children:"Accept"}),e.jsx("button",{className:"btn_inv",onClick:()=>E(n._id),children:"Refuse"})]},n._id)):e.jsx("p",{children:"No invitation"})}),e.jsxs("div",{className:`profile_dropdown ${a?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:m,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:s==null?void 0:s.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:s==null?void 0:s.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:P,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:x,children:"Save"})]})]})]})},Ee=h.memo(Ce);const Ne=({token:r})=>{const[s,u]=h.useState([]),[f,o]=h.useState([]),a=h.useRef(null),i=l=>{if(s.some(p=>p._id==l._id))return alert("already selected this user");u(p=>[...p,l])},t=l=>{console.log("remove user from users list"),l>=0&&l<s.length&&u(p=>p.filter((E,x)=>x!==l))},d=async()=>{if(s.length==0)return alert("Please select a user");const l=s.map(p=>p._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({invited:l})})).ok?u([]):alert("deo biet sao bug luon")}catch(p){console.error(p)}},v=()=>{var p;const l=(p=a.current)==null?void 0:p.value;l&&fetch(`/api/v1/search/${l}`,{headers:{"content-type":"application/json",authorization:"Bearer "+r}}).then(_=>{if(_.ok)return _.json().then(E=>{o(E)});console.log(_.status)})},m=l=>{l.key==="Enter"&&v()},y=l=>{a.current&&!a.current.contains(l.target)&&(o([]),a.current.value="")};return h.useEffect(()=>(document.addEventListener("click",y),()=>{document.removeEventListener("click",y)}),[]),e.jsxs("div",{id:"room-maker",className:`${f.length>0?"focus":""}`,children:[e.jsx("div",{id:"search-bar-wrapper",className:"flex",children:e.jsxs("div",{id:"search-bar",children:[e.jsxs("div",{id:"chosenList",className:"flex",children:[s.map((l,p)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",l.fullname]}),e.jsx("span",{onClick:()=>t(p),children:e.jsx("i",{className:"bx bx-x-circle"})})]},l.fullname)),s.length>0&&e.jsx("div",{className:"flex",children:e.jsx("button",{className:"btn",onClick:d,children:e.jsx("i",{className:"bx bxs-message-square-add ",id:"btn_createroom"})})})]}),e.jsx("input",{type:"text",placeholder:"Search for users...",ref:a,onKeyPress:m})]})}),f.length>0&&e.jsx("div",{id:"search_dropdown",children:f.map(l=>e.jsxs("div",{className:"search_dropdown_opts",onClick:()=>{i({_id:l._id,fullname:l.fullname})},children:[e.jsx("img",{className:"profile-picture",src:l.avatar,alt:"Avatar"}),e.jsx("h3",{children:l.fullname})]},l._id))})]})},X=r=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+r}}).then(s=>{if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Se=({token:r})=>{const[s,u]=h.useState(null),[f,o]=h.useState([]),[a,i]=h.useState(0);console.log("render main");const t=D(),d=async()=>{try{console.log("Loading profile again...");const y=await X(r);u(y)}catch{t("/auth")}},v=h.useCallback(y=>{i(y)},[]),m=h.useCallback(y=>{o(y)},[]);return h.useEffect(()=>{r&&X(r).then(y=>{u(y)}).catch(y=>{console.error(y),t("/auth")})},[r]),e.jsx("div",{id:"main-page",className:"flex",children:s?e.jsx(e.Fragment,{children:e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ee,{token:r,profileData:s,onRefresh:d}),e.jsx(Ne,{token:r}),e.jsx(le,{userId:s._id,currentRoomIndex:a,token:r,onRoomChange:v,onUpdateStatus:m})]}),e.jsx("section",{id:"section-right",children:e.jsx(_e,{profile:s,token:r,room:f[a]})})]})}):e.jsx("div",{children:"Loading skeleton ..."})})},Pe=h.memo(Se);export{Pe as default,X as getProfile};
