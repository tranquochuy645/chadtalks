import{r as s,j as i,a as T,u as j}from"./index-1dfc1f07.js";import{g as v}from"./getSocket-3ac81373.js";const x={iceServers:[{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10},C=({peerId:f,offer:m,answer:u,ice:o,localStream:d,onSendToPeer:g})=>{const r=s.useRef(null),h=s.useRef(null),w=s.useRef(null),l=s.useRef(null),R=async c=>{if(r.current=new RTCPeerConnection(x),r.current.onconnectionstatechange=()=>{var e;switch((e=r.current)==null?void 0:e.connectionState){case"connected":console.log("connected");break;case"disconnected":console.log("disconnected");break;case"failed":console.log("failed");break;case"closed":console.log("closed");break;default:console.log("connecting")}},h.current=new MediaStream,w.current)w.current.srcObject=h.current;else throw new Error("41");d==null||d.getTracks().forEach(e=>{var n;(n=r.current)==null||n.addTrack(e,d)}),r.current.ontrack=e=>{e.streams[0].getTracks().forEach(n=>{var t;(t=h.current)==null||t.addTrack(n)})},r.current.onicecandidate=async e=>{e.candidate&&g("ice_candidate",[c,e.candidate])}},k=async c=>{var e,n;await R(c),l.current=await((e=r.current)==null?void 0:e.createOffer()),await((n=r.current)==null?void 0:n.setLocalDescription(l.current)),g("offer",[c,l.current])},y=async(c,e)=>{var n,t,a;await R(c),await((n=r.current)==null?void 0:n.setRemoteDescription(e)),l.current=await((t=r.current)==null?void 0:t.createAnswer()),await((a=r.current)==null?void 0:a.setLocalDescription(l.current)),g("answer",[c,l.current])},P=async c=>{var e;await((e=r.current)==null?void 0:e.setRemoteDescription(c))},p=async c=>{var e;(e=r.current)==null||e.addIceCandidate(c)};return s.useEffect(()=>{m?y(f,m):k(f)},[]),s.useEffect(()=>{u&&P(u)},[u]),s.useEffect(()=>{o&&(console.log(o),p(o))},[o]),i.jsxs("div",{children:[i.jsxs("p",{children:["Peer ID: ",f]}),i.jsx("video",{className:"remote-video",ref:w,autoPlay:!0,playsInline:!0})]})};const D=()=>{const{meetId:f}=T(),m=j(),u=s.useRef(null),o=s.useRef(null),d=s.useRef(null),[g,r]=s.useState([]),h=async()=>{if(o.current=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),d.current)d.current.srcObject=o.current;else throw new Error("Can not get user media")},w=()=>{o.current&&o.current.getVideoTracks().forEach(n=>{n.enabled=!n.enabled})},l=()=>{o.current&&o.current.getAudioTracks().forEach(n=>{n.enabled=!n.enabled})},R=e=>{r(n=>n.filter(a=>a.id!==e))},k=e=>{r(n=>{const t={id:e};return[...n,t]})},y=async e=>{r(n=>{const t={id:e[0],offer:e[1]};return[...n,t]})},P=async e=>{r(n=>n.map(t=>t.id===e[0]?{...t,answer:e[1]}:t))},p=async e=>{r(n=>n.map(t=>t.id===e[0]?{...t,ice:e[1]}:t))};s.useEffect(()=>{const e=new URLSearchParams(window.location.search),n=e.get("room"),t=e.get("token");return!t||!n||!f?m("/auth"):(console.log("render"),h().then(()=>{const a=v(t,n,f);a.on("new_peer",k),a.on("off_peer",R),a.on("offer",y),a.on("answer",P),a.on("ice_candidate",p),u.current=a}),()=>{u.current&&u.current.disconnect()})},[]);const c=(e,n)=>{var t;(t=u.current)==null||t.emit(e,n)};return i.jsxs("div",{children:[i.jsx("h1",{children:"Meeting Page"}),i.jsxs("p",{children:["Meet UUID: ",f]}),i.jsx("video",{id:"local-video",ref:d,autoPlay:!0,playsInline:!0,muted:!0}),i.jsx("button",{onClick:w,children:"Toggle camera"}),i.jsx("button",{onClick:l,children:"Toggle sound"}),g.map(e=>i.jsx(C,{peerId:e.id,localStream:o.current,offer:e.offer,answer:e.answer,ice:e.ice,onSendToPeer:c},e.id))]})};export{D as default};
