import{r as o,j as t,b as E,u as _}from"./index-721afd6b.js";import{g as I}from"./getSocket-3ac81373.js";const D={iceServers:[{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10},L=({peerId:f,offer:k,answer:g,ice:m,localStream:u,onSendToPeer:l})=>{console.log("render remote video screen");const s=o.useRef(null),x=o.useRef(null),d=o.useRef(null),h=o.useRef(null),[R,y]=o.useState(!1),w=async a=>{if(s.current=new RTCPeerConnection(D),s.current.onconnectionstatechange=()=>{var n;switch((n=s.current)==null?void 0:n.connectionState){case"connected":console.log("connected");break;case"disconnected":console.log("disconnected");break;case"failed":console.log("failed");break;case"closed":console.log("closed");break;default:console.log("connecting")}},x.current=new MediaStream,d.current)d.current.srcObject=x.current;else throw new Error("41");u==null||u.getTracks().forEach(n=>{var i;(i=s.current)==null||i.addTrack(n,u)}),s.current.ontrack=n=>{n.streams[0].getTracks().forEach(i=>{var p;(p=x.current)==null||p.addTrack(i)})},s.current.onicecandidate=async n=>{n.candidate&&l("ice_candidate",[a,n.candidate])}},S=async a=>{var n,i;await w(a),h.current=await((n=s.current)==null?void 0:n.createOffer()),await((i=s.current)==null?void 0:i.setLocalDescription(h.current)),l("offer",[a,h.current])},v=async(a,n)=>{var i,p,j;await w(a),await((i=s.current)==null?void 0:i.setRemoteDescription(n)),h.current=await((p=s.current)==null?void 0:p.createAnswer()),await((j=s.current)==null?void 0:j.setLocalDescription(h.current)),l("answer",[a,h.current])},C=async a=>{var n;await((n=s.current)==null?void 0:n.setRemoteDescription(a))},P=async a=>{var n;(n=s.current)==null||n.addIceCandidate(a)};o.useEffect(()=>{k?v(f,k):S(f)},[]),o.useEffect(()=>{g&&C(g)},[g]),o.useEffect(()=>{m&&(console.log(m),P(m))},[m]);const b=()=>{d.current&&(d.current.muted=!d.current.muted,y(d.current.muted))};return t.jsxs(t.Fragment,{children:[t.jsxs("p",{children:["Peer ID: ",f]}),t.jsx("div",{className:"flex meeting-page_ctrl",children:t.jsx("button",{onClick:b,children:R?"Unmute":"Mute"})}),t.jsx("video",{className:"remote-video",ref:d,autoPlay:!0,playsInline:!0})]})},M=o.memo(L);const A=()=>{const{meetId:f}=E();let k=sessionStorage.getItem("token"),g=sessionStorage.getItem("room");const m=_(),u=o.useRef(null),l=o.useRef(null),s=o.useRef(null),[x,d]=o.useState(!0),[h,R]=o.useState(!1),[y,w]=o.useState([]),S=async()=>{if(l.current=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),s.current)s.current.srcObject=l.current;else throw new Error("Can not get user media")},v=()=>{if(R(!1),console.log("run this"),!k||!g||!f)return alert("Session error, please login again !"),m("/auth");const e=I(k,g,f);e.on("new_peer",a),e.on("off_peer",b),e.on("offer",n),e.on("answer",i),e.on("ice_candidate",p),u.current=e},C=()=>{l.current&&l.current.getVideoTracks().forEach(r=>{r.enabled=!r.enabled})},P=()=>{l.current&&l.current.getAudioTracks().forEach(r=>{r.enabled=!r.enabled})},b=e=>{w(r=>r.filter(T=>T.id!==e))},a=e=>{w(r=>{const c={id:e};return[...r,c]})},n=async e=>{w(r=>{const c={id:e[0],offer:e[1]};return[...r,c]})},i=async e=>{w(r=>r.map(c=>c.id===e[0]?{...c,answer:e[1]}:c))},p=async e=>{w(r=>r.map(c=>c.id===e[0]?{...c,ice:e[1]}:c))},j=(e,r)=>{var c;(c=u.current)==null||c.emit(e,r)};return o.useEffect(()=>{if(!f)return m("/auth");if(!k||!g){const e=new URLSearchParams(window.location.search),r=e.get("token"),c=e.get("room");if(!r||!c)return m("/auth");e.delete("token"),e.delete("room");const T=`${window.location.pathname}?${e.toString()}`;window.history.replaceState({},"",T),k=r,g=c,sessionStorage.setItem("token",r),sessionStorage.setItem("room",c)}console.log("render")},[]),o.useEffect(()=>(x||S().then(()=>{R(!0)}).catch(()=>{d(!0)}),()=>{u.current&&u.current.disconnect()}),[x]),t.jsx("div",{id:"meeting-page",children:x?t.jsxs(t.Fragment,{children:[t.jsx("h1",{children:"Meeting Page"}),t.jsxs("p",{children:["Meet UUID: ",f]}),t.jsx("p",{children:" You need to allow access to camera and mic"}),t.jsx("button",{onClick:()=>d(!1),children:"Allow"})]}):t.jsxs(t.Fragment,{children:[t.jsxs("section",{id:"meeting-page_section_local",className:`${y.length>0?" aside":""}`,children:[t.jsxs("div",{className:"flex meeting-page_ctrl",children:[t.jsx("button",{onClick:C,children:"Toggle camera"}),t.jsx("button",{onClick:P,children:"Toggle sound"}),h&&t.jsx("button",{onClick:v,children:"Ready !"})]}),t.jsx("video",{id:"local-video",ref:s,autoPlay:!0,playsInline:!0,muted:!0})]}),y.length>0&&t.jsx("section",{id:"meeting-page_section_remote",className:`${y.length>1?"stacked":""}`,children:y.map(e=>t.jsx("div",{className:`remote-peer-container ${e.id}`,children:t.jsx(M,{peerId:e.id,localStream:l.current,offer:e.offer,answer:e.answer,ice:e.ice,onSendToPeer:j},e.id)}))})]})})};export{A as default};
