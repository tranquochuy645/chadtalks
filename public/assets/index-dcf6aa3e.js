import{r as h,j as e,u as W,a as te,c as ne,g as se,P as re}from"./index-6c21aa15.js";import{useSocket as B}from"./index-ed050263.js";const ie=({participants:s,userId:t})=>{if(s=s.filter(i=>i._id!==t),s.length===0)return e.jsx("div",{className:"card",children:e.jsx("h3",{children:"No other participants in this room."})});const l=s.length>1,f=s.slice(0,4);return e.jsx("div",{className:"card",children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:f.map((i,a)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:i.avatar,alt:"Profile",className:"group-profile-picture"})},a))}),e.jsxs("div",{className:"profile-names",children:[f.length>0&&e.jsx("h3",{children:f.map(i=>i.fullname).join(", ")}),s.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",s.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[s[0].fullname+"  ",e.jsx("span",{className:s[0].isOnline?"online":"offline",children:"â€¢"})]}),s[0].bio&&e.jsx("p",{children:s[0].bio})]})})},X=h.memo(ie),oe=({roomId:s,handleAction:t})=>e.jsxs(e.Fragment,{children:[e.jsx("input",{className:"checkbox",type:"checkbox",id:`${s}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${s}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{onClick:()=>t("leave",s),children:"Leave"}),e.jsx("button",{onClick:()=>t("delete",s),children:"Delete"})]})]});const H=s=>new Promise((t,l)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(f=>{if(f.ok)return f.json().then(i=>{t(i)});if(f.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(f=>{l(f)})}),ae=({userId:s,currentRoomIndex:t,token:l,onRoomChange:f,onUpdateStatus:i})=>{const[a,r]=h.useState([]),n=B(),c=W(),v=d=>{const g=d;r(b=>b&&b.map(N=>{const M=N.participants.map(S=>S._id===g?{...S,isOnline:!0}:S);return{...N,participants:M}}))},m=d=>{const g=d;r(b=>b&&b.map(N=>{const M=N.participants.map(S=>S._id===g?{...S,isOnline:!1}:S);return{...N,participants:M}}))},y=d=>{r(g=>g&&g.map(b=>b._id===d[1]?{...b,isMeeting:!0,meeting_uuid:d[2]}:b))},o=d=>{r(g=>g&&g.map(b=>b._id===d[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},x=()=>{H(l).then(d=>{r(d)}).catch(()=>{c("/auth")})},E=d=>{var b,N;const g=document.querySelectorAll(".chat-room");g==null||g.forEach(M=>{var S;(S=M.classList)==null||S.remove("active")}),(N=(b=g[d])==null?void 0:b.classList)==null||N.add("active"),f(d)},C=d=>{r(g=>g&&g.map(b=>b._id===d[1]?{...b,latestMessage:{sender:d[0],content:d[2],timestamp:d[3],urls:d[4]}}:b))},_=d=>{d[1]===s&&r(g=>g.map(b=>b._id===d[0]?{...b,lastReadTimeStamp:d[2]}:b))};h.useEffect(()=>{a.length>0&&i(a)},[a]),h.useEffect(()=>{if(n)return n.on("onl",v),n.on("off",m),n.on("meet",y),n.on("end_meet",o),n.on("room",x),n.on("msg",C),n.on("seen",_),()=>{n.off("onl",v),n.off("off",m),n.off("meet",y),n.off("end_meet",o),n.off("room",x),n.off("msg",C),n.off("seen",_)}},[n]),h.useEffect(()=>{H(l).then(d=>{r(d)}).catch(()=>{c("/auth")})},[]);const p=async(d,g)=>{switch(d){case"leave":return fetch(`/api/v1/rooms/${g}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+l},body:JSON.stringify({action:d})});case"delete":return fetch(`/api/v1/rooms/${g}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+l}})}},L=h.useMemo(()=>a.map((d,g)=>{var V,U;const b=d==null?void 0:d.lastReadTimeStamp,N=(V=d==null?void 0:d.latestMessage)==null?void 0:V.content,M=(U=d==null?void 0:d.latestMessage)==null?void 0:U.timestamp,S=M&&b&&new Date(M)>new Date(b)&&g!==t;return e.jsxs("div",{className:`chat-room ${g==t?"active":""}`,children:[e.jsxs("div",{onClick:()=>E(g),children:[e.jsx(X,{userId:s,participants:d.participants}),e.jsx("p",{children:N}),e.jsx("p",{children:S?"Unread":"All Read"})]}),e.jsx(oe,{handleAction:p,roomId:d._id})]},d._id)}),[a]);return e.jsx("div",{id:"rooms-nav",children:a&&a.length>0?e.jsx("div",{children:L}):e.jsx("p",{children:"No rooms to display"})})};const D=({onChange:s,accept:t,id:l,icon:f})=>{const i=h.useRef(null),a=r=>{if(r.target.files){const n=r.target.files[0];s(n)}};return e.jsxs("label",{id:`btn_${l}`,className:"btn_fileinput",htmlFor:l,children:[f,e.jsx("input",{id:l,className:"fileinput",type:"file",accept:t,ref:i,onChange:a,style:{display:"none"}})]})};const le=({token:s,userId:t,roomId:l,onJustSent:f})=>{const[i,a]=h.useState(""),[r,n]=h.useState([]),[c,v]=h.useState([]),m=B(),y=async _=>{try{const p=new FormData;return _.forEach(g=>{p.append(`file${_.length>1?"s":""}`,g)}),await(await fetch(`/media/${t}/${l}?token=${s}&count=${_.length}`,{method:"POST",body:p})).json()}catch(p){throw p}},o=_=>{a(_.target.value),console.log("typing ...")},x=async()=>{let _=[],p=[];if(r.length>0&&(console.log(r.length),_=r,n([])),c.length>0&&(console.log(c.length),_=[..._,...c],v([])),_.length>0)try{const L=await y(_);L.urls&&(p=L.urls)}catch(L){return alert("error uploading files: "+L.message)}(i.trim()!==""||p.length!==0)&&(console.log(p),m==null||m.emit("msg",[l,i,new Date,p]),f(),a(""))},E=_=>{v(p=>[...p,_])},C=_=>{n(p=>[...p,_])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(D,{accept:"image/*",onChange:E,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(D,{accept:"*",onChange:C,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),c.length>0&&e.jsx("div",{children:c.map((_,p)=>e.jsx("span",{children:_.name},p))}),r.length>0&&e.jsx("div",{children:r.map((_,p)=>e.jsx("span",{children:_.name},p))}),e.jsx("input",{type:"text",value:i,id:"input_message",onChange:o,onKeyDown:_=>{_.key=="Enter"&&x()}}),e.jsx("button",{onClick:x,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},ce=h.memo(le);const ue={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},de=()=>{const[s,t]=h.useState(sessionStorage.getItem("theme")||"light");return h.useEffect(()=>{const l=ue[s];Object.entries(l).forEach(([f,i])=>{document.documentElement.style.setProperty(`--${f}-color`,i)}),sessionStorage.setItem("theme",s)},[s]),[s,t]},fe=()=>{const[s,t]=de(),l=s==="light",f=()=>{t(l?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:l,onChange:f}),e.jsxs("label",{className:`switcher-label ${l?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const K=(s,t,l)=>{const f=`/meet/${t}?token=${s}&room=${l}`;window.open(f)},he=({token:s,room:t,userId:l})=>{const f=B(),i=()=>{f==null||f.emit("meet",[t._id,new Date])},a=r=>{if(console.log(r),r[0]==l)return r[3]?void 0:K(s,r[2],r[1]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{K(s,r[2],r[1])}):Notification.permission!=="denied"&&Notification.requestPermission().then(n=>{n==="granted"&&a(r)})};return h.useEffect(()=>{if(t&&f)return f.on("meet",a),()=>{f.off("meet",a)}},[f,t]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[t&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:l,participants:t.participants}),t.isMeeting&&t.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>K(s,t.meeting_uuid,t._id),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:i,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(fe,{})]})},pe=h.memo(he);var Z={exports:{}};(function(s,t){(function(f,i){s.exports=i(h,te)})(ne,function(l,f){return function(i){var a={};function r(n){if(a[n])return a[n].exports;var c=a[n]={i:n,l:!1,exports:{}};return i[n].call(c.exports,c,c.exports,r),c.l=!0,c.exports}return r.m=i,r.c=a,r.d=function(n,c,v){r.o(n,c)||Object.defineProperty(n,c,{enumerable:!0,get:v})},r.r=function(n){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},r.t=function(n,c){if(c&1&&(n=r(n)),c&8||c&4&&typeof n=="object"&&n&&n.__esModule)return n;var v=Object.create(null);if(r.r(v),Object.defineProperty(v,"default",{enumerable:!0,value:n}),c&2&&typeof n!="string")for(var m in n)r.d(v,m,(function(y){return n[y]}).bind(null,m));return v},r.n=function(n){var c=n&&n.__esModule?function(){return n.default}:function(){return n};return r.d(c,"a",c),c},r.o=function(n,c){return Object.prototype.hasOwnProperty.call(n,c)},r.p="",r(r.s=4)}([function(i,a,r){i.exports=r(5)()},function(i,a){i.exports=l},function(i,a){i.exports=f},function(i,a){i.exports=function(r,n,c){var v=r.direction,m=r.value;switch(v){case"top":return c.top+m<n.top&&c.bottom>n.bottom&&c.left<n.left&&c.right>n.right;case"left":return c.left+m<n.left&&c.bottom>n.bottom&&c.top<n.top&&c.right>n.right;case"bottom":return c.bottom-m>n.bottom&&c.left<n.left&&c.right>n.right&&c.top<n.top;case"right":return c.right-m>n.right&&c.left<n.left&&c.top<n.top&&c.bottom>n.bottom}}},function(i,a,r){r.r(a),r.d(a,"default",function(){return U});var n=r(1),c=r.n(n),v=r(2),m=r.n(v),y=r(0),o=r.n(y),x=r(3),E=r.n(x);function C(j){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?C=function(T){return typeof T}:C=function(T){return T&&typeof Symbol=="function"&&T.constructor===Symbol&&T!==Symbol.prototype?"symbol":typeof T},C(j)}function _(j,w){if(!(j instanceof w))throw new TypeError("Cannot call a class as a function")}function p(j,w){for(var T=0;T<w.length;T++){var u=w[T];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(j,u.key,u)}}function L(j,w,T){return w&&p(j.prototype,w),T&&p(j,T),j}function d(j,w){return w&&(C(w)==="object"||typeof w=="function")?w:b(j)}function g(j){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},g(j)}function b(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}function N(j,w){if(typeof w!="function"&&w!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(w&&w.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),w&&M(j,w)}function M(j,w){return M=Object.setPrototypeOf||function(u,R){return u.__proto__=R,u},M(j,w)}function S(j,w,T){return w in j?Object.defineProperty(j,w,{value:T,enumerable:!0,configurable:!0,writable:!0}):j[w]=T,j}function V(j){return j.width===void 0&&(j.width=j.right-j.left),j.height===void 0&&(j.height=j.bottom-j.top),j}var U=function(j){N(w,j);function w(T){var u;return _(this,w),u=d(this,g(w).call(this,T)),S(b(u),"getContainer",function(){return u.props.containment||window}),S(b(u),"addEventListener",function(R,O,P,z){u.debounceCheck||(u.debounceCheck={});var k,F,I=function(){k=null,u.check()};z>-1?F=function(){k||(k=setTimeout(I,z||0))}:F=function(){clearTimeout(k),k=setTimeout(I,P||0)};var A={target:R,fn:F,getLastTimeout:function(){return k}};R.addEventListener(O,A.fn),u.debounceCheck[O]=A}),S(b(u),"startWatching",function(){u.debounceCheck||u.interval||(u.props.intervalCheck&&(u.interval=setInterval(u.check,u.props.intervalDelay)),u.props.scrollCheck&&u.addEventListener(u.getContainer(),"scroll",u.props.scrollDelay,u.props.scrollThrottle),u.props.resizeCheck&&u.addEventListener(window,"resize",u.props.resizeDelay,u.props.resizeThrottle),!u.props.delayedCall&&u.check())}),S(b(u),"stopWatching",function(){if(u.debounceCheck){for(var R in u.debounceCheck)if(u.debounceCheck.hasOwnProperty(R)){var O=u.debounceCheck[R];clearTimeout(O.getLastTimeout()),O.target.removeEventListener(R,O.fn),u.debounceCheck[R]=null}}u.debounceCheck=null,u.interval&&(u.interval=clearInterval(u.interval))}),S(b(u),"check",function(){var R=u.node,O,P;if(!R)return u.state;if(O=V(u.roundRectDown(R.getBoundingClientRect())),u.props.containment){var z=u.props.containment.getBoundingClientRect();P={top:z.top,left:z.left,bottom:z.bottom,right:z.right}}else P={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var k=u.props.offset||{},F=C(k)==="object";F&&(P.top+=k.top||0,P.left+=k.left||0,P.bottom-=k.bottom||0,P.right-=k.right||0);var I={top:O.top>=P.top,left:O.left>=P.left,bottom:O.bottom<=P.bottom,right:O.right<=P.right},A=O.height>0&&O.width>0,$=A&&I.top&&I.left&&I.bottom&&I.right;if(A&&u.props.partialVisibility){var G=O.top<=P.bottom&&O.bottom>=P.top&&O.left<=P.right&&O.right>=P.left;typeof u.props.partialVisibility=="string"&&(G=I[u.props.partialVisibility]),$=u.props.minTopValue?G&&O.top<=P.bottom-u.props.minTopValue:G}typeof k.direction=="string"&&typeof k.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",k.direction,k.value),$=E()(k,O,P));var J=u.state;return u.state.isVisible!==$&&(J={isVisible:$,visibilityRect:I},u.setState(J),u.props.onChange&&u.props.onChange($)),J}),u.state={isVisible:null,visibilityRect:{}},u}return L(w,[{key:"componentDidMount",value:function(){this.node=m.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(u){this.node=m.a.findDOMNode(this),this.props.active&&!u.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(u){return{top:Math.floor(u.top),left:Math.floor(u.left),bottom:Math.floor(u.bottom),right:Math.floor(u.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):c.a.Children.only(this.props.children)}}]),w}(c.a.Component);S(U,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:c.a.createElement("span",null)}),S(U,"propTypes",{onChange:o.a.func,active:o.a.bool,partialVisibility:o.a.oneOfType([o.a.bool,o.a.oneOf(["top","right","bottom","left"])]),delayedCall:o.a.bool,offset:o.a.oneOfType([o.a.shape({top:o.a.number,left:o.a.number,bottom:o.a.number,right:o.a.number}),o.a.shape({direction:o.a.oneOf(["top","right","bottom","left"]),value:o.a.number})]),scrollCheck:o.a.bool,scrollDelay:o.a.number,scrollThrottle:o.a.number,resizeCheck:o.a.bool,resizeDelay:o.a.number,resizeThrottle:o.a.number,intervalCheck:o.a.bool,intervalDelay:o.a.number,containment:typeof window<"u"?o.a.instanceOf(window.Element):o.a.any,children:o.a.oneOfType([o.a.element,o.a.func]),minTopValue:o.a.number})},function(i,a,r){var n=r(6);function c(){}function v(){}v.resetWarningCache=c,i.exports=function(){function m(x,E,C,_,p,L){if(L!==n){var d=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw d.name="Invariant Violation",d}}m.isRequired=m;function y(){return m}var o={array:m,bool:m,func:m,number:m,object:m,string:m,symbol:m,any:m,arrayOf:y,element:m,elementType:m,instanceOf:y,node:m,objectOf:y,oneOf:y,oneOfType:y,shape:y,exact:y,checkPropTypes:v,resetWarningCache:c};return o.PropTypes=o,o}},function(i,a,r){var n="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";i.exports=n}])})})(Z);var me=Z.exports;const ge=se(me);const xe=({src:s,alt:t})=>{const[l,f]=h.useState(!1);return h.useEffect(()=>{const i=new IntersectionObserver(r=>{r.forEach(n=>{n.isIntersecting&&(f(!0),i.unobserve(n.target))})}),a=document.getElementById(`lazyload-element-${s}`);return a&&i.observe(a),()=>{a&&i.unobserve(a)}},[s]),e.jsx("video",{id:`lazyload-element-${s}`,controls:!0,autoPlay:!1,playsInline:!0,src:l?s:"",children:t})},be=({src:s,alt:t})=>{const[l,f]=h.useState(!1);return h.useEffect(()=>{const i=new IntersectionObserver(r=>{r.forEach(n=>{n.isIntersecting&&(f(!0),i.unobserve(n.target))})}),a=document.getElementById(`lazyload-element-${s}`);return a&&i.observe(a),()=>{a&&i.unobserve(a)}},[s]),e.jsx("img",{id:`lazyload-element-${s}`,src:l?s:"",loading:"lazy",alt:t})},ee=({url:s,token:t})=>{var n;const[l,f]=h.useState(!1),[i,a]=h.useState(!1),r=((n=s.split("/").pop())==null?void 0:n.substring(23))||"File";return h.useEffect(()=>{var v;const c=(v=s.split(".").pop())==null?void 0:v.toLowerCase();f(["jpg","jpeg","png","gif","bmp","svg"].includes(c||"")),a(["mp4","webm","ogg"].includes(c||""))},[s]),l?e.jsx(be,{src:s+"?token="+t,alt:r}):i?e.jsx(xe,{src:s+"?token="+t,alt:r}):e.jsx("a",{href:s+"?token="+t,target:"_blank",rel:"noopener noreferrer",children:r})},ve=({token:s,content:t,timestamp:l,urls:f,seenList:i})=>e.jsxs("div",{className:"message out",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:t})}),e.jsx("p",{className:"message_timestamp",children:l}),f&&f.length>0&&f.map((a,r)=>e.jsx(ee,{token:s,url:a},l+r)),i&&i.length>0&&e.jsxs("p",{children:["Seen by:",i.map((a,r)=>e.jsx("span",{children:a},r))]})]}),ye=({token:s,avatarSRC:t,content:l,timestamp:f,urls:i,seenList:a})=>e.jsxs("div",{className:"message in",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:t,alt:"Sender Avatar"}),e.jsx("p",{children:l}),i&&i.length>0&&i.map((r,n)=>e.jsx(ee,{token:s,url:r},f+n))]}),e.jsx("p",{className:"message_timestamp",children:f}),a&&a.length>0&&e.jsxs("p",{children:["Seen by:",a.map((r,n)=>e.jsx("span",{children:r},n))]})]}),je=(s,t)=>{const l=t[s];return l?l.avatar:""},_e=({readCursors:s,token:t,messages:l,roomId:f,userId:i,participants:a})=>{const[r,n]=h.useState({}),c=h.useRef(l.length),v=B(),m=h.useRef({});m.current=h.useMemo(()=>Object.fromEntries(a.map(o=>[o._id,o])),[a]);const y=o=>{o[0]===f&&n(x=>({...x,[o[1]]:c.current-1}))};return h.useEffect(()=>{c.current=l.length},[l.length]),h.useEffect(()=>{if(v)return v.on("seen",y),()=>{v.off("seen",y)}},[v,f]),h.useEffect(()=>{const o={};s.filter(x=>x._id!==i).forEach(x=>{const E=new Date(x.lastReadTimeStamp).getTime();for(let C=l.length-1;C>=0;C--)if(new Date(l[C].timestamp).getTime()<=E){o[x._id]=C;break}}),n(o)},[s]),e.jsx(e.Fragment,{children:l.map((o,x)=>{let E=[];return a.forEach(C=>{r[C._id]==x&&E.push(C.fullname)}),o.sender&&o.sender===i?e.jsx(ve,{token:t,content:o.content,timestamp:o.timestamp,urls:o.urls,seenList:E},x):e.jsx(ye,{token:t,avatarSRC:je(o.sender,m.current),content:o.content,timestamp:o.timestamp,urls:o.urls,seenList:E},x)})})},we=h.memo(_e);const Y=(s,t,l,f)=>fetch(`/api/v1/rooms/${s}?limit=${l}&skip=${f}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(i=>{if(i.status===304)throw new Error("Already got this");if(i.ok)return i.json();throw i.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),q=30,Ee=({token:s,room:t,userId:l,justSent:f})=>{const[i,a]=h.useState([]),[r,n]=h.useState(0),[c,v]=h.useState([]),m=h.useRef(null),y=h.useRef(null),o=h.useRef(null),x=h.useRef(null),E=B(),C=W(),_=d=>{if(d[1]===t._id){const g=d[0];if(g!==l&&!t.participants.some(S=>S._id===g))return;o.current&&(o.current.style.display="block");const b=d[2],N=d[3],M=d[4];E==null||E.emit("seen",[t._id,new Date]),n(S=>S++),a(S=>S!==null?[...S,{sender:g,content:b,timestamp:N,urls:M}]:[{sender:g,content:b,timestamp:N,urls:M}])}},p=()=>{y.current&&(y.current.scrollIntoView({behavior:"smooth"}),o.current&&(o.current.style.display="none"))},L=d=>{if(!d||!i||i.length==0)return;if(i.length>=r){m.current&&(m.current.style.display="none");return}let g,b=q;g=r-i.length-b,g<0&&(b+=g,g=0),Y(t._id,s,`${b}`,`${g}`).then(N=>{x.current&&(x.current.scrollTop=300),a(M=>M?N.messages.concat(M):N.messages),N.conversationLength&&n(N.conversationLength),N.readCursors&&v(N.readCursors)}).catch(()=>{C("/auth")})};return h.useEffect(()=>{try{if(!s||!t)return;Y(t._id,s).then(d=>{d.messages&&a(d.messages),d.conversationLength&&n(d.conversationLength),d.readCursors&&v(d.readCursors)}).catch(()=>{C("/auth")})}catch(d){console.error(d)}},[s,t._id]),h.useEffect(()=>{if(E)return E.on("msg",_),()=>{E.off("msg",_)}},[E,t]),h.useEffect(()=>{m.current&&(m.current.style.display="none");const d=setTimeout(()=>{m.current&&x.current&&x.current.scrollHeight>x.current.clientHeight&&(m.current.style.display="flex")},1e3);return()=>{clearTimeout(d)}},[t._id]),h.useEffect(()=>{if(!(!x.current||!i)){if(i.length<=q||Math.abs(x.current.scrollHeight-x.current.scrollTop-x.current.clientHeight)<300)return p();if(i[i.length-1].sender==l&&f)return f=!1,p()}},[i]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:x,id:"messages-container",children:[e.jsx(ge,{onChange:L,children:e.jsx("div",{ref:m,id:"topRef",children:e.jsx(re,{size:50})})}),i&&e.jsx(we,{readCursors:c,token:s,messages:i,roomId:t._id,userId:l,participants:t.participants}),e.jsx("div",{ref:y})]}),e.jsxs("button",{id:"btn_scroll",ref:o,onClick:()=>{p()},children:[Array.isArray(i)&&i.length>1&&i[i.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const Ce=({room:s,token:t,profile:l})=>{const[f,i]=h.useState(!1),a=h.useCallback(()=>{i(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(pe,{token:t,userId:l._id,room:s}),s&&e.jsx(Ee,{justSent:f,room:s,token:t,userId:l._id}),s&&e.jsx(ce,{token:t,userId:l._id,roomId:s._id,onJustSent:a})]})},Se=s=>new Promise(async(t,l)=>{if(!window.confirm("Are you sure you want to delete your account?"))return l("Account deletion canceled");const i=window.prompt("Enter your password:");if(!i)return l("Password input canceled");try{const a={password:i},r=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(a)});if(r.ok)return sessionStorage.removeItem("token"),t("Account deletion successful");const n=await r.json();if(n.message)return l(n.message);l("Wrong password")}catch(a){l(a)}});const Te=({token:s,profileData:t,onRefresh:l})=>{const[f,i]=h.useState(!1),[a,r]=h.useState(!1),n=h.useRef(null),c=h.useRef(null),v=W(),m=B();h.useEffect(()=>{if(m)return m.on("inv",l),()=>{m.off("inv",l)}},[m]);const y=()=>{sessionStorage.removeItem("token"),v("/auth")},o=p=>{fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({action:"join"})})},x=p=>{fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({action:"refuse"})})},E=async()=>{if(!c.current)return;let p={};if(c.current.bio.value&&(p.bio=c.current.bio.value),c.current.fullname.value&&(p.fullname=c.current.fullname.value),c.current.password.value)if(p.password=c.current.password.value,c.current.current_password.value)p.current_password=c.current.current_password.value;else return alert("Please enter current password");if(n.current&&(p.avatar=n.current),!p.bio&&!p.fullname&&!p.password&&!p.avatar)return alert("Empty form");const L=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(p)});if(r(!1),L.ok)return alert("Updated successfully!"),l();const d=await L.json();if(d.message)return alert(d.message);alert("Error updating profile")},C=async p=>{const L=new FormData;L.append("file",p);const d=await fetch(`/media/${t==null?void 0:t._id}/public?token=${s}&count=1`,{method:"POST",body:L}),g=await d.json();!d.ok&&g.message&&alert(g.message),g.urls&&(n.current=g.urls[0],E())},_=async()=>{try{const p=await Se(s);alert(p),v("/auth")}catch(p){alert(p)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:t==null?void 0:t.avatar,alt:"Profile",id:"profile_img",className:"cover"}),a?e.jsx(D,{accept:"image/*",onChange:C,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:t==null?void 0:t.fullname}),(t==null?void 0:t.bio)&&e.jsx("p",{children:t==null?void 0:t.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{i(!1),r(p=>!p)},children:a?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{r(!1),i(p=>!p)},children:f?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t!=null&&t.invitations.length&&(t==null?void 0:t.invitations.length)>0?e.jsx("span",{id:"nofcount",children:t==null?void 0:t.invitations.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:y,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${f?"active":""}`,children:t&&t.invitations.length>0?t.invitations.map(p=>e.jsxs("div",{children:[e.jsx("p",{children:p}),e.jsx("button",{onClick:()=>o(p),children:"Accept"}),e.jsx("button",{onClick:()=>x(p),children:"Refuse"})]},p)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:`profile_dropdown ${a?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:c,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:t==null?void 0:t.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:t==null?void 0:t.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:_,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:E,children:"Save"})]})]})]})},Ne=h.memo(Te);const Oe=({token:s})=>{const[t,l]=h.useState([]),[f,i]=h.useState([]),a=h.useRef(null),r=o=>{if(t.some(x=>x._id==o._id))return alert("already selected this user");l(x=>[...x,o])},n=o=>{console.log("remove user from users list"),o>=0&&o<t.length&&l(x=>x.filter((C,_)=>_!==o))},c=async()=>{if(t.length==0)return alert("Please select a user");const o=t.map(x=>x._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({invited:o})})).ok?l([]):alert("deo biet sao bug luon")}catch(x){console.error(x)}},v=()=>{var x;const o=(x=a.current)==null?void 0:x.value;o&&fetch(`/api/v1/search/${o}`,{headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(E=>{if(E.ok)return E.json().then(C=>{i(C)});console.log(E.status)})},m=o=>{o.key==="Enter"&&v()},y=o=>{a.current&&!a.current.contains(o.target)&&(i([]),a.current.value="")};return h.useEffect(()=>(document.addEventListener("click",y),()=>{document.removeEventListener("click",y)}),[]),e.jsxs("div",{id:"room-maker",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{id:"search-bar",children:[e.jsx("div",{id:"chosenList",className:"flex",children:t.map((o,x)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",o.fullname]}),e.jsx("span",{onClick:()=>n(x),children:e.jsx("i",{className:"bx bx-x-circle"})})]},o.fullname))}),e.jsx("input",{type:"text",placeholder:"Search for users...",ref:a,onKeyPress:m})]}),t.length>0&&e.jsx("div",{className:"flex",children:e.jsx("button",{className:"btn",onClick:c,children:e.jsx("i",{className:"bx bxs-message-square-add ",id:"btn_createroom"})})})]}),f.length>0&&e.jsx("div",{id:"search_dropdown",children:f.map(o=>e.jsxs("div",{onClick:()=>{r({_id:o._id,fullname:o.fullname})},children:[e.jsx("img",{className:"profile-picture",src:o.avatar,alt:"Avatar"}),o.fullname]},o._id))})]})};function Le(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const Q=s=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(t=>{if(t.ok)return t.json();throw t.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Me=({token:s})=>{const[t,l]=h.useState(null),[f,i]=h.useState([]),[a,r]=h.useState(0);console.log("render main");const n=W(),c=async()=>{try{console.log("Loading profile again...");const y=await Q(s);l(y)}catch{n("/auth")}},v=h.useCallback(y=>{r(y)},[]),m=h.useCallback(y=>{i(y)},[]);return h.useEffect(()=>{s&&Q(s).then(y=>{l(y)}).catch(y=>{console.error(y),n("/auth")})},[s]),e.jsx("div",{id:"main-page",className:"flex",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ne,{token:s,profileData:t,onRefresh:c}),e.jsx(Oe,{token:s}),e.jsx(ae,{userId:t._id,currentRoomIndex:a,token:s,onRoomChange:v,onUpdateStatus:m})]}),e.jsx("section",{id:"section-right",children:e.jsx(Ce,{profile:t,token:s,room:f[a]})})]}),e.jsx(Le,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})},Re=h.memo(Me);export{Re as default,Q as getProfile};
