import{r as f,j as e,u as F,a as ee,c as te,g as ne,P as se}from"./index-eadae6f3.js";import{u as B,S as re}from"./index-5e4d571c.js";const ie=({participants:i,userId:n})=>{if(i=i.filter(s=>s._id!==n),i.length===0)return null;const l=i.length>1,d=i.slice(0,4);return e.jsx("div",{className:"card",children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:d.map((s,c)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:s.avatar,alt:"Profile",className:"group-profile-picture"})},c))}),e.jsxs("div",{className:"profile-names",children:[d.length>0&&e.jsx("h3",{children:d.map(s=>s.fullname).join(", ")}),i.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",i.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:i[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[i[0].fullname+"  ",e.jsx("span",{className:i[0].isOnline?"online":"offline",children:"â€¢"})]}),i[0].bio&&e.jsx("p",{children:i[0].bio})]})})},X=f.memo(ie);const K=i=>new Promise((n,l)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+i}}).then(d=>{if(d.ok)return d.json().then(s=>{n(s)});if(d.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(d=>{l(d)})}),oe=({userId:i,currentRoomIndex:n,token:l,onRoomChange:d,onUpdateStatus:s})=>{const[c,o]=f.useState([]),t=B(),r=F(),y=a=>{const p=a;o(b=>b&&b.map(_=>{const T=_.participants.map(S=>S._id===p?{...S,isOnline:!0}:S);return{..._,participants:T}}))},h=a=>{const p=a;o(b=>b&&b.map(_=>{const T=_.participants.map(S=>S._id===p?{...S,isOnline:!1}:S);return{..._,participants:T}}))},g=a=>{console.log("set meet"),o(p=>p&&p.map(b=>b._id===a[1]?{...b,isMeeting:!0,meeting_uuid:a[2]}:b))},m=a=>{console.log("set end meet"),o(p=>p&&p.map(b=>b._id===a[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},k=()=>{K(l).then(a=>{o(a)}).catch(()=>{r("/auth")})},O=a=>{var b,_;const p=document.querySelectorAll(".chat-room");p==null||p.forEach(T=>{var S;(S=T.classList)==null||S.remove("active")}),(_=(b=p[a])==null?void 0:b.classList)==null||_.add("active"),d(a)};f.useEffect(()=>{c.length>0&&s(c)},[c]),f.useEffect(()=>{if(t)return t.on("onl",y),t.on("off",h),t.on("meet",g),t.on("end_meet",m),t.on("room",k),()=>{t.off("onl",y),t.off("off",h),t.off("meet",g),t.off("end_meet",m),t.off("room",k)}},[t]),f.useEffect(()=>{K(l).then(a=>{o(a)}).catch(()=>{r("/auth")})},[]);const C=async(a,p)=>{switch(a){case"leave":return fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+l},body:JSON.stringify({action:a})});case"delete":return fetch(`/api/v1/rooms/${p}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+l}})}},j=f.useMemo(()=>c.map((a,p)=>e.jsxs("div",{className:`chat-room ${p==n?"active":""}`,children:[e.jsx("div",{onClick:()=>O(p),children:e.jsx(X,{userId:i,participants:a.participants})}),e.jsx("input",{className:"checkbox",type:"checkbox",id:`${a._id}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${a._id}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{onClick:()=>C("leave",a._id),children:"Leave"}),e.jsx("button",{onClick:()=>C("delete",a._id),children:"Delete"})]})]},a._id)),[c]);return e.jsx("div",{id:"rooms-list",children:c&&c.length>0?e.jsx("div",{children:j}):e.jsx("p",{children:"No rooms to display"})})};const J=({onChange:i,accept:n,id:l,icon:d})=>{const s=f.useRef(null),c=o=>{if(o.target.files){const t=o.target.files[0];i(t)}};return e.jsxs("label",{id:`btn_${l}`,className:"btn_fileinput",htmlFor:l,children:[d,e.jsx("input",{id:l,className:"fileinput",type:"file",accept:n,ref:s,onChange:c,style:{display:"none"}})]})};const ae=({token:i,userId:n,roomId:l,onJustSent:d})=>{const[s,c]=f.useState(""),[o,t]=f.useState([]),[r,y]=f.useState([]),h=B(),g=async j=>{try{const a=new FormData;return j.forEach(_=>{a.append(`file${j.length>1?"s":""}`,_)}),await(await fetch(`/media/${n}/${l}?token=${i}&count=${j.length}`,{method:"POST",body:a})).json()}catch(a){throw a}},m=j=>{c(j.target.value),console.log("typing ...")},k=async()=>{let j=[],a=[];if(o.length>0&&(console.log(o.length),j=o,t([])),r.length>0&&(console.log(r.length),j=[...j,...r],y([])),j.length>0)try{const p=await g(j);p.urls&&(a=p.urls)}catch(p){return alert("error uploading files: "+p.message)}(s.trim()!==""||a.length!==0)&&(console.log(a),h==null||h.emit("msg",[l,s,new Date,a]),d(),c(""))},O=j=>{y(a=>[...a,j])},C=j=>{t(a=>[...a,j])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(J,{accept:"image/*",onChange:O,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(J,{accept:"*",onChange:C,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),r.length>0&&e.jsx("div",{children:r.map((j,a)=>e.jsx("span",{children:j.name},a))}),o.length>0&&e.jsx("div",{children:o.map((j,a)=>e.jsx("span",{children:j.name},a))}),e.jsx("input",{type:"text",value:s,id:"input_message",onChange:m,onKeyDown:j=>{j.key=="Enter"&&k()}}),e.jsx("button",{onClick:k,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},le=f.memo(ae);const ce={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},ue=()=>{const[i,n]=f.useState(sessionStorage.getItem("theme")||"light");return f.useEffect(()=>{const l=ce[i];Object.entries(l).forEach(([d,s])=>{document.documentElement.style.setProperty(`--${d}-color`,s)}),sessionStorage.setItem("theme",i)},[i]),[i,n]},de=()=>{const[i,n]=ue(),l=i==="light",d=()=>{n(l?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:l,onChange:d}),e.jsxs("label",{className:`switcher-label ${l?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const he=({token:i,room:n,userId:l})=>{const d=B(),s=()=>{d.emit("meet",[n._id,new Date])},c=t=>{const r=`/meet/${t}?token=${i}&room=${n._id}`;window.open(r)},o=t=>{if(console.log(t),t[0]==l)return t[3]?void 0:c(t[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{c(t[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(r=>{r==="granted"&&o(t)})};return n&&f.useEffect(()=>{if(d)return d.on("meet",o),()=>{d.off("meet",o)}},[d,n._id]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[n&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:l,participants:n.participants}),n.isMeeting&&n.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>c(n.meeting_uuid),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:s,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(de,{})]})},fe=f.memo(he);var q={exports:{}};(function(i,n){(function(d,s){i.exports=s(f,ee)})(te,function(l,d){return function(s){var c={};function o(t){if(c[t])return c[t].exports;var r=c[t]={i:t,l:!1,exports:{}};return s[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=s,o.c=c,o.d=function(t,r,y){o.o(t,r)||Object.defineProperty(t,r,{enumerable:!0,get:y})},o.r=function(t){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,r){if(r&1&&(t=o(t)),r&8||r&4&&typeof t=="object"&&t&&t.__esModule)return t;var y=Object.create(null);if(o.r(y),Object.defineProperty(y,"default",{enumerable:!0,value:t}),r&2&&typeof t!="string")for(var h in t)o.d(y,h,(function(g){return t[g]}).bind(null,h));return y},o.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(r,"a",r),r},o.o=function(t,r){return Object.prototype.hasOwnProperty.call(t,r)},o.p="",o(o.s=4)}([function(s,c,o){s.exports=o(5)()},function(s,c){s.exports=l},function(s,c){s.exports=d},function(s,c){s.exports=function(o,t,r){var y=o.direction,h=o.value;switch(y){case"top":return r.top+h<t.top&&r.bottom>t.bottom&&r.left<t.left&&r.right>t.right;case"left":return r.left+h<t.left&&r.bottom>t.bottom&&r.top<t.top&&r.right>t.right;case"bottom":return r.bottom-h>t.bottom&&r.left<t.left&&r.right>t.right&&r.top<t.top;case"right":return r.right-h>t.right&&r.left<t.left&&r.top<t.top&&r.bottom>t.bottom}}},function(s,c,o){o.r(c),o.d(c,"default",function(){return V});var t=o(1),r=o.n(t),y=o(2),h=o.n(y),g=o(0),m=o.n(g),k=o(3),O=o.n(k);function C(x){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?C=function(w){return typeof w}:C=function(w){return w&&typeof Symbol=="function"&&w.constructor===Symbol&&w!==Symbol.prototype?"symbol":typeof w},C(x)}function j(x,v){if(!(x instanceof v))throw new TypeError("Cannot call a class as a function")}function a(x,v){for(var w=0;w<v.length;w++){var u=v[w];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(x,u.key,u)}}function p(x,v,w){return v&&a(x.prototype,v),w&&a(x,w),x}function b(x,v){return v&&(C(v)==="object"||typeof v=="function")?v:T(x)}function _(x){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},_(x)}function T(x){if(x===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return x}function S(x,v){if(typeof v!="function"&&v!==null)throw new TypeError("Super expression must either be null or a function");x.prototype=Object.create(v&&v.prototype,{constructor:{value:x,writable:!0,configurable:!0}}),v&&A(x,v)}function A(x,v){return A=Object.setPrototypeOf||function(u,P){return u.__proto__=P,u},A(x,v)}function $(x,v,w){return v in x?Object.defineProperty(x,v,{value:w,enumerable:!0,configurable:!0,writable:!0}):x[v]=w,x}function Z(x){return x.width===void 0&&(x.width=x.right-x.left),x.height===void 0&&(x.height=x.bottom-x.top),x}var V=function(x){S(v,x);function v(w){var u;return j(this,v),u=b(this,_(v).call(this,w)),$(T(u),"getContainer",function(){return u.props.containment||window}),$(T(u),"addEventListener",function(P,E,L,R){u.debounceCheck||(u.debounceCheck={});var N,z,M=function(){N=null,u.check()};R>-1?z=function(){N||(N=setTimeout(M,R||0))}:z=function(){clearTimeout(N),N=setTimeout(M,L||0)};var U={target:P,fn:z,getLastTimeout:function(){return N}};P.addEventListener(E,U.fn),u.debounceCheck[E]=U}),$(T(u),"startWatching",function(){u.debounceCheck||u.interval||(u.props.intervalCheck&&(u.interval=setInterval(u.check,u.props.intervalDelay)),u.props.scrollCheck&&u.addEventListener(u.getContainer(),"scroll",u.props.scrollDelay,u.props.scrollThrottle),u.props.resizeCheck&&u.addEventListener(window,"resize",u.props.resizeDelay,u.props.resizeThrottle),!u.props.delayedCall&&u.check())}),$(T(u),"stopWatching",function(){if(u.debounceCheck){for(var P in u.debounceCheck)if(u.debounceCheck.hasOwnProperty(P)){var E=u.debounceCheck[P];clearTimeout(E.getLastTimeout()),E.target.removeEventListener(P,E.fn),u.debounceCheck[P]=null}}u.debounceCheck=null,u.interval&&(u.interval=clearInterval(u.interval))}),$(T(u),"check",function(){var P=u.node,E,L;if(!P)return u.state;if(E=Z(u.roundRectDown(P.getBoundingClientRect())),u.props.containment){var R=u.props.containment.getBoundingClientRect();L={top:R.top,left:R.left,bottom:R.bottom,right:R.right}}else L={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var N=u.props.offset||{},z=C(N)==="object";z&&(L.top+=N.top||0,L.left+=N.left||0,L.bottom-=N.bottom||0,L.right-=N.right||0);var M={top:E.top>=L.top,left:E.left>=L.left,bottom:E.bottom<=L.bottom,right:E.right<=L.right},U=E.height>0&&E.width>0,I=U&&M.top&&M.left&&M.bottom&&M.right;if(U&&u.props.partialVisibility){var W=E.top<=L.bottom&&E.bottom>=L.top&&E.left<=L.right&&E.right>=L.left;typeof u.props.partialVisibility=="string"&&(W=M[u.props.partialVisibility]),I=u.props.minTopValue?W&&E.top<=L.bottom-u.props.minTopValue:W}typeof N.direction=="string"&&typeof N.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",N.direction,N.value),I=O()(N,E,L));var G=u.state;return u.state.isVisible!==I&&(G={isVisible:I,visibilityRect:M},u.setState(G),u.props.onChange&&u.props.onChange(I)),G}),u.state={isVisible:null,visibilityRect:{}},u}return p(v,[{key:"componentDidMount",value:function(){this.node=h.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(u){this.node=h.a.findDOMNode(this),this.props.active&&!u.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(u){return{top:Math.floor(u.top),left:Math.floor(u.left),bottom:Math.floor(u.bottom),right:Math.floor(u.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):r.a.Children.only(this.props.children)}}]),v}(r.a.Component);$(V,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:r.a.createElement("span",null)}),$(V,"propTypes",{onChange:m.a.func,active:m.a.bool,partialVisibility:m.a.oneOfType([m.a.bool,m.a.oneOf(["top","right","bottom","left"])]),delayedCall:m.a.bool,offset:m.a.oneOfType([m.a.shape({top:m.a.number,left:m.a.number,bottom:m.a.number,right:m.a.number}),m.a.shape({direction:m.a.oneOf(["top","right","bottom","left"]),value:m.a.number})]),scrollCheck:m.a.bool,scrollDelay:m.a.number,scrollThrottle:m.a.number,resizeCheck:m.a.bool,resizeDelay:m.a.number,resizeThrottle:m.a.number,intervalCheck:m.a.bool,intervalDelay:m.a.number,containment:typeof window<"u"?m.a.instanceOf(window.Element):m.a.any,children:m.a.oneOfType([m.a.element,m.a.func]),minTopValue:m.a.number})},function(s,c,o){var t=o(6);function r(){}function y(){}y.resetWarningCache=r,s.exports=function(){function h(k,O,C,j,a,p){if(p!==t){var b=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw b.name="Invariant Violation",b}}h.isRequired=h;function g(){return h}var m={array:h,bool:h,func:h,number:h,object:h,string:h,symbol:h,any:h,arrayOf:g,element:h,elementType:h,instanceOf:g,node:h,objectOf:g,oneOf:g,oneOfType:g,shape:g,exact:g,checkPropTypes:y,resetWarningCache:r};return m.PropTypes=m,m}},function(s,c,o){var t="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";s.exports=t}])})})(q);var pe=q.exports;const me=ne(pe);const ge=({src:i,alt:n})=>{const[l,d]=f.useState(!1);return f.useEffect(()=>{const s=new IntersectionObserver(o=>{o.forEach(t=>{t.isIntersecting&&(d(!0),s.unobserve(t.target))})}),c=document.getElementById(`lazyload-element-${i}`);return c&&s.observe(c),()=>{c&&s.unobserve(c)}},[i]),e.jsx("video",{id:`lazyload-element-${i}`,controls:!0,autoPlay:!1,playsInline:!0,src:l?i:"",children:n})},xe=({src:i,alt:n})=>{const[l,d]=f.useState(!1);return f.useEffect(()=>{const s=new IntersectionObserver(o=>{o.forEach(t=>{t.isIntersecting&&(d(!0),s.unobserve(t.target))})}),c=document.getElementById(`lazyload-element-${i}`);return c&&s.observe(c),()=>{c&&s.unobserve(c)}},[i]),e.jsx("img",{id:`lazyload-element-${i}`,src:l?i:"",loading:"lazy",alt:n})},Q=({url:i,token:n})=>{var t;const[l,d]=f.useState(!1),[s,c]=f.useState(!1),o=((t=i.split("/").pop())==null?void 0:t.substring(23))||"File";return f.useEffect(()=>{var y;const r=(y=i.split(".").pop())==null?void 0:y.toLowerCase();d(["jpg","jpeg","png","gif","bmp","svg"].includes(r||"")),c(["mp4","webm","ogg"].includes(r||""))},[i]),l?e.jsx(xe,{src:i+"?token="+n,alt:o}):s?e.jsx(ge,{src:i+"?token="+n,alt:o}):e.jsx("a",{href:i+"?token="+n,target:"_blank",rel:"noopener noreferrer",children:o})},be=({token:i,content:n,timestamp:l,urls:d})=>e.jsxs("div",{className:"message own",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:n})}),e.jsx("p",{className:"message_timestamp",children:l}),d&&d.length>0&&d.map((s,c)=>e.jsx(Q,{token:i,url:s},l+c))]}),ye=({token:i,avatarSRC:n,content:l,timestamp:d,urls:s})=>e.jsxs("div",{className:"message guest",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:n,alt:"Sender Avatar"}),e.jsx("p",{children:l}),s&&s.length>0&&s.map((c,o)=>e.jsx(Q,{token:i,url:c},d+o))]}),e.jsx("p",{className:"message_timestamp",children:d})]}),ve=({token:i,messages:n,userId:l,participants:d})=>e.jsx(e.Fragment,{children:Array.isArray(n)&&n.map((s,c)=>{if(s.sender&&s.sender==l)return e.jsx(be,{token:i,content:s.content,timestamp:s.timestamp,urls:s.urls},c);{const o=d.find(r=>r._id===s.sender),t=o?o.avatar:"";return e.jsx(ye,{token:i,avatarSRC:t,content:s.content,timestamp:s.timestamp,urls:s.urls},c)}})}),je=f.memo(ve);const H=(i,n,l,d)=>fetch(`/api/v1/rooms/${i}?limit=${l}&skip=${d}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+n}}).then(s=>{if(s.status===304)throw new Error("Already got this");if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),D=30,_e=({token:i,room:n,userId:l,justSent:d})=>{const[s,c]=f.useState([]),[o,t]=f.useState(0),r=f.useRef(null),y=f.useRef(null),h=f.useRef(null),g=f.useRef(null),m=B(),k=F();console.log("Render container");const O=a=>{if(a[1]===n._id){const p=a[0];if(p!==l&&!n.participants.some(S=>S._id===p))return;h.current&&(h.current.style.display="block");const b=a[2],_=a[3],T=a[4];t(S=>S++),c(S=>S!==null?[...S,{sender:p,content:b,timestamp:_,urls:T}]:[{sender:p,content:b,timestamp:_,urls:T}])}},C=()=>{y.current&&(y.current.scrollIntoView({behavior:"smooth"}),h.current&&(h.current.style.display="none"))},j=a=>{if(!a||!s||s.length==0)return;if(s.length>=o){r.current&&(r.current.style.display="none");return}let p,b=D;p=o-s.length-b,p<0&&(b+=p,p=0),H(n._id,i,`${b}`,`${p}`).then(_=>{g.current&&(g.current.scrollTop=300),c(T=>T?_.messages.concat(T):_.messages),_.conversationLength&&t(_.conversationLength)}).catch(()=>{k("/auth")})};return f.useEffect(()=>{try{if(!i||!n)return;H(n._id,i).then(a=>{c(a.messages),a.conversationLength&&t(a.conversationLength)}).catch(()=>{k("/auth")})}catch(a){console.error(a)}},[i,n._id]),f.useEffect(()=>{if(m)return m.on("msg",O),()=>{m.off("msg",O)}},[m,n._id]),f.useEffect(()=>{r.current&&(r.current.style.display="none");const a=setTimeout(()=>{r.current&&g.current&&g.current.scrollHeight>g.current.clientHeight&&(r.current.style.display="flex")},1e3);return()=>{clearTimeout(a)}},[n._id]),f.useEffect(()=>{if(!(!g.current||!s)){if(s.length<=D)return C();if(Math.abs(g.current.scrollHeight-g.current.scrollTop-g.current.clientHeight)<300)return console.log("bottom"),C();if(s[s.length-1].sender==l&&d)return d=!1,C()}},[s]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:g,id:"messages-container",children:[e.jsx(me,{onChange:j,children:e.jsx("div",{ref:r,id:"topRef",children:e.jsx(se,{size:50})})}),s&&e.jsx(je,{token:i,messages:s,userId:l,participants:n.participants}),e.jsx("div",{ref:y})]}),e.jsxs("button",{id:"btn_scroll",ref:h,onClick:()=>{C()},children:[Array.isArray(s)&&s.length>1&&s[s.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const we=({room:i,token:n,profile:l})=>{const[d,s]=f.useState(!1),c=f.useCallback(()=>{s(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(fe,{token:n,userId:l._id,room:i}),i&&e.jsx(_e,{justSent:d,room:i,token:n,userId:l._id}),i&&e.jsx(le,{token:n,userId:l._id,roomId:i._id,onJustSent:c})]})},Ee=i=>new Promise(async(n,l)=>{if(!window.confirm("Are you sure you want to delete your account?"))return l("Account deletion canceled");const s=window.prompt("Enter your password:");if(!s)return l("Password input canceled");try{const c={password:s},o=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify(c)});if(o.ok)return sessionStorage.removeItem("token"),n("Account deletion successful");const t=await o.json();if(t.message)return l(t.message);l("Wrong password")}catch(c){l(c)}});const Se=({token:i,profileData:n,onRefresh:l})=>{const[d,s]=f.useState(!1),[c,o]=f.useState(!1),t=f.useRef(null),r=f.useRef(null),y=F(),h=B();f.useEffect(()=>{if(h)return h.on("inv",l),()=>{h.off("inv",l)}},[h]);const g=()=>{sessionStorage.removeItem("token"),y("/auth")},m=a=>{fetch(`/api/v1/rooms/${a}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({action:"join"})})},k=a=>{fetch(`/api/v1/rooms/${a}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({action:"refuse"})})},O=async()=>{if(!r.current)return;let a={};if(r.current.bio.value&&(a.bio=r.current.bio.value),r.current.fullname.value&&(a.fullname=r.current.fullname.value),r.current.password.value)if(a.password=r.current.password.value,r.current.current_password.value)a.current_password=r.current.current_password.value;else return alert("Please enter current password");if(t.current&&(a.avatar=t.current),!a.bio&&!a.fullname&&!a.password&&!a.avatar)return alert("Empty form");const p=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify(a)});if(o(!1),p.ok)return alert("Updated successfully!"),l();const b=await p.json();if(b.message)return alert(b.message);alert("Error updating profile")},C=async a=>{const p=new FormData;p.append("file",a);const b=await fetch(`/media/${n==null?void 0:n._id}/public?token=${i}&count=1`,{method:"POST",body:p}),_=await b.json();!b.ok&&_.message&&alert(_.message),_.urls&&(t.current=_.urls[0],O())},j=async()=>{try{const a=await Ee(i);alert(a),y("/auth")}catch(a){alert(a)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:n==null?void 0:n.avatar,alt:"Profile",id:"profile_img",className:"cover"}),c?e.jsx(J,{accept:"image/*",onChange:C,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:n==null?void 0:n.fullname}),(n==null?void 0:n.bio)&&e.jsx("p",{children:n==null?void 0:n.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{s(!1),o(a=>!a)},children:c?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{o(!1),s(a=>!a)},children:d?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),n!=null&&n.invitations.length&&(n==null?void 0:n.invitations.length)>0?e.jsx("span",{id:"nofcount",children:n==null?void 0:n.invitations.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:g,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${d?"active":""}`,children:n&&n.invitations.length>0?n.invitations.map(a=>e.jsxs("div",{children:[e.jsx("p",{children:a}),e.jsx("button",{onClick:()=>m(a),children:"Accept"}),e.jsx("button",{onClick:()=>k(a),children:"Refuse"})]},a)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:`profile_dropdown ${c?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:r,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:n==null?void 0:n.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:n==null?void 0:n.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:j,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:O,children:"Save"})]})]})]})},Ce=f.memo(Se);const Te=({token:i,onChoose:n})=>{const l=f.useRef(null),[d,s]=f.useState([]),c=()=>{var y;const r=(y=l.current)==null?void 0:y.value;r&&fetch(`/api/v1/search/${r}`,{headers:{"content-type":"application/json",authorization:"Bearer "+i}}).then(h=>{if(h.ok)return h.json().then(g=>{s(g)});console.log(h.status)})},o=r=>{r.key==="Enter"&&c()},t=r=>{l.current&&!l.current.contains(r.target)&&(s([]),l.current.value="")};return f.useEffect(()=>(document.addEventListener("click",t),()=>{document.removeEventListener("click",t)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:l,onKeyPress:o}),e.jsx("button",{className:"btn",onClick:c,children:e.jsx("i",{className:"bx bx-search"})}),d.length>0&&e.jsx("div",{id:"search_dropdown",children:d.map(r=>e.jsxs("div",{onClick:()=>{n({_id:r._id,fullname:r.fullname})},children:[e.jsx("img",{className:"profile-picture",src:r.avatar,alt:"Avatar"}),r.fullname]},r._id))})]})};const Le=({token:i})=>{const[n,l]=f.useState([]),d=o=>{if(n.some(t=>t._id==o._id))return alert("already selected this user");l(t=>[...t,o])},s=o=>{console.log("remove user from users list"),o>=0&&o<n.length&&l(t=>t.filter((y,h)=>h!==o))},c=async()=>{if(n.length==0)return alert("Please select a user");const o=n.map(t=>t._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({invited:o})})).ok?l([]):alert("deo biet sao bug luon")}catch(t){console.error(t)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(Te,{token:i,onChoose:d}),n.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:n.map((o,t)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",o.fullname]}),e.jsx("span",{onClick:()=>s(t),children:"X"})]},o.fullname))}),e.jsx("button",{className:"btn",onClick:c,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})};function Ne(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const Y=i=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+i}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Pe=({token:i})=>{const[n,l]=f.useState(null),[d,s]=f.useState([]),[c,o]=f.useState(0),t=F(),r=async()=>{try{console.log("Loading profile again...");const g=await Y(i);l(g)}catch{t("/auth")}},y=g=>{o(g)},h=g=>{s(g)};return f.useEffect(()=>{i&&Y(i).then(g=>{l(g)}).catch(g=>{console.error(g),t("/auth")})},[i]),e.jsx("div",{id:"main-page",className:"flex",children:n?e.jsxs(re,{token:i,children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ce,{token:i,profileData:n,onRefresh:r}),e.jsx(Le,{token:i}),e.jsx(oe,{userId:n._id,currentRoomIndex:c,token:i,onRoomChange:y,onUpdateStatus:h})]}),e.jsx("section",{id:"section-right",children:e.jsx(we,{profile:n,token:i,room:d[c]})})]}),e.jsx(Ne,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{Pe as default,Y as getProfile};
