import{r as h,j as e,u as F,a as ee,c as te,g as ne,P as se}from"./index-b1d6f28c.js";import{u as B,S as re}from"./index-4563ebb2.js";const ie=({participants:i,userId:t})=>{if(i=i.filter(s=>s._id!==t),i.length===0)return null;const d=i.length>1,f=i.slice(0,4);return e.jsx("div",{className:"card",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:f.map((s,l)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:s.avatar,alt:"Profile",className:"group-profile-picture"})},l))}),e.jsxs("div",{className:"profile-names",children:[f.length>0&&e.jsx("h3",{children:f.map(s=>s.fullname).join(", ")}),i.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",i.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:i[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[i[0].fullname+"  ",e.jsx("span",{className:i[0].isOnline?"online":"offline",children:"â€¢"})]}),i[0].bio&&e.jsx("p",{children:i[0].bio})]})})},X=h.memo(ie);const K=i=>new Promise((t,d)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+i}}).then(f=>{if(f.ok)return f.json().then(s=>{t(s)});if(f.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(f=>{d(f)})}),oe=({userId:i,currentRoomIndex:t,token:d,onRoomChange:f,onUpdateStatus:s})=>{const[l,a]=h.useState([]),n=B(),o=F(),v=r=>{const p=r;a(b=>b&&b.map(w=>{const N=w.participants.map(T=>T._id===p?{...T,isOnline:!0}:T);return{...w,participants:N}}))},m=r=>{const p=r;a(b=>b&&b.map(w=>{const N=w.participants.map(T=>T._id===p?{...T,isOnline:!1}:T);return{...w,participants:N}}))},g=r=>{console.log("set meet"),a(p=>p&&p.map(b=>b._id===r[1]?{...b,isMeeting:!0,meeting_uuid:r[2]}:b))},u=r=>{console.log("set end meet"),a(p=>p&&p.map(b=>b._id===r[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},_=()=>{K(d).then(r=>{a(r)}).catch(()=>{o("/auth")})},k=r=>{var b,w;const p=document.querySelectorAll(".chat-room");p==null||p.forEach(N=>{var T;(T=N.classList)==null||T.remove("active")}),(w=(b=p[r])==null?void 0:b.classList)==null||w.add("active"),f(r)};h.useEffect(()=>{l.length>0&&s(l)},[l]),h.useEffect(()=>{if(n)return n.on("onl",v),n.on("off",m),n.on("meet",g),n.on("end_meet",u),n.on("room",_),()=>{n.off("onl",v),n.off("off",m),n.off("meet",g),n.off("end_meet",u),n.off("room",_)}},[n]),h.useEffect(()=>{K(d).then(r=>{a(r)}).catch(()=>{o("/auth")})},[]);const S=async(r,p)=>{switch(r){case"leave":return fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+d},body:JSON.stringify({action:r})});case"delete":return fetch(`/api/v1/rooms/${p}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+d}})}},j=h.useMemo(()=>l.map((r,p)=>e.jsxs("div",{className:`chat-room ${p==t?"active":""}`,children:[e.jsx("div",{onClick:()=>k(p),children:e.jsx(X,{userId:i,participants:r.participants})}),e.jsx("input",{className:"checkbox",type:"checkbox",id:`${r._id}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${r._id}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{onClick:()=>S("leave",r._id),children:"Leave"}),e.jsx("button",{onClick:()=>S("delete",r._id),children:"Delete"})]})]},r._id)),[l]);return e.jsx("div",{id:"rooms-list",children:l&&l.length>0?e.jsx("div",{children:j}):e.jsx("p",{children:"No rooms to display"})})};const J=({onChange:i,accept:t,id:d,icon:f})=>{const s=h.useRef(null),l=a=>{if(a.target.files){const n=a.target.files[0];i(n)}};return e.jsxs("label",{id:`btn_${d}`,className:"btn_fileinput",htmlFor:d,children:[f,e.jsx("input",{id:d,className:"fileinput",type:"file",accept:t,ref:s,onChange:l,style:{display:"none"}})]})};const ae=({token:i,userId:t,roomId:d,onJustSent:f})=>{const[s,l]=h.useState(""),[a,n]=h.useState([]),[o,v]=h.useState([]),m=B(),g=async j=>{try{const r=new FormData;return j.forEach(w=>{r.append(`file${j.length>1?"s":""}`,w)}),await(await fetch(`/media/${t}/${d}?token=${i}&count=${j.length}`,{method:"POST",body:r})).json()}catch(r){throw r}},u=j=>{l(j.target.value),console.log("typing ...")},_=async()=>{let j=[],r=[];if(a.length>0&&(console.log(a.length),j=a,n([])),o.length>0&&(console.log(o.length),j=[...j,...o],v([])),j.length>0)try{const p=await g(j);p.urls&&(r=p.urls)}catch(p){return alert("error uploading files: "+p.message)}(s.trim()!==""||r.length!==0)&&(console.log(r),m==null||m.emit("msg",[d,s,new Date,r]),f(),l(""))},k=j=>{v(r=>[...r,j])},S=j=>{n(r=>[...r,j])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(J,{accept:"image/*",onChange:k,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(J,{accept:"*",onChange:S,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),o.length>0&&e.jsx("div",{children:o.map((j,r)=>e.jsx("span",{children:j.name},r))}),a.length>0&&e.jsx("div",{children:a.map((j,r)=>e.jsx("span",{children:j.name},r))}),e.jsx("input",{type:"text",value:s,id:"input_message",onChange:u,onKeyDown:j=>{j.key=="Enter"&&_()}}),e.jsx("button",{onClick:_,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},le=h.memo(ae);const ce={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},ue=()=>{const[i,t]=h.useState(sessionStorage.getItem("theme")||"light");return h.useEffect(()=>{const d=ce[i];Object.entries(d).forEach(([f,s])=>{document.documentElement.style.setProperty(`--${f}-color`,s)}),sessionStorage.setItem("theme",i)},[i]),[i,t]},de=()=>{const[i,t]=ue(),d=i==="light",f=()=>{t(d?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:d,onChange:f}),e.jsxs("label",{className:`switcher-label ${d?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const fe=({token:i,room:t,userId:d})=>{const f=B(),s=()=>{f.emit("meet",[t._id,new Date])},l=n=>{const o=`/meet/${n}?token=${i}&room=${t._id}`;window.open(o)},a=n=>{if(console.log(n),n[0]==d)return n[3]?void 0:l(n[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{l(n[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&a(n)})};return t&&h.useEffect(()=>{if(f)return f.on("meet",a),()=>{f.off("meet",a)}},[f,t._id]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[t&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:d,participants:t.participants}),t.isMeeting&&t.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>l(t.meeting_uuid),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:s,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(de,{})]})},he=h.memo(fe);var q={exports:{}};(function(i,t){(function(f,s){i.exports=s(h,ee)})(te,function(d,f){return function(s){var l={};function a(n){if(l[n])return l[n].exports;var o=l[n]={i:n,l:!1,exports:{}};return s[n].call(o.exports,o,o.exports,a),o.l=!0,o.exports}return a.m=s,a.c=l,a.d=function(n,o,v){a.o(n,o)||Object.defineProperty(n,o,{enumerable:!0,get:v})},a.r=function(n){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},a.t=function(n,o){if(o&1&&(n=a(n)),o&8||o&4&&typeof n=="object"&&n&&n.__esModule)return n;var v=Object.create(null);if(a.r(v),Object.defineProperty(v,"default",{enumerable:!0,value:n}),o&2&&typeof n!="string")for(var m in n)a.d(v,m,(function(g){return n[g]}).bind(null,m));return v},a.n=function(n){var o=n&&n.__esModule?function(){return n.default}:function(){return n};return a.d(o,"a",o),o},a.o=function(n,o){return Object.prototype.hasOwnProperty.call(n,o)},a.p="",a(a.s=4)}([function(s,l,a){s.exports=a(5)()},function(s,l){s.exports=d},function(s,l){s.exports=f},function(s,l){s.exports=function(a,n,o){var v=a.direction,m=a.value;switch(v){case"top":return o.top+m<n.top&&o.bottom>n.bottom&&o.left<n.left&&o.right>n.right;case"left":return o.left+m<n.left&&o.bottom>n.bottom&&o.top<n.top&&o.right>n.right;case"bottom":return o.bottom-m>n.bottom&&o.left<n.left&&o.right>n.right&&o.top<n.top;case"right":return o.right-m>n.right&&o.left<n.left&&o.top<n.top&&o.bottom>n.bottom}}},function(s,l,a){a.r(l),a.d(l,"default",function(){return V});var n=a(1),o=a.n(n),v=a(2),m=a.n(v),g=a(0),u=a.n(g),_=a(3),k=a.n(_);function S(x){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?S=function(E){return typeof E}:S=function(E){return E&&typeof Symbol=="function"&&E.constructor===Symbol&&E!==Symbol.prototype?"symbol":typeof E},S(x)}function j(x,y){if(!(x instanceof y))throw new TypeError("Cannot call a class as a function")}function r(x,y){for(var E=0;E<y.length;E++){var c=y[E];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(x,c.key,c)}}function p(x,y,E){return y&&r(x.prototype,y),E&&r(x,E),x}function b(x,y){return y&&(S(y)==="object"||typeof y=="function")?y:N(x)}function w(x){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(E){return E.__proto__||Object.getPrototypeOf(E)},w(x)}function N(x){if(x===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return x}function T(x,y){if(typeof y!="function"&&y!==null)throw new TypeError("Super expression must either be null or a function");x.prototype=Object.create(y&&y.prototype,{constructor:{value:x,writable:!0,configurable:!0}}),y&&A(x,y)}function A(x,y){return A=Object.setPrototypeOf||function(c,P){return c.__proto__=P,c},A(x,y)}function $(x,y,E){return y in x?Object.defineProperty(x,y,{value:E,enumerable:!0,configurable:!0,writable:!0}):x[y]=E,x}function Z(x){return x.width===void 0&&(x.width=x.right-x.left),x.height===void 0&&(x.height=x.bottom-x.top),x}var V=function(x){T(y,x);function y(E){var c;return j(this,y),c=b(this,w(y).call(this,E)),$(N(c),"getContainer",function(){return c.props.containment||window}),$(N(c),"addEventListener",function(P,C,L,R){c.debounceCheck||(c.debounceCheck={});var O,z,M=function(){O=null,c.check()};R>-1?z=function(){O||(O=setTimeout(M,R||0))}:z=function(){clearTimeout(O),O=setTimeout(M,L||0)};var U={target:P,fn:z,getLastTimeout:function(){return O}};P.addEventListener(C,U.fn),c.debounceCheck[C]=U}),$(N(c),"startWatching",function(){c.debounceCheck||c.interval||(c.props.intervalCheck&&(c.interval=setInterval(c.check,c.props.intervalDelay)),c.props.scrollCheck&&c.addEventListener(c.getContainer(),"scroll",c.props.scrollDelay,c.props.scrollThrottle),c.props.resizeCheck&&c.addEventListener(window,"resize",c.props.resizeDelay,c.props.resizeThrottle),!c.props.delayedCall&&c.check())}),$(N(c),"stopWatching",function(){if(c.debounceCheck){for(var P in c.debounceCheck)if(c.debounceCheck.hasOwnProperty(P)){var C=c.debounceCheck[P];clearTimeout(C.getLastTimeout()),C.target.removeEventListener(P,C.fn),c.debounceCheck[P]=null}}c.debounceCheck=null,c.interval&&(c.interval=clearInterval(c.interval))}),$(N(c),"check",function(){var P=c.node,C,L;if(!P)return c.state;if(C=Z(c.roundRectDown(P.getBoundingClientRect())),c.props.containment){var R=c.props.containment.getBoundingClientRect();L={top:R.top,left:R.left,bottom:R.bottom,right:R.right}}else L={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var O=c.props.offset||{},z=S(O)==="object";z&&(L.top+=O.top||0,L.left+=O.left||0,L.bottom-=O.bottom||0,L.right-=O.right||0);var M={top:C.top>=L.top,left:C.left>=L.left,bottom:C.bottom<=L.bottom,right:C.right<=L.right},U=C.height>0&&C.width>0,I=U&&M.top&&M.left&&M.bottom&&M.right;if(U&&c.props.partialVisibility){var W=C.top<=L.bottom&&C.bottom>=L.top&&C.left<=L.right&&C.right>=L.left;typeof c.props.partialVisibility=="string"&&(W=M[c.props.partialVisibility]),I=c.props.minTopValue?W&&C.top<=L.bottom-c.props.minTopValue:W}typeof O.direction=="string"&&typeof O.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",O.direction,O.value),I=k()(O,C,L));var G=c.state;return c.state.isVisible!==I&&(G={isVisible:I,visibilityRect:M},c.setState(G),c.props.onChange&&c.props.onChange(I)),G}),c.state={isVisible:null,visibilityRect:{}},c}return p(y,[{key:"componentDidMount",value:function(){this.node=m.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(c){this.node=m.a.findDOMNode(this),this.props.active&&!c.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(c){return{top:Math.floor(c.top),left:Math.floor(c.left),bottom:Math.floor(c.bottom),right:Math.floor(c.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):o.a.Children.only(this.props.children)}}]),y}(o.a.Component);$(V,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:o.a.createElement("span",null)}),$(V,"propTypes",{onChange:u.a.func,active:u.a.bool,partialVisibility:u.a.oneOfType([u.a.bool,u.a.oneOf(["top","right","bottom","left"])]),delayedCall:u.a.bool,offset:u.a.oneOfType([u.a.shape({top:u.a.number,left:u.a.number,bottom:u.a.number,right:u.a.number}),u.a.shape({direction:u.a.oneOf(["top","right","bottom","left"]),value:u.a.number})]),scrollCheck:u.a.bool,scrollDelay:u.a.number,scrollThrottle:u.a.number,resizeCheck:u.a.bool,resizeDelay:u.a.number,resizeThrottle:u.a.number,intervalCheck:u.a.bool,intervalDelay:u.a.number,containment:typeof window<"u"?u.a.instanceOf(window.Element):u.a.any,children:u.a.oneOfType([u.a.element,u.a.func]),minTopValue:u.a.number})},function(s,l,a){var n=a(6);function o(){}function v(){}v.resetWarningCache=o,s.exports=function(){function m(_,k,S,j,r,p){if(p!==n){var b=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw b.name="Invariant Violation",b}}m.isRequired=m;function g(){return m}var u={array:m,bool:m,func:m,number:m,object:m,string:m,symbol:m,any:m,arrayOf:g,element:m,elementType:m,instanceOf:g,node:m,objectOf:g,oneOf:g,oneOfType:g,shape:g,exact:g,checkPropTypes:v,resetWarningCache:o};return u.PropTypes=u,u}},function(s,l,a){var n="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";s.exports=n}])})})(q);var pe=q.exports;const me=ne(pe);const ge=({src:i,alt:t})=>{const[d,f]=h.useState(!1);return h.useEffect(()=>{const s=new IntersectionObserver(a=>{a.forEach(n=>{n.isIntersecting&&(f(!0),s.unobserve(n.target))})}),l=document.getElementById(`lazyload-element-${i}`);return l&&s.observe(l),()=>{l&&s.unobserve(l)}},[i]),e.jsx("video",{id:`lazyload-element-${i}`,controls:!0,autoPlay:!1,playsInline:!0,src:d?i:"",children:t})},xe=({src:i,alt:t})=>{const[d,f]=h.useState(!1);return h.useEffect(()=>{const s=new IntersectionObserver(a=>{a.forEach(n=>{n.isIntersecting&&(f(!0),s.unobserve(n.target))})}),l=document.getElementById(`lazyload-element-${i}`);return l&&s.observe(l),()=>{l&&s.unobserve(l)}},[i]),e.jsx("img",{id:`lazyload-element-${i}`,src:d?i:"",loading:"lazy",alt:t})},Q=({url:i,token:t})=>{var n;const[d,f]=h.useState(!1),[s,l]=h.useState(!1),a=((n=i.split("/").pop())==null?void 0:n.substring(23))||"File";return h.useEffect(()=>{var v;const o=(v=i.split(".").pop())==null?void 0:v.toLowerCase();f(["jpg","jpeg","png","gif","bmp","svg"].includes(o||"")),l(["mp4","webm","ogg"].includes(o||""))},[i]),d?e.jsx(xe,{src:i+"?token="+t,alt:a}):s?e.jsx(ge,{src:i+"?token="+t,alt:a}):e.jsx("a",{href:i+"?token="+t,target:"_blank",rel:"noopener noreferrer",children:a})},be=({token:i,content:t,timestamp:d,urls:f})=>e.jsxs("div",{className:"message own",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:t})}),e.jsx("p",{className:"message_timestamp",children:d}),f&&f.length>0&&f.map((s,l)=>e.jsx(Q,{token:i,url:s},d+l))]}),ve=({token:i,avatarSRC:t,content:d,timestamp:f,urls:s})=>e.jsxs("div",{className:"message guest",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:t,alt:"Sender Avatar"}),e.jsx("p",{children:d}),s&&s.length>0&&s.map((l,a)=>e.jsx(Q,{token:i,url:l},f+a))]}),e.jsx("p",{className:"message_timestamp",children:f})]}),ye=({token:i,messages:t,userId:d,participants:f})=>e.jsx(e.Fragment,{children:Array.isArray(t)&&t.map((s,l)=>{if(s.sender&&s.sender==d)return e.jsx(be,{token:i,content:s.content,timestamp:s.timestamp,urls:s.urls},l);{const a=f.find(o=>o._id===s.sender),n=a?a.avatar:"";return e.jsx(ve,{token:i,avatarSRC:n,content:s.content,timestamp:s.timestamp,urls:s.urls},l)}})}),je=h.memo(ye);const H=(i,t,d,f)=>fetch(`/api/v1/rooms/${i}?limit=${d}&skip=${f}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(s=>{if(s.status===304)throw new Error("Already got this");if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),D=30,_e=({token:i,room:t,userId:d,justSent:f})=>{const[s,l]=h.useState([]),[a,n]=h.useState(0),o=h.useRef(null),v=h.useRef(null),m=h.useRef(null),g=h.useRef(null),u=B(),_=F();console.log("Render container");const k=r=>{if(r[1]===t._id){const p=r[0];if(p!==d&&!t.participants.some(T=>T._id===p))return;m.current&&(m.current.style.display="block");const b=r[2],w=r[3],N=r[4];n(T=>T++),l(T=>T!==null?[...T,{sender:p,content:b,timestamp:w,urls:N}]:[{sender:p,content:b,timestamp:w,urls:N}])}},S=()=>{v.current&&(v.current.scrollIntoView({behavior:"smooth"}),m.current&&(m.current.style.display="none"))},j=r=>{if(!r||!s||s.length==0)return;if(s.length>=a){o.current&&(o.current.style.display="none");return}let p,b=D;p=a-s.length-b,p<0&&(b+=p,p=0),H(t._id,i,`${b}`,`${p}`).then(w=>{g.current&&(g.current.scrollTop=300),l(N=>N?w.messages.concat(N):w.messages),w.conversationLength&&n(w.conversationLength)}).catch(()=>{_("/auth")})};return h.useEffect(()=>{try{if(!i||!t)return;H(t._id,i).then(r=>{l(r.messages),r.conversationLength&&n(r.conversationLength)}).catch(()=>{_("/auth")})}catch(r){console.error(r)}},[i,t._id]),h.useEffect(()=>{if(u)return u.on("msg",k),()=>{u.off("msg",k)}},[u,t._id]),h.useEffect(()=>{o.current&&(o.current.style.display="none");const r=setTimeout(()=>{o.current&&g.current&&g.current.scrollHeight>g.current.clientHeight&&(o.current.style.display="flex")},1e3);return()=>{clearTimeout(r)}},[t._id]),h.useEffect(()=>{if(!(!g.current||!s)){if(s.length<=D)return S();if(Math.abs(g.current.scrollHeight-g.current.scrollTop-g.current.clientHeight)<300)return console.log("bottom"),S();if(s[s.length-1].sender==d&&f)return f=!1,S()}},[s]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:g,id:"messages-container",children:[e.jsx(me,{onChange:j,children:e.jsx("div",{ref:o,id:"topRef",children:e.jsx(se,{size:50})})}),s&&e.jsx(je,{token:i,messages:s,userId:d,participants:t.participants}),e.jsx("div",{ref:v})]}),e.jsxs("button",{id:"btn_scroll",ref:m,onClick:()=>{S()},children:[Array.isArray(s)&&s.length>1&&s[s.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const we=({room:i,token:t,profile:d})=>{const[f,s]=h.useState(!1),l=h.useCallback(()=>{s(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(he,{token:t,userId:d._id,room:i}),i&&e.jsx(_e,{justSent:f,room:i,token:t,userId:d._id}),i&&e.jsx(le,{token:t,userId:d._id,roomId:i._id,onJustSent:l})]})},Ee=i=>new Promise(async(t,d)=>{if(!window.confirm("Are you sure you want to delete your account?"))return d("Account deletion canceled");const s=window.prompt("Enter your password:");if(!s)return d("Password input canceled");try{const l={password:s},a=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify(l)});if(a.ok)return sessionStorage.removeItem("token"),t("Account deletion successful");const n=await a.json();if(n.message)return d(n.message);d("Wrong password")}catch(l){d(l)}});const Se=({token:i,profileData:t,onRefresh:d})=>{const[f,s]=h.useState(!1),[l,a]=h.useState(!1),n=h.useRef(null),o=h.useRef(null),v=F(),m=B();h.useEffect(()=>{if(m)return m.on("inv",d),()=>{m.off("inv",d)}},[m]);const g=()=>{sessionStorage.removeItem("token"),v("/auth")},u=r=>{fetch(`/api/v1/rooms/${r}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({action:"join"})})},_=r=>{fetch(`/api/v1/rooms/${r}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({action:"refuse"})})},k=async()=>{if(!o.current)return;let r={};if(o.current.bio.value&&(r.bio=o.current.bio.value),o.current.fullname.value&&(r.fullname=o.current.fullname.value),o.current.password.value)if(r.password=o.current.password.value,o.current.current_password.value)r.current_password=o.current.current_password.value;else return alert("Please enter current password");if(n.current&&(r.avatar=n.current),!r.bio&&!r.fullname&&!r.password&&!r.avatar)return alert("Empty form");const p=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify(r)});if(a(!1),p.ok)return alert("Updated successfully!"),d();const b=await p.json();if(b.message)return alert(b.message);alert("Error updating profile")},S=async r=>{const p=new FormData;p.append("file",r);const b=await fetch(`/media/${t==null?void 0:t._id}/public?token=${i}&count=1`,{method:"POST",body:p}),w=await b.json();!b.ok&&w.message&&alert(w.message),w.urls&&(n.current=w.urls[0],k())},j=async()=>{try{const r=await Ee(i);alert(r),v("/auth")}catch(r){alert(r)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:t==null?void 0:t.avatar,alt:"Profile",id:"profile_img",className:"cover"}),l?e.jsx(J,{accept:"image/*",onChange:S,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:t==null?void 0:t.fullname}),(t==null?void 0:t.bio)&&e.jsx("p",{children:t==null?void 0:t.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{s(!1),a(r=>!r)},children:l?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{a(!1),s(r=>!r)},children:f?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t!=null&&t.invitations.length&&(t==null?void 0:t.invitations.length)>0?e.jsx("span",{id:"nofcount",children:t==null?void 0:t.invitations.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:g,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${f?"active":""}`,children:t&&t.invitations.length>0?t.invitations.map(r=>e.jsxs("div",{children:[e.jsx("p",{children:r}),e.jsx("button",{onClick:()=>u(r),children:"Accept"}),e.jsx("button",{onClick:()=>_(r),children:"Refuse"})]},r)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:`profile_dropdown ${l?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:o,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:t==null?void 0:t.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:t==null?void 0:t.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:j,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:k,children:"Save"})]})]})]})},Ce=h.memo(Se);const Te=({token:i})=>{const[t,d]=h.useState([]),[f,s]=h.useState([]),l=h.useRef(null),a=u=>{if(t.some(_=>_._id==u._id))return alert("already selected this user");d(_=>[..._,u])},n=u=>{console.log("remove user from users list"),u>=0&&u<t.length&&d(_=>_.filter((S,j)=>j!==u))},o=async()=>{if(t.length==0)return alert("Please select a user");const u=t.map(_=>_._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+i},body:JSON.stringify({invited:u})})).ok?d([]):alert("deo biet sao bug luon")}catch(_){console.error(_)}},v=()=>{var _;const u=(_=l.current)==null?void 0:_.value;u&&fetch(`/api/v1/search/${u}`,{headers:{"content-type":"application/json",authorization:"Bearer "+i}}).then(k=>{if(k.ok)return k.json().then(S=>{s(S)});console.log(k.status)})},m=u=>{u.key==="Enter"&&v()},g=u=>{l.current&&!l.current.contains(u.target)&&(s([]),l.current.value="")};return h.useEffect(()=>(document.addEventListener("click",g),()=>{document.removeEventListener("click",g)}),[]),e.jsxs("div",{id:"room-maker",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{id:"search-bar",children:[e.jsx("button",{className:"btn",onClick:v,children:e.jsx("i",{className:"bx bx-search"})}),e.jsx("div",{id:"chosenList",className:"flex",children:t.map((u,_)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",u.fullname]}),e.jsx("span",{onClick:()=>n(_),children:"X"})]},u.fullname))}),e.jsx("input",{type:"text",placeholder:"Search for users...",ref:l,onKeyPress:m})]}),t.length>0&&e.jsx("div",{className:"flex",children:e.jsx("button",{className:"btn",onClick:o,children:e.jsx("i",{className:"bx bxs-message-square-add"})})})]}),f.length>0&&e.jsx("div",{id:"search_dropdown",children:f.map(u=>e.jsxs("div",{onClick:()=>{a({_id:u._id,fullname:u.fullname})},children:[e.jsx("img",{className:"profile-picture",src:u.avatar,alt:"Avatar"}),u.fullname]},u._id))})]})};function Ne(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const Y=i=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+i}}).then(t=>{if(t.ok)return t.json();throw t.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Oe=({token:i})=>{const[t,d]=h.useState(null),[f,s]=h.useState([]),[l,a]=h.useState(0),n=F(),o=async()=>{try{console.log("Loading profile again...");const g=await Y(i);d(g)}catch{n("/auth")}},v=g=>{a(g)},m=g=>{s(g)};return h.useEffect(()=>{i&&Y(i).then(g=>{d(g)}).catch(g=>{console.error(g),n("/auth")})},[i]),e.jsx("div",{id:"main-page",className:"flex",children:t?e.jsxs(re,{token:i,children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ce,{token:i,profileData:t,onRefresh:o}),e.jsx(Te,{token:i}),e.jsx(oe,{userId:t._id,currentRoomIndex:l,token:i,onRoomChange:v,onUpdateStatus:m})]}),e.jsx("section",{id:"section-right",children:e.jsx(we,{profile:t,token:i,room:f[l]})})]}),e.jsx(Ne,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{Oe as default,Y as getProfile};
