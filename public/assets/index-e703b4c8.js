import{r as s,j as d,a as v,u as x}from"./index-1529bb9e.js";import{g as C}from"./getSocket-3ac81373.js";const k={iceServers:[{urls:"stun:stun.relay.metered.ca:80"}],iceCandidatePoolSize:10},E=({peerId:f,offer:R,answer:a,ice:o,localStream:i,onSendToPeer:l})=>{const c=s.useRef(null),w=s.useRef(null),m=s.useRef(null),u=s.useRef(null),y=async t=>{if(c.current=new RTCPeerConnection(k),w.current=new MediaStream,m.current)m.current.srcObject=w.current;else throw new Error("41");i==null||i.getTracks().forEach(e=>{var n;(n=c.current)==null||n.addTrack(e,i)}),c.current.ontrack=e=>{e.streams[0].getTracks().forEach(n=>{var h;(h=w.current)==null||h.addTrack(n)})},c.current.onicecandidate=async e=>{e.candidate&&l("ice_candidate",[t,e.candidate])}},P=async t=>{var e,n;await y(t),u.current=await((e=c.current)==null?void 0:e.createOffer()),await((n=c.current)==null?void 0:n.setLocalDescription(u.current)),l("offer",[t,u.current])},p=async(t,e)=>{var n,h,j;await y(t),await((n=c.current)==null?void 0:n.setRemoteDescription(e)),u.current=await((h=c.current)==null?void 0:h.createAnswer()),await((j=c.current)==null?void 0:j.setLocalDescription(u.current)),l("answer",[t,u.current])},g=async t=>{var e;await((e=c.current)==null?void 0:e.setRemoteDescription(t))},r=async t=>{var e;(e=c.current)==null||e.addIceCandidate(t)};return s.useEffect(()=>{R?p(f,R):P(f)},[]),s.useEffect(()=>{a&&g(a)},[a]),s.useEffect(()=>{o&&(console.log(o),r(o))},[o]),d.jsxs("div",{children:[d.jsxs("p",{children:["Peer ID: ",f]}),d.jsx("video",{className:"remote-video",ref:m,autoPlay:!0,playsInline:!0})]})};const I=()=>{const{meetId:f}=v(),R=x(),a=s.useRef(null),o=s.useRef(null),i=s.useRef(null),[l,c]=s.useState([]),w=async()=>{if(o.current=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),i.current)i.current.srcObject=o.current;else throw new Error("Can not get user media")},m=r=>{c(t=>t.filter(n=>n.id!==r))},u=r=>{c(t=>{const e={id:r};return[...t,e]})},y=async r=>{c(t=>{const e={id:r[0],offer:r[1]};return[...t,e]})},P=async r=>{c(t=>t.map(e=>e.id===r[0]?{...e,answer:r[1]}:e))},p=async r=>{c(t=>t.map(e=>e.id===r[0]?{...e,ice:r[1]}:e))};s.useEffect(()=>{const r=new URLSearchParams(window.location.search),t=r.get("room"),e=r.get("token");return!e||!t||!f?R("/auth"):(console.log("render"),w().then(()=>{const n=C(e,t,f);n.on("new_peer",u),n.on("off_peer",m),n.on("offer",y),n.on("answer",P),n.on("ice_candidate",p),a.current=n}),()=>{a.current&&a.current.disconnect()})},[]);const g=(r,t)=>{var e;(e=a.current)==null||e.emit(r,t)};return d.jsxs("div",{children:[d.jsx("h1",{children:"Meeting Page"}),d.jsxs("p",{children:["Meet UUID: ",f]}),d.jsx("video",{id:"local-video",ref:i,autoPlay:!0,playsInline:!0,muted:!0}),l.map(r=>d.jsx(E,{peerId:r.id,localStream:o.current,offer:r.offer,answer:r.answer,ice:r.ice,onSendToPeer:g},r.id))]})};export{I as default};
