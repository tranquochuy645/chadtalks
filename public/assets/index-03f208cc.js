import{r as f,j as e,u as W,a as ee,c as te,g as ne,P as se}from"./index-6aa5f5dd.js";import{u as B,S as re}from"./index-002c49ec.js";const ie=({participants:s,userId:n})=>{if(s=s.filter(r=>r._id!==n),s.length===0)return e.jsx("div",{className:"card",children:e.jsx("h3",{children:"No other participants in this room."})});const c=s.length>1,h=s.slice(0,4);return e.jsx("div",{className:"card",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:h.map((r,l)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:r.avatar,alt:"Profile",className:"group-profile-picture"})},l))}),e.jsxs("div",{className:"profile-names",children:[h.length>0&&e.jsx("h3",{children:h.map(r=>r.fullname).join(", ")}),s.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",s.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[s[0].fullname+"  ",e.jsx("span",{className:s[0].isOnline?"online":"offline",children:"â€¢"})]}),s[0].bio&&e.jsx("p",{children:s[0].bio})]})})},Q=f.memo(ie),oe=({roomId:s,handleAction:n})=>e.jsxs(e.Fragment,{children:[e.jsx("input",{className:"checkbox",type:"checkbox",id:`${s}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${s}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{onClick:()=>n("leave",s),children:"Leave"}),e.jsx("button",{onClick:()=>n("delete",s),children:"Delete"})]})]});const D=s=>new Promise((n,c)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(h=>{if(h.ok)return h.json().then(r=>{n(r)});if(h.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(h=>{c(h)})}),ae=({userId:s,currentRoomIndex:n,token:c,onRoomChange:h,onUpdateStatus:r})=>{const[l,o]=f.useState([]),t=B(),a=W(),v=u=>{const g=u;o(b=>b&&b.map(N=>{const L=N.participants.map(C=>C._id===g?{...C,isOnline:!0}:C);return{...N,participants:L}}))},m=u=>{const g=u;o(b=>b&&b.map(N=>{const L=N.participants.map(C=>C._id===g?{...C,isOnline:!1}:C);return{...N,participants:L}}))},y=u=>{console.log("set meet"),o(g=>g&&g.map(b=>b._id===u[1]?{...b,isMeeting:!0,meeting_uuid:u[2]}:b))},i=u=>{console.log("set end meet"),o(g=>g&&g.map(b=>b._id===u[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},x=()=>{D(c).then(u=>{o(u)}).catch(()=>{a("/auth")})},T=u=>{var b,N;const g=document.querySelectorAll(".chat-room");g==null||g.forEach(L=>{var C;(C=L.classList)==null||C.remove("active")}),(N=(b=g[u])==null?void 0:b.classList)==null||N.add("active"),h(u)},E=u=>{console.log(u),o(g=>g&&g.map(b=>b._id===u[1]?{...b,latestMessage:{sender:u[0],content:u[2],timestamp:u[3],urls:u[4]}}:b))},_=u=>{u[1]===s&&o(g=>g.map(b=>b._id===u[0]?{...b,lastReadTimeStamp:u[2]}:b))};f.useEffect(()=>{l.length>0&&r(l)},[l]),f.useEffect(()=>{if(t)return t.on("onl",v),t.on("off",m),t.on("meet",y),t.on("end_meet",i),t.on("room",x),t.on("msg",E),t.on("seen",_),()=>{t.off("onl",v),t.off("off",m),t.off("meet",y),t.off("end_meet",i),t.off("room",x),t.off("msg",E),t.off("seen",_)}},[t]),f.useEffect(()=>{D(c).then(u=>{o(u)}).catch(()=>{a("/auth")})},[]);const p=async(u,g)=>{switch(u){case"leave":return fetch(`/api/v1/rooms/${g}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+c},body:JSON.stringify({action:u})});case"delete":return fetch(`/api/v1/rooms/${g}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+c}})}},O=f.useMemo(()=>l.map((u,g)=>{var V,U;const b=u==null?void 0:u.lastReadTimeStamp,N=(V=u==null?void 0:u.latestMessage)==null?void 0:V.content,L=(U=u==null?void 0:u.latestMessage)==null?void 0:U.timestamp,C=L&&b&&new Date(L)>new Date(b)&&g!==n;return e.jsxs("div",{className:`chat-room ${g==n?"active":""}`,children:[e.jsxs("div",{onClick:()=>T(g),children:[e.jsx(Q,{userId:s,participants:u.participants}),e.jsx("p",{children:N}),e.jsx("p",{children:C?"Unread":"All Read"})]}),e.jsx(oe,{handleAction:p,roomId:u._id})]},u._id)}),[l]);return e.jsx("div",{id:"rooms-list",children:l&&l.length>0?e.jsx("div",{children:O}):e.jsx("p",{children:"No rooms to display"})})};const K=({onChange:s,accept:n,id:c,icon:h})=>{const r=f.useRef(null),l=o=>{if(o.target.files){const t=o.target.files[0];s(t)}};return e.jsxs("label",{id:`btn_${c}`,className:"btn_fileinput",htmlFor:c,children:[h,e.jsx("input",{id:c,className:"fileinput",type:"file",accept:n,ref:r,onChange:l,style:{display:"none"}})]})};const le=({token:s,userId:n,roomId:c,onJustSent:h})=>{const[r,l]=f.useState(""),[o,t]=f.useState([]),[a,v]=f.useState([]),m=B(),y=async _=>{try{const p=new FormData;return _.forEach(g=>{p.append(`file${_.length>1?"s":""}`,g)}),await(await fetch(`/media/${n}/${c}?token=${s}&count=${_.length}`,{method:"POST",body:p})).json()}catch(p){throw p}},i=_=>{l(_.target.value),console.log("typing ...")},x=async()=>{let _=[],p=[];if(o.length>0&&(console.log(o.length),_=o,t([])),a.length>0&&(console.log(a.length),_=[..._,...a],v([])),_.length>0)try{const O=await y(_);O.urls&&(p=O.urls)}catch(O){return alert("error uploading files: "+O.message)}(r.trim()!==""||p.length!==0)&&(console.log(p),m==null||m.emit("msg",[c,r,new Date,p]),h(),l(""))},T=_=>{v(p=>[...p,_])},E=_=>{t(p=>[...p,_])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(K,{accept:"image/*",onChange:T,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(K,{accept:"*",onChange:E,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),a.length>0&&e.jsx("div",{children:a.map((_,p)=>e.jsx("span",{children:_.name},p))}),o.length>0&&e.jsx("div",{children:o.map((_,p)=>e.jsx("span",{children:_.name},p))}),e.jsx("input",{type:"text",value:r,id:"input_message",onChange:i,onKeyDown:_=>{_.key=="Enter"&&x()}}),e.jsx("button",{onClick:x,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},ce=f.memo(le);const ue={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},de=()=>{const[s,n]=f.useState(sessionStorage.getItem("theme")||"light");return f.useEffect(()=>{const c=ue[s];Object.entries(c).forEach(([h,r])=>{document.documentElement.style.setProperty(`--${h}-color`,r)}),sessionStorage.setItem("theme",s)},[s]),[s,n]},fe=()=>{const[s,n]=de(),c=s==="light",h=()=>{n(c?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:c,onChange:h}),e.jsxs("label",{className:`switcher-label ${c?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const he=({token:s,room:n,userId:c})=>{const h=B(),r=()=>{h.emit("meet",[n._id,new Date])},l=t=>{const a=`/meet/${t}?token=${s}&room=${n._id}`;window.open(a)},o=t=>{if(console.log(t),t[0]==c)return t[3]?void 0:l(t[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{l(t[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(a=>{a==="granted"&&o(t)})};return n&&f.useEffect(()=>{if(h)return h.on("meet",o),()=>{h.off("meet",o)}},[h,n._id]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[n&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(Q,{userId:c,participants:n.participants}),n.isMeeting&&n.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>l(n.meeting_uuid),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:r,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(fe,{})]})},pe=f.memo(he);var X={exports:{}};(function(s,n){(function(h,r){s.exports=r(f,ee)})(te,function(c,h){return function(r){var l={};function o(t){if(l[t])return l[t].exports;var a=l[t]={i:t,l:!1,exports:{}};return r[t].call(a.exports,a,a.exports,o),a.l=!0,a.exports}return o.m=r,o.c=l,o.d=function(t,a,v){o.o(t,a)||Object.defineProperty(t,a,{enumerable:!0,get:v})},o.r=function(t){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,a){if(a&1&&(t=o(t)),a&8||a&4&&typeof t=="object"&&t&&t.__esModule)return t;var v=Object.create(null);if(o.r(v),Object.defineProperty(v,"default",{enumerable:!0,value:t}),a&2&&typeof t!="string")for(var m in t)o.d(v,m,(function(y){return t[y]}).bind(null,m));return v},o.n=function(t){var a=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(a,"a",a),a},o.o=function(t,a){return Object.prototype.hasOwnProperty.call(t,a)},o.p="",o(o.s=4)}([function(r,l,o){r.exports=o(5)()},function(r,l){r.exports=c},function(r,l){r.exports=h},function(r,l){r.exports=function(o,t,a){var v=o.direction,m=o.value;switch(v){case"top":return a.top+m<t.top&&a.bottom>t.bottom&&a.left<t.left&&a.right>t.right;case"left":return a.left+m<t.left&&a.bottom>t.bottom&&a.top<t.top&&a.right>t.right;case"bottom":return a.bottom-m>t.bottom&&a.left<t.left&&a.right>t.right&&a.top<t.top;case"right":return a.right-m>t.right&&a.left<t.left&&a.top<t.top&&a.bottom>t.bottom}}},function(r,l,o){o.r(l),o.d(l,"default",function(){return U});var t=o(1),a=o.n(t),v=o(2),m=o.n(v),y=o(0),i=o.n(y),x=o(3),T=o.n(x);function E(j){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?E=function(S){return typeof S}:E=function(S){return S&&typeof Symbol=="function"&&S.constructor===Symbol&&S!==Symbol.prototype?"symbol":typeof S},E(j)}function _(j,w){if(!(j instanceof w))throw new TypeError("Cannot call a class as a function")}function p(j,w){for(var S=0;S<w.length;S++){var d=w[S];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(j,d.key,d)}}function O(j,w,S){return w&&p(j.prototype,w),S&&p(j,S),j}function u(j,w){return w&&(E(w)==="object"||typeof w=="function")?w:b(j)}function g(j){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(S){return S.__proto__||Object.getPrototypeOf(S)},g(j)}function b(j){if(j===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return j}function N(j,w){if(typeof w!="function"&&w!==null)throw new TypeError("Super expression must either be null or a function");j.prototype=Object.create(w&&w.prototype,{constructor:{value:j,writable:!0,configurable:!0}}),w&&L(j,w)}function L(j,w){return L=Object.setPrototypeOf||function(d,R){return d.__proto__=R,d},L(j,w)}function C(j,w,S){return w in j?Object.defineProperty(j,w,{value:S,enumerable:!0,configurable:!0,writable:!0}):j[w]=S,j}function V(j){return j.width===void 0&&(j.width=j.right-j.left),j.height===void 0&&(j.height=j.bottom-j.top),j}var U=function(j){N(w,j);function w(S){var d;return _(this,w),d=u(this,g(w).call(this,S)),C(b(d),"getContainer",function(){return d.props.containment||window}),C(b(d),"addEventListener",function(R,k,M,z){d.debounceCheck||(d.debounceCheck={});var P,F,I=function(){P=null,d.check()};z>-1?F=function(){P||(P=setTimeout(I,z||0))}:F=function(){clearTimeout(P),P=setTimeout(I,M||0)};var A={target:R,fn:F,getLastTimeout:function(){return P}};R.addEventListener(k,A.fn),d.debounceCheck[k]=A}),C(b(d),"startWatching",function(){d.debounceCheck||d.interval||(d.props.intervalCheck&&(d.interval=setInterval(d.check,d.props.intervalDelay)),d.props.scrollCheck&&d.addEventListener(d.getContainer(),"scroll",d.props.scrollDelay,d.props.scrollThrottle),d.props.resizeCheck&&d.addEventListener(window,"resize",d.props.resizeDelay,d.props.resizeThrottle),!d.props.delayedCall&&d.check())}),C(b(d),"stopWatching",function(){if(d.debounceCheck){for(var R in d.debounceCheck)if(d.debounceCheck.hasOwnProperty(R)){var k=d.debounceCheck[R];clearTimeout(k.getLastTimeout()),k.target.removeEventListener(R,k.fn),d.debounceCheck[R]=null}}d.debounceCheck=null,d.interval&&(d.interval=clearInterval(d.interval))}),C(b(d),"check",function(){var R=d.node,k,M;if(!R)return d.state;if(k=V(d.roundRectDown(R.getBoundingClientRect())),d.props.containment){var z=d.props.containment.getBoundingClientRect();M={top:z.top,left:z.left,bottom:z.bottom,right:z.right}}else M={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var P=d.props.offset||{},F=E(P)==="object";F&&(M.top+=P.top||0,M.left+=P.left||0,M.bottom-=P.bottom||0,M.right-=P.right||0);var I={top:k.top>=M.top,left:k.left>=M.left,bottom:k.bottom<=M.bottom,right:k.right<=M.right},A=k.height>0&&k.width>0,$=A&&I.top&&I.left&&I.bottom&&I.right;if(A&&d.props.partialVisibility){var G=k.top<=M.bottom&&k.bottom>=M.top&&k.left<=M.right&&k.right>=M.left;typeof d.props.partialVisibility=="string"&&(G=I[d.props.partialVisibility]),$=d.props.minTopValue?G&&k.top<=M.bottom-d.props.minTopValue:G}typeof P.direction=="string"&&typeof P.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",P.direction,P.value),$=T()(P,k,M));var J=d.state;return d.state.isVisible!==$&&(J={isVisible:$,visibilityRect:I},d.setState(J),d.props.onChange&&d.props.onChange($)),J}),d.state={isVisible:null,visibilityRect:{}},d}return O(w,[{key:"componentDidMount",value:function(){this.node=m.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(d){this.node=m.a.findDOMNode(this),this.props.active&&!d.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(d){return{top:Math.floor(d.top),left:Math.floor(d.left),bottom:Math.floor(d.bottom),right:Math.floor(d.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):a.a.Children.only(this.props.children)}}]),w}(a.a.Component);C(U,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:a.a.createElement("span",null)}),C(U,"propTypes",{onChange:i.a.func,active:i.a.bool,partialVisibility:i.a.oneOfType([i.a.bool,i.a.oneOf(["top","right","bottom","left"])]),delayedCall:i.a.bool,offset:i.a.oneOfType([i.a.shape({top:i.a.number,left:i.a.number,bottom:i.a.number,right:i.a.number}),i.a.shape({direction:i.a.oneOf(["top","right","bottom","left"]),value:i.a.number})]),scrollCheck:i.a.bool,scrollDelay:i.a.number,scrollThrottle:i.a.number,resizeCheck:i.a.bool,resizeDelay:i.a.number,resizeThrottle:i.a.number,intervalCheck:i.a.bool,intervalDelay:i.a.number,containment:typeof window<"u"?i.a.instanceOf(window.Element):i.a.any,children:i.a.oneOfType([i.a.element,i.a.func]),minTopValue:i.a.number})},function(r,l,o){var t=o(6);function a(){}function v(){}v.resetWarningCache=a,r.exports=function(){function m(x,T,E,_,p,O){if(O!==t){var u=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw u.name="Invariant Violation",u}}m.isRequired=m;function y(){return m}var i={array:m,bool:m,func:m,number:m,object:m,string:m,symbol:m,any:m,arrayOf:y,element:m,elementType:m,instanceOf:y,node:m,objectOf:y,oneOf:y,oneOfType:y,shape:y,exact:y,checkPropTypes:v,resetWarningCache:a};return i.PropTypes=i,i}},function(r,l,o){var t="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";r.exports=t}])})})(X);var me=X.exports;const ge=ne(me);const xe=({src:s,alt:n})=>{const[c,h]=f.useState(!1);return f.useEffect(()=>{const r=new IntersectionObserver(o=>{o.forEach(t=>{t.isIntersecting&&(h(!0),r.unobserve(t.target))})}),l=document.getElementById(`lazyload-element-${s}`);return l&&r.observe(l),()=>{l&&r.unobserve(l)}},[s]),e.jsx("video",{id:`lazyload-element-${s}`,controls:!0,autoPlay:!1,playsInline:!0,src:c?s:"",children:n})},be=({src:s,alt:n})=>{const[c,h]=f.useState(!1);return f.useEffect(()=>{const r=new IntersectionObserver(o=>{o.forEach(t=>{t.isIntersecting&&(h(!0),r.unobserve(t.target))})}),l=document.getElementById(`lazyload-element-${s}`);return l&&r.observe(l),()=>{l&&r.unobserve(l)}},[s]),e.jsx("img",{id:`lazyload-element-${s}`,src:c?s:"",loading:"lazy",alt:n})},Z=({url:s,token:n})=>{var t;const[c,h]=f.useState(!1),[r,l]=f.useState(!1),o=((t=s.split("/").pop())==null?void 0:t.substring(23))||"File";return f.useEffect(()=>{var v;const a=(v=s.split(".").pop())==null?void 0:v.toLowerCase();h(["jpg","jpeg","png","gif","bmp","svg"].includes(a||"")),l(["mp4","webm","ogg"].includes(a||""))},[s]),c?e.jsx(be,{src:s+"?token="+n,alt:o}):r?e.jsx(xe,{src:s+"?token="+n,alt:o}):e.jsx("a",{href:s+"?token="+n,target:"_blank",rel:"noopener noreferrer",children:o})},ve=({token:s,content:n,timestamp:c,urls:h,seenList:r})=>e.jsxs("div",{className:"message out",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:n})}),e.jsx("p",{className:"message_timestamp",children:c}),h&&h.length>0&&h.map((l,o)=>e.jsx(Z,{token:s,url:l},c+o)),r&&r.length>0&&e.jsxs("p",{children:["Seen by:",r.map((l,o)=>e.jsx("span",{children:l},o))]})]}),ye=({token:s,avatarSRC:n,content:c,timestamp:h,urls:r,seenList:l})=>e.jsxs("div",{className:"message in",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:n,alt:"Sender Avatar"}),e.jsx("p",{children:c}),r&&r.length>0&&r.map((o,t)=>e.jsx(Z,{token:s,url:o},h+t))]}),e.jsx("p",{className:"message_timestamp",children:h}),l&&l.length>0&&e.jsxs("p",{children:["Seen by:",l.map((o,t)=>e.jsx("span",{children:o},t))]})]}),je=(s,n)=>{const c=n[s];return c?c.avatar:""},_e=({readCursors:s,token:n,messages:c,roomId:h,userId:r,participants:l})=>{const[o,t]=f.useState({}),a=f.useRef(c.length),v=B(),m=f.useRef({});m.current=f.useMemo(()=>Object.fromEntries(l.map(i=>[i._id,i])),[l]);const y=i=>{i[0]===h&&t(x=>({...x,[i[1]]:a.current-1}))};return f.useEffect(()=>{a.current=c.length},[c.length]),f.useEffect(()=>{if(v)return v.on("seen",y),()=>{v.off("seen",y)}},[v,h]),f.useEffect(()=>{const i={};s.filter(x=>x._id!==r).forEach(x=>{const T=new Date(x.lastReadTimeStamp).getTime();for(let E=c.length-1;E>=0;E--)if(new Date(c[E].timestamp).getTime()<=T){i[x._id]=E;break}}),t(i)},[s]),e.jsx(e.Fragment,{children:c.map((i,x)=>{let T=[];return l.forEach(E=>{o[E._id]==x&&T.push(E.fullname)}),i.sender&&i.sender===r?e.jsx(ve,{token:n,content:i.content,timestamp:i.timestamp,urls:i.urls,seenList:T},x):e.jsx(ye,{token:n,avatarSRC:je(i.sender,m.current),content:i.content,timestamp:i.timestamp,urls:i.urls,seenList:T},x)})})},we=f.memo(_e);const H=(s,n,c,h)=>fetch(`/api/v1/rooms/${s}?limit=${c}&skip=${h}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+n}}).then(r=>{if(r.status===304)throw new Error("Already got this");if(r.ok)return r.json();throw r.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),Y=30,Ee=({token:s,room:n,userId:c,justSent:h})=>{const[r,l]=f.useState([]),[o,t]=f.useState(0),[a,v]=f.useState([]),m=f.useRef(null),y=f.useRef(null),i=f.useRef(null),x=f.useRef(null),T=B(),E=W();console.log("Render container");const _=u=>{if(u[1]===n._id){const g=u[0];if(g!==c&&!n.participants.some(C=>C._id===g))return;i.current&&(i.current.style.display="block");const b=u[2],N=u[3],L=u[4];T.emit("seen",[n._id,new Date]),t(C=>C++),l(C=>C!==null?[...C,{sender:g,content:b,timestamp:N,urls:L}]:[{sender:g,content:b,timestamp:N,urls:L}])}},p=()=>{y.current&&(y.current.scrollIntoView({behavior:"smooth"}),i.current&&(i.current.style.display="none"))},O=u=>{if(!u||!r||r.length==0)return;if(r.length>=o){m.current&&(m.current.style.display="none");return}let g,b=Y;g=o-r.length-b,g<0&&(b+=g,g=0),H(n._id,s,`${b}`,`${g}`).then(N=>{x.current&&(x.current.scrollTop=300),l(L=>L?N.messages.concat(L):N.messages),N.conversationLength&&t(N.conversationLength),N.readCursors&&v(N.readCursors)}).catch(()=>{E("/auth")})};return f.useEffect(()=>{try{if(!s||!n)return;H(n._id,s).then(u=>{u.messages&&l(u.messages),u.conversationLength&&t(u.conversationLength),u.readCursors&&v(u.readCursors)}).catch(()=>{E("/auth")})}catch(u){console.error(u)}},[s,n._id]),f.useEffect(()=>{if(T)return T.on("msg",_),()=>{T.off("msg",_)}},[T,n._id]),f.useEffect(()=>{m.current&&(m.current.style.display="none");const u=setTimeout(()=>{m.current&&x.current&&x.current.scrollHeight>x.current.clientHeight&&(m.current.style.display="flex")},1e3);return()=>{clearTimeout(u)}},[n._id]),f.useEffect(()=>{if(!(!x.current||!r)){if(r.length<=Y)return p();if(Math.abs(x.current.scrollHeight-x.current.scrollTop-x.current.clientHeight)<300)return console.log("bottom"),p();if(r[r.length-1].sender==c&&h)return h=!1,p()}},[r]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:x,id:"messages-container",children:[e.jsx(ge,{onChange:O,children:e.jsx("div",{ref:m,id:"topRef",children:e.jsx(se,{size:50})})}),r&&e.jsx(we,{readCursors:a,token:s,messages:r,roomId:n._id,userId:c,participants:n.participants}),e.jsx("div",{ref:y})]}),e.jsxs("button",{id:"btn_scroll",ref:i,onClick:()=>{p()},children:[Array.isArray(r)&&r.length>1&&r[r.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const Ce=({room:s,token:n,profile:c})=>{const[h,r]=f.useState(!1),l=f.useCallback(()=>{r(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(pe,{token:n,userId:c._id,room:s}),s&&e.jsx(Ee,{justSent:h,room:s,token:n,userId:c._id}),s&&e.jsx(ce,{token:n,userId:c._id,roomId:s._id,onJustSent:l})]})},Se=s=>new Promise(async(n,c)=>{if(!window.confirm("Are you sure you want to delete your account?"))return c("Account deletion canceled");const r=window.prompt("Enter your password:");if(!r)return c("Password input canceled");try{const l={password:r},o=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(l)});if(o.ok)return sessionStorage.removeItem("token"),n("Account deletion successful");const t=await o.json();if(t.message)return c(t.message);c("Wrong password")}catch(l){c(l)}});const Te=({token:s,profileData:n,onRefresh:c})=>{const[h,r]=f.useState(!1),[l,o]=f.useState(!1),t=f.useRef(null),a=f.useRef(null),v=W(),m=B();f.useEffect(()=>{if(m)return m.on("inv",c),()=>{m.off("inv",c)}},[m]);const y=()=>{sessionStorage.removeItem("token"),v("/auth")},i=p=>{fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({action:"join"})})},x=p=>{fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({action:"refuse"})})},T=async()=>{if(!a.current)return;let p={};if(a.current.bio.value&&(p.bio=a.current.bio.value),a.current.fullname.value&&(p.fullname=a.current.fullname.value),a.current.password.value)if(p.password=a.current.password.value,a.current.current_password.value)p.current_password=a.current.current_password.value;else return alert("Please enter current password");if(t.current&&(p.avatar=t.current),!p.bio&&!p.fullname&&!p.password&&!p.avatar)return alert("Empty form");const O=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(p)});if(o(!1),O.ok)return alert("Updated successfully!"),c();const u=await O.json();if(u.message)return alert(u.message);alert("Error updating profile")},E=async p=>{const O=new FormData;O.append("file",p);const u=await fetch(`/media/${n==null?void 0:n._id}/public?token=${s}&count=1`,{method:"POST",body:O}),g=await u.json();!u.ok&&g.message&&alert(g.message),g.urls&&(t.current=g.urls[0],T())},_=async()=>{try{const p=await Se(s);alert(p),v("/auth")}catch(p){alert(p)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:n==null?void 0:n.avatar,alt:"Profile",id:"profile_img",className:"cover"}),l?e.jsx(K,{accept:"image/*",onChange:E,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:n==null?void 0:n.fullname}),(n==null?void 0:n.bio)&&e.jsx("p",{children:n==null?void 0:n.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{r(!1),o(p=>!p)},children:l?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{o(!1),r(p=>!p)},children:h?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),n!=null&&n.invitations.length&&(n==null?void 0:n.invitations.length)>0?e.jsx("span",{id:"nofcount",children:n==null?void 0:n.invitations.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:y,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${h?"active":""}`,children:n&&n.invitations.length>0?n.invitations.map(p=>e.jsxs("div",{children:[e.jsx("p",{children:p}),e.jsx("button",{onClick:()=>i(p),children:"Accept"}),e.jsx("button",{onClick:()=>x(p),children:"Refuse"})]},p)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:`profile_dropdown ${l?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:a,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:n==null?void 0:n.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:n==null?void 0:n.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:_,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:T,children:"Save"})]})]})]})},Ne=f.memo(Te);const ke=({token:s})=>{const[n,c]=f.useState([]),[h,r]=f.useState([]),l=f.useRef(null),o=i=>{if(n.some(x=>x._id==i._id))return alert("already selected this user");c(x=>[...x,i])},t=i=>{console.log("remove user from users list"),i>=0&&i<n.length&&c(x=>x.filter((E,_)=>_!==i))},a=async()=>{if(n.length==0)return alert("Please select a user");const i=n.map(x=>x._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({invited:i})})).ok?c([]):alert("deo biet sao bug luon")}catch(x){console.error(x)}},v=()=>{var x;const i=(x=l.current)==null?void 0:x.value;i&&fetch(`/api/v1/search/${i}`,{headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(T=>{if(T.ok)return T.json().then(E=>{r(E)});console.log(T.status)})},m=i=>{i.key==="Enter"&&v()},y=i=>{l.current&&!l.current.contains(i.target)&&(r([]),l.current.value="")};return f.useEffect(()=>(document.addEventListener("click",y),()=>{document.removeEventListener("click",y)}),[]),e.jsxs("div",{id:"room-maker",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{id:"search-bar",children:[e.jsx("div",{id:"chosenList",className:"flex",children:n.map((i,x)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",i.fullname]}),e.jsx("span",{onClick:()=>t(x),children:e.jsx("i",{className:"bx bx-x-circle"})})]},i.fullname))}),e.jsx("input",{type:"text",placeholder:"Search for users...",ref:l,onKeyPress:m})]}),n.length>0&&e.jsx("div",{className:"flex",children:e.jsx("button",{className:"btn",onClick:a,children:e.jsx("i",{className:"bx bxs-message-square-add ",id:"btn_createroom"})})})]}),h.length>0&&e.jsx("div",{id:"search_dropdown",children:h.map(i=>e.jsxs("div",{onClick:()=>{o({_id:i._id,fullname:i.fullname})},children:[e.jsx("img",{className:"profile-picture",src:i.avatar,alt:"Avatar"}),i.fullname]},i._id))})]})};function Oe(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const q=s=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Le=({token:s})=>{const[n,c]=f.useState(null),[h,r]=f.useState([]),[l,o]=f.useState(0),t=W(),a=async()=>{try{console.log("Loading profile again...");const y=await q(s);c(y)}catch{t("/auth")}},v=f.useCallback(y=>{o(y)},[]),m=f.useCallback(y=>{r(y)},[]);return f.useEffect(()=>{s&&q(s).then(y=>{c(y)}).catch(y=>{console.error(y),t("/auth")})},[s]),e.jsx("div",{id:"main-page",className:"flex",children:n?e.jsxs(re,{token:s,children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ne,{token:s,profileData:n,onRefresh:a}),e.jsx(ke,{token:s}),e.jsx(ae,{userId:n._id,currentRoomIndex:l,token:s,onRoomChange:v,onUpdateStatus:m})]}),e.jsx("section",{id:"section-right",children:e.jsx(Ce,{profile:n,token:s,room:h[l]})})]}),e.jsx(Oe,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})},Re=f.memo(Le);export{Re as default,q as getProfile};
