import{r as h,j as e,u as F,a as ee,c as te,g as ne,P as se}from"./index-c69b476d.js";import{u as B,S as re}from"./index-e89fb244.js";const ie=({participants:r,userId:n})=>{if(r=r.filter(s=>s._id!==n),r.length===0)return null;const l=r.length>1,f=r.slice(0,4);return e.jsx("div",{className:"card",children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:f.map((s,a)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:s.avatar,alt:"Profile",className:"group-profile-picture"})},a))}),e.jsxs("div",{className:"profile-names",children:[f.length>0&&e.jsx("h3",{children:f.map(s=>s.fullname).join(", ")}),r.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",r.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:r[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[r[0].fullname+"  ",e.jsx("span",{className:r[0].isOnline?"online":"offline",children:"â€¢"})]}),r[0].bio&&e.jsx("p",{children:r[0].bio})]})})},X=h.memo(ie);const K=r=>new Promise((n,l)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+r}}).then(f=>{if(f.ok)return f.json().then(s=>{n(s)});if(f.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(f=>{l(f)})}),oe=({userId:r,currentRoomIndex:n,token:l,onRoomChange:f,onUpdateStatus:s})=>{const[a,i]=h.useState([]),t=B(),o=F(),m=d=>{const u=d;i(b=>b&&b.map(_=>{const E=_.participants.map(C=>C._id===u?{...C,isOnline:!0}:C);return{..._,participants:E}}))},p=d=>{const u=d;i(b=>b&&b.map(_=>{const E=_.participants.map(C=>C._id===u?{...C,isOnline:!1}:C);return{..._,participants:E}}))},g=d=>{console.log("set meet"),i(u=>u&&u.map(b=>b._id===d[1]?{...b,isMeeting:!0,meeting_uuid:d[2]}:b))},x=d=>{console.log("set end meet"),i(u=>u&&u.map(b=>b._id===d[0]&&b.isMeeting?{...b,isMeeting:!1,meeting_uuid:null}:b))},P=()=>{K(l).then(d=>{i(d)}).catch(()=>{o("/auth")})},k=d=>{var b,_;const u=document.querySelectorAll(".chat-room");u==null||u.forEach(E=>{var C;(C=E.classList)==null||C.remove("active")}),(_=(b=u[d])==null?void 0:b.classList)==null||_.add("active"),f(d)};h.useEffect(()=>{a.length>0&&s(a)},[a]),h.useEffect(()=>{if(t)return t.on("onl",m),t.on("off",p),t.on("meet",g),t.on("end_meet",x),t.on("room",P),()=>{t.off("onl",m),t.off("off",p),t.off("meet",g),t.off("end_meet",x),t.off("room",P)}},[t]),h.useEffect(()=>{K(l).then(d=>{i(d)}).catch(()=>{o("/auth")})},[]);const L=async(d,u)=>{d.preventDefault();const b=d.target.value;switch(b){case"leave":return fetch(`/api/v1/rooms/${u}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+l},body:JSON.stringify({action:b})});case"delete":return fetch(`/api/v1/rooms/${u}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+l}})}},j=h.useMemo(()=>a.map((d,u)=>e.jsxs("div",{className:`chat-room ${u==n?"active":""}`,children:[e.jsx("div",{onClick:()=>k(u),children:e.jsx(X,{userId:r,participants:d.participants})}),e.jsxs("select",{onChange:b=>L(b,d._id),defaultValue:"",children:[e.jsx("option",{value:"",disabled:!0,children:"Select an option"}),e.jsx("option",{value:"delete",children:"Delete"}),e.jsx("option",{value:"leave",children:"Leave"})]})]},d._id)),[a]);return e.jsx("div",{id:"rooms-list",children:a&&a.length>0?e.jsx("div",{children:j}):e.jsx("p",{children:"No rooms to display"})})};const J=({onChange:r,accept:n,id:l,icon:f})=>{const s=h.useRef(null),a=i=>{if(i.target.files){const t=i.target.files[0];r(t)}};return e.jsxs("label",{id:`btn_${l}`,className:"btn_fileinput",htmlFor:l,children:[f,e.jsx("input",{id:l,className:"fileinput",type:"file",accept:n,ref:s,onChange:a,style:{display:"none"}})]})};const ae=({token:r,userId:n,roomId:l,onJustSent:f})=>{const[s,a]=h.useState(""),[i,t]=h.useState([]),[o,m]=h.useState([]),p=B(),g=async j=>{try{const d=new FormData;return j.forEach(_=>{d.append(`file${j.length>1?"s":""}`,_)}),await(await fetch(`/media/${n}/${l}?token=${r}&count=${j.length}`,{method:"POST",body:d})).json()}catch(d){throw d}},x=j=>{a(j.target.value),console.log("typing ...")},P=async()=>{let j=[],d=[];if(i.length>0&&(console.log(i.length),j=i,t([])),o.length>0&&(console.log(o.length),j=[...j,...o],m([])),j.length>0)try{const u=await g(j);u.urls&&(d=u.urls)}catch(u){return alert("error uploading files: "+u.message)}(s.trim()!==""||d.length!==0)&&(console.log(d),p==null||p.emit("msg",[l,s,new Date,d]),f(),a(""))},k=j=>{m(d=>[...d,j])},L=j=>{t(d=>[...d,j])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(J,{accept:"image/*",onChange:k,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(J,{accept:"*",onChange:L,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),o.length>0&&e.jsx("div",{children:o.map((j,d)=>e.jsx("span",{children:j.name},d))}),i.length>0&&e.jsx("div",{children:i.map((j,d)=>e.jsx("span",{children:j.name},d))}),e.jsx("input",{type:"text",value:s,id:"input_message",onChange:x,onKeyDown:j=>{j.key=="Enter"&&P()}}),e.jsx("button",{onClick:P,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},le=h.memo(ae);const ce={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},ue=()=>{const[r,n]=h.useState(sessionStorage.getItem("theme")||"light");return h.useEffect(()=>{const l=ce[r];Object.entries(l).forEach(([f,s])=>{document.documentElement.style.setProperty(`--${f}-color`,s)}),sessionStorage.setItem("theme",r)},[r]),[r,n]},de=()=>{const[r,n]=ue(),l=r==="light",f=()=>{n(l?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:l,onChange:f}),e.jsxs("label",{className:`switcher-label ${l?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const fe=({token:r,room:n,userId:l})=>{const f=B(),s=()=>{f.emit("meet",[n._id,new Date])},a=t=>{const o=`/meet/${t}?token=${r}&room=${n._id}`;window.open(o)},i=t=>{if(console.log(t),t[0]==l)return t[3]?void 0:a(t[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{a(t[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&i(t)})};return n&&h.useEffect(()=>{if(f)return f.on("meet",i),()=>{f.off("meet",i)}},[f,n._id]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[n&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:l,participants:n.participants}),n.isMeeting&&n.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>a(n.meeting_uuid),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:s,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(de,{})]})},he=h.memo(fe);var q={exports:{}};(function(r,n){(function(f,s){r.exports=s(h,ee)})(te,function(l,f){return function(s){var a={};function i(t){if(a[t])return a[t].exports;var o=a[t]={i:t,l:!1,exports:{}};return s[t].call(o.exports,o,o.exports,i),o.l=!0,o.exports}return i.m=s,i.c=a,i.d=function(t,o,m){i.o(t,o)||Object.defineProperty(t,o,{enumerable:!0,get:m})},i.r=function(t){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,o){if(o&1&&(t=i(t)),o&8||o&4&&typeof t=="object"&&t&&t.__esModule)return t;var m=Object.create(null);if(i.r(m),Object.defineProperty(m,"default",{enumerable:!0,value:t}),o&2&&typeof t!="string")for(var p in t)i.d(m,p,(function(g){return t[g]}).bind(null,p));return m},i.n=function(t){var o=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(o,"a",o),o},i.o=function(t,o){return Object.prototype.hasOwnProperty.call(t,o)},i.p="",i(i.s=4)}([function(s,a,i){s.exports=i(5)()},function(s,a){s.exports=l},function(s,a){s.exports=f},function(s,a){s.exports=function(i,t,o){var m=i.direction,p=i.value;switch(m){case"top":return o.top+p<t.top&&o.bottom>t.bottom&&o.left<t.left&&o.right>t.right;case"left":return o.left+p<t.left&&o.bottom>t.bottom&&o.top<t.top&&o.right>t.right;case"bottom":return o.bottom-p>t.bottom&&o.left<t.left&&o.right>t.right&&o.top<t.top;case"right":return o.right-p>t.right&&o.left<t.left&&o.top<t.top&&o.bottom>t.bottom}}},function(s,a,i){i.r(a),i.d(a,"default",function(){return V});var t=i(1),o=i.n(t),m=i(2),p=i.n(m),g=i(0),x=i.n(g),P=i(3),k=i.n(P);function L(v){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?L=function(w){return typeof w}:L=function(w){return w&&typeof Symbol=="function"&&w.constructor===Symbol&&w!==Symbol.prototype?"symbol":typeof w},L(v)}function j(v,y){if(!(v instanceof y))throw new TypeError("Cannot call a class as a function")}function d(v,y){for(var w=0;w<y.length;w++){var c=y[w];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(v,c.key,c)}}function u(v,y,w){return y&&d(v.prototype,y),w&&d(v,w),v}function b(v,y){return y&&(L(y)==="object"||typeof y=="function")?y:E(v)}function _(v){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(w){return w.__proto__||Object.getPrototypeOf(w)},_(v)}function E(v){if(v===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return v}function C(v,y){if(typeof y!="function"&&y!==null)throw new TypeError("Super expression must either be null or a function");v.prototype=Object.create(y&&y.prototype,{constructor:{value:v,writable:!0,configurable:!0}}),y&&A(v,y)}function A(v,y){return A=Object.setPrototypeOf||function(c,N){return c.__proto__=N,c},A(v,y)}function R(v,y,w){return y in v?Object.defineProperty(v,y,{value:w,enumerable:!0,configurable:!0,writable:!0}):v[y]=w,v}function Z(v){return v.width===void 0&&(v.width=v.right-v.left),v.height===void 0&&(v.height=v.bottom-v.top),v}var V=function(v){C(y,v);function y(w){var c;return j(this,y),c=b(this,_(y).call(this,w)),R(E(c),"getContainer",function(){return c.props.containment||window}),R(E(c),"addEventListener",function(N,S,T,$){c.debounceCheck||(c.debounceCheck={});var O,z,M=function(){O=null,c.check()};$>-1?z=function(){O||(O=setTimeout(M,$||0))}:z=function(){clearTimeout(O),O=setTimeout(M,T||0)};var U={target:N,fn:z,getLastTimeout:function(){return O}};N.addEventListener(S,U.fn),c.debounceCheck[S]=U}),R(E(c),"startWatching",function(){c.debounceCheck||c.interval||(c.props.intervalCheck&&(c.interval=setInterval(c.check,c.props.intervalDelay)),c.props.scrollCheck&&c.addEventListener(c.getContainer(),"scroll",c.props.scrollDelay,c.props.scrollThrottle),c.props.resizeCheck&&c.addEventListener(window,"resize",c.props.resizeDelay,c.props.resizeThrottle),!c.props.delayedCall&&c.check())}),R(E(c),"stopWatching",function(){if(c.debounceCheck){for(var N in c.debounceCheck)if(c.debounceCheck.hasOwnProperty(N)){var S=c.debounceCheck[N];clearTimeout(S.getLastTimeout()),S.target.removeEventListener(N,S.fn),c.debounceCheck[N]=null}}c.debounceCheck=null,c.interval&&(c.interval=clearInterval(c.interval))}),R(E(c),"check",function(){var N=c.node,S,T;if(!N)return c.state;if(S=Z(c.roundRectDown(N.getBoundingClientRect())),c.props.containment){var $=c.props.containment.getBoundingClientRect();T={top:$.top,left:$.left,bottom:$.bottom,right:$.right}}else T={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var O=c.props.offset||{},z=L(O)==="object";z&&(T.top+=O.top||0,T.left+=O.left||0,T.bottom-=O.bottom||0,T.right-=O.right||0);var M={top:S.top>=T.top,left:S.left>=T.left,bottom:S.bottom<=T.bottom,right:S.right<=T.right},U=S.height>0&&S.width>0,I=U&&M.top&&M.left&&M.bottom&&M.right;if(U&&c.props.partialVisibility){var W=S.top<=T.bottom&&S.bottom>=T.top&&S.left<=T.right&&S.right>=T.left;typeof c.props.partialVisibility=="string"&&(W=M[c.props.partialVisibility]),I=c.props.minTopValue?W&&S.top<=T.bottom-c.props.minTopValue:W}typeof O.direction=="string"&&typeof O.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",O.direction,O.value),I=k()(O,S,T));var G=c.state;return c.state.isVisible!==I&&(G={isVisible:I,visibilityRect:M},c.setState(G),c.props.onChange&&c.props.onChange(I)),G}),c.state={isVisible:null,visibilityRect:{}},c}return u(y,[{key:"componentDidMount",value:function(){this.node=p.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(c){this.node=p.a.findDOMNode(this),this.props.active&&!c.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(c){return{top:Math.floor(c.top),left:Math.floor(c.left),bottom:Math.floor(c.bottom),right:Math.floor(c.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):o.a.Children.only(this.props.children)}}]),y}(o.a.Component);R(V,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:o.a.createElement("span",null)}),R(V,"propTypes",{onChange:x.a.func,active:x.a.bool,partialVisibility:x.a.oneOfType([x.a.bool,x.a.oneOf(["top","right","bottom","left"])]),delayedCall:x.a.bool,offset:x.a.oneOfType([x.a.shape({top:x.a.number,left:x.a.number,bottom:x.a.number,right:x.a.number}),x.a.shape({direction:x.a.oneOf(["top","right","bottom","left"]),value:x.a.number})]),scrollCheck:x.a.bool,scrollDelay:x.a.number,scrollThrottle:x.a.number,resizeCheck:x.a.bool,resizeDelay:x.a.number,resizeThrottle:x.a.number,intervalCheck:x.a.bool,intervalDelay:x.a.number,containment:typeof window<"u"?x.a.instanceOf(window.Element):x.a.any,children:x.a.oneOfType([x.a.element,x.a.func]),minTopValue:x.a.number})},function(s,a,i){var t=i(6);function o(){}function m(){}m.resetWarningCache=o,s.exports=function(){function p(P,k,L,j,d,u){if(u!==t){var b=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw b.name="Invariant Violation",b}}p.isRequired=p;function g(){return p}var x={array:p,bool:p,func:p,number:p,object:p,string:p,symbol:p,any:p,arrayOf:g,element:p,elementType:p,instanceOf:g,node:p,objectOf:g,oneOf:g,oneOfType:g,shape:g,exact:g,checkPropTypes:m,resetWarningCache:o};return x.PropTypes=x,x}},function(s,a,i){var t="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";s.exports=t}])})})(q);var pe=q.exports;const me=ne(pe);const ge=({src:r,alt:n})=>{const[l,f]=h.useState(!1);return h.useEffect(()=>{const s=new IntersectionObserver(i=>{i.forEach(t=>{t.isIntersecting&&(f(!0),s.unobserve(t.target))})}),a=document.getElementById(`lazyload-element-${r}`);return a&&s.observe(a),()=>{a&&s.unobserve(a)}},[r]),e.jsx("video",{id:`lazyload-element-${r}`,controls:!0,autoPlay:!1,playsInline:!0,src:l?r:"",children:n})},xe=({src:r,alt:n})=>{const[l,f]=h.useState(!1);return h.useEffect(()=>{const s=new IntersectionObserver(i=>{i.forEach(t=>{t.isIntersecting&&(f(!0),s.unobserve(t.target))})}),a=document.getElementById(`lazyload-element-${r}`);return a&&s.observe(a),()=>{a&&s.unobserve(a)}},[r]),e.jsx("img",{id:`lazyload-element-${r}`,src:l?r:"",loading:"lazy",alt:n})},Q=({url:r,token:n})=>{var t;const[l,f]=h.useState(!1),[s,a]=h.useState(!1),i=((t=r.split("/").pop())==null?void 0:t.substring(23))||"File";return h.useEffect(()=>{var m;const o=(m=r.split(".").pop())==null?void 0:m.toLowerCase();f(["jpg","jpeg","png","gif","bmp","svg"].includes(o||"")),a(["mp4","webm","ogg"].includes(o||""))},[r]),l?e.jsx(xe,{src:r+"?token="+n,alt:i}):s?e.jsx(ge,{src:r+"?token="+n,alt:i}):e.jsx("a",{href:r+"?token="+n,target:"_blank",rel:"noopener noreferrer",children:i})},be=({token:r,content:n,timestamp:l,urls:f})=>e.jsxs("div",{className:"message own",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:n})}),e.jsx("p",{className:"message_timestamp",children:l}),f&&f.length>0&&f.map((s,a)=>e.jsx(Q,{token:r,url:s},l+a))]}),ve=({token:r,avatarSRC:n,content:l,timestamp:f,urls:s})=>e.jsxs("div",{className:"message guest",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:n,alt:"Sender Avatar"}),e.jsx("p",{children:l}),s&&s.length>0&&s.map((a,i)=>e.jsx(Q,{token:r,url:a},f+i))]}),e.jsx("p",{className:"message_timestamp",children:f})]}),ye=({token:r,messages:n,userId:l,participants:f})=>e.jsx(e.Fragment,{children:Array.isArray(n)&&n.map((s,a)=>{if(s.sender&&s.sender==l)return e.jsx(be,{token:r,content:s.content,timestamp:s.timestamp,urls:s.urls},a);{const i=f.find(o=>o._id===s.sender),t=i?i.avatar:"";return e.jsx(ve,{token:r,avatarSRC:t,content:s.content,timestamp:s.timestamp,urls:s.urls},a)}})}),je=h.memo(ye);const H=(r,n,l,f)=>fetch(`/api/v1/rooms/${r}?limit=${l}&skip=${f}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+n}}).then(s=>{if(s.status===304)throw new Error("Already got this");if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),D=30,_e=({token:r,room:n,userId:l,justSent:f})=>{const[s,a]=h.useState([]),[i,t]=h.useState(0),o=h.useRef(null),m=h.useRef(null),p=h.useRef(null),g=h.useRef(null),x=B(),P=F();console.log("Render container");const k=d=>{if(d[1]===n._id){const u=d[0];if(u!==l&&!n.participants.some(C=>C._id===u))return;p.current&&(p.current.style.display="block");const b=d[2],_=d[3],E=d[4];t(C=>C++),a(C=>C!==null?[...C,{sender:u,content:b,timestamp:_,urls:E}]:[{sender:u,content:b,timestamp:_,urls:E}])}},L=()=>{m.current&&(m.current.scrollIntoView({behavior:"smooth"}),p.current&&(p.current.style.display="none"))},j=d=>{if(!d||!s||s.length==0)return;if(s.length>=i){o.current&&(o.current.style.display="none");return}let u,b=D;u=i-s.length-b,u<0&&(b+=u,u=0),H(n._id,r,`${b}`,`${u}`).then(_=>{g.current&&(g.current.scrollTop=300),a(E=>E?_.messages.concat(E):_.messages),_.conversationLength&&t(_.conversationLength)}).catch(()=>{P("/auth")})};return h.useEffect(()=>{try{if(!r||!n)return;H(n._id,r).then(d=>{a(d.messages),d.conversationLength&&t(d.conversationLength)}).catch(()=>{P("/auth")})}catch(d){console.error(d)}},[r,n._id]),h.useEffect(()=>{if(x)return x.on("msg",k),()=>{x.off("msg",k)}},[x,n._id]),h.useEffect(()=>{o.current&&(o.current.style.display="none");const d=setTimeout(()=>{o.current&&g.current&&g.current.scrollHeight>g.current.clientHeight&&(o.current.style.display="flex")},1e3);return()=>{clearTimeout(d)}},[n._id]),h.useEffect(()=>{if(!(!g.current||!s)){if(s.length<=D)return L();if(Math.abs(g.current.scrollHeight-g.current.scrollTop-g.current.clientHeight)<300)return console.log("bottom"),L();if(s[s.length-1].sender==l&&f)return f=!1,L()}},[s]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:g,id:"messages-container",children:[e.jsx(me,{onChange:j,children:e.jsx("div",{ref:o,id:"topRef",children:e.jsx(se,{size:50})})}),s&&e.jsx(je,{token:r,messages:s,userId:l,participants:n.participants}),e.jsx("div",{ref:m})]}),e.jsxs("button",{id:"btn_scroll",ref:p,onClick:()=>{L()},children:[Array.isArray(s)&&s.length>1&&s[s.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const we=({room:r,token:n,profile:l})=>{const[f,s]=h.useState(!1),a=h.useCallback(()=>{s(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(he,{token:n,userId:l._id,room:r}),r&&e.jsx(_e,{justSent:f,room:r,token:n,userId:l._id}),r&&e.jsx(le,{token:n,userId:l._id,roomId:r._id,onJustSent:a})]})},Ee=r=>new Promise(async(n,l)=>{if(!window.confirm("Are you sure you want to delete your account?"))return l("Account deletion canceled");const s=window.prompt("Enter your password:");if(!s)return l("Password input canceled");try{const a={password:s},i=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify(a)});if(i.ok)return sessionStorage.removeItem("token"),n("Account deletion successful");const t=await i.json();if(t.message)return l(t.message);l("Wrong password")}catch(a){l(a)}});const Se=({token:r,profileData:n,onRefresh:l})=>{const[f,s]=h.useState(!1),[a,i]=h.useState(!1),t=h.useRef(null),o=h.useRef(null),m=h.useRef(null),p=F(),g=B();h.useEffect(()=>{if(g)return g.on("inv",l),()=>{g.off("inv",l)}},[g]),h.useEffect(()=>{o.current&&(a?o.current.classList.add("active"):o.current.classList.remove("active"))},[a]);const x=()=>{sessionStorage.removeItem("token"),p("/auth")},P=u=>{fetch(`/api/v1/rooms/${u}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({action:"join"})})},k=u=>{fetch(`/api/v1/rooms/${u}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({action:"refuse"})})},L=async()=>{if(!m.current)return;let u={};if(m.current.bio.value&&(u.bio=m.current.bio.value),m.current.fullname.value&&(u.fullname=m.current.fullname.value),m.current.password.value)if(u.password=m.current.password.value,m.current.current_password.value)u.current_password=m.current.current_password.value;else return alert("Please enter current password");if(t.current&&(u.avatar=t.current),!u.bio&&!u.fullname&&!u.password&&!u.avatar)return alert("Empty form");const b=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify(u)});if(i(!1),b.ok)return alert("Updated successfully!"),l();const _=await b.json();if(_.message)return alert(_.message);alert("Error updating profile")},j=async u=>{const b=new FormData;b.append("file",u);const _=await fetch(`/media/${n==null?void 0:n._id}/public?token=${r}&count=1`,{method:"POST",body:b}),E=await _.json();!_.ok&&E.message&&alert(E.message),E.urls&&(t.current=E.urls[0],L())},d=async()=>{try{const u=await Ee(r);alert(u),p("/auth")}catch(u){alert(u)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:n==null?void 0:n.avatar,alt:"Profile",id:"profile_img",className:"cover"}),a?e.jsx(J,{accept:"image/*",onChange:j,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:n==null?void 0:n.fullname}),(n==null?void 0:n.bio)&&e.jsx("p",{children:n==null?void 0:n.bio})]}),e.jsxs("div",{className:"flex",children:[a?e.jsx("button",{className:"btn",onClick:()=>i(!1),children:e.jsx("i",{className:"bx bxs-message-square-x"})}):e.jsx("button",{className:"btn",onClick:()=>i(!0),children:e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>s(u=>!u),children:f?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),n!=null&&n.invitations.length&&(n==null?void 0:n.invitations.length)>0?e.jsx("span",{id:"nofcount",children:n==null?void 0:n.invitations.length}):null]})}),f&&e.jsx("div",{id:"notify-container",children:n&&n.invitations.length>0?n.invitations.map(u=>e.jsxs("div",{children:[e.jsx("p",{children:u}),e.jsx("button",{onClick:()=>P(u),children:"Accept"}),e.jsx("button",{onClick:()=>k(u),children:"Refuse"})]},u)):e.jsx("p",{children:"No invitations"})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:x,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsxs("div",{ref:o,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:m,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:n==null?void 0:n.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:n==null?void 0:n.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:d,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:L,children:"Save"})]})]})]})},Ce=h.memo(Se);const Le=({token:r,onChoose:n})=>{const l=h.useRef(null),[f,s]=h.useState([]),a=()=>{var m;const o=(m=l.current)==null?void 0:m.value;o&&fetch(`/api/v1/search/${o}`,{headers:{"content-type":"application/json",authorization:"Bearer "+r}}).then(p=>{if(p.ok)return p.json().then(g=>{s(g)});console.log(p.status)})},i=o=>{o.key==="Enter"&&a()},t=o=>{l.current&&!l.current.contains(o.target)&&(s([]),l.current.value="")};return h.useEffect(()=>(document.addEventListener("click",t),()=>{document.removeEventListener("click",t)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:l,onKeyPress:i}),e.jsx("button",{className:"btn",onClick:a,children:e.jsx("i",{className:"bx bx-search"})}),f.length>0&&e.jsx("div",{id:"search_dropdown",children:f.map(o=>e.jsxs("div",{onClick:()=>{n({_id:o._id,fullname:o.fullname})},children:[e.jsx("img",{className:"profile-picture",src:o.avatar,alt:"Avatar"}),o.fullname]},o._id))})]})};const Te=({token:r})=>{const[n,l]=h.useState([]),f=i=>{if(n.some(t=>t._id==i._id))return alert("already selected this user");l(t=>[...t,i])},s=i=>{console.log("remove user from users list"),i>=0&&i<n.length&&l(t=>t.filter((m,p)=>p!==i))},a=async()=>{if(n.length==0)return alert("Please select a user");const i=n.map(t=>t._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({invited:i})})).ok?l([]):alert("deo biet sao bug luon")}catch(t){console.error(t)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(Le,{token:r,onChoose:f}),n.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:n.map((i,t)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",i.fullname]}),e.jsx("span",{onClick:()=>s(t),children:"X"})]},i.fullname))}),e.jsx("button",{className:"btn",onClick:a,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})};function Oe(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const Y=r=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+r}}).then(n=>{if(n.ok)return n.json();throw n.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),ke=({token:r})=>{const[n,l]=h.useState(null),[f,s]=h.useState([]),[a,i]=h.useState(0),t=F(),o=async()=>{try{console.log("Loading profile again...");const g=await Y(r);l(g)}catch{t("/auth")}},m=g=>{i(g)},p=g=>{s(g)};return h.useEffect(()=>{r&&Y(r).then(g=>{l(g)}).catch(g=>{console.error(g),t("/auth")})},[r]),e.jsx("div",{id:"main-page",className:"flex",children:n?e.jsxs(re,{token:r,children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ce,{token:r,profileData:n,onRefresh:o}),e.jsx(Te,{token:r}),e.jsx(oe,{userId:n._id,currentRoomIndex:a,token:r,onRoomChange:m,onUpdateStatus:p})]}),e.jsx("section",{id:"section-right",children:e.jsx(we,{profile:n,token:r,room:f[a]})})]}),e.jsx(Oe,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{ke as default,Y as getProfile};
