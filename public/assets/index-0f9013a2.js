import{r as a,j as e,u as I}from"./index-045b2637.js";import{g as P}from"./getSocket-3ac81373.js";const z=({participants:s,userId:t})=>{if(s=s.filter(x=>x._id!==t),s.length==0)return null;const r=s.length>1,o=s.slice(0,4);return e.jsx("div",{className:"card",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:o.map((x,m)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:x.avatar,alt:"Profile",className:"group-profile-picture"})},m))}),e.jsxs("div",{className:"profile-names",children:[o.length>0&&e.jsx("h3",{children:o.map(x=>x.fullname).join(", ")}),s.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",s.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[s[0].fullname+"  ",e.jsx("span",{className:s[0].isOnline?"online":"offline",children:"â€¢"})]}),s[0].bio&&e.jsx("p",{children:s[0].bio})]})})},F=a.memo(z);const M=s=>new Promise((t,r)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(o=>{if(o.ok)return o.json().then(x=>{t(x)});throw o.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(o=>{r(o)})}),U=({userId:s,currentRoomIndex:t,token:r,onRoomChange:o,onUpdateStatus:x})=>{const[m,l]=a.useState([]),c=a.useRef(""),d=a.useRef(null),w=I(),f=g=>{const h=g;"onl"+h!=c.current&&(c.current="onl"+h,l(i=>i&&i.map(u=>{const v=u.participants.map(n=>n._id===h?{...n,isOnline:!0}:n);return{...u,participants:v}})))},p=g=>{const h=g;"off"+h!=c.current&&(c.current="off"+h,l(i=>i&&i.map(u=>{const v=u.participants.map(n=>n._id===h?{...n,isOnline:!1}:n);return{...u,participants:v}})))},R=()=>{M(r).then(g=>{l(g)}).catch(()=>{w("/auth")})},S=g=>{var i,u;const h=document.querySelectorAll(".chat-room");h==null||h.forEach(v=>{var n;(n=v.classList)==null||n.remove("active")}),(u=(i=h[g])==null?void 0:i.classList)==null||u.add("active"),o(g)};a.useEffect(()=>{m.length>0&&x(m)},[m]),a.useEffect(()=>(r&&M(r).then(g=>{l(g);const h=P(r);h.on("onl",f),h.on("off",p),h.on("room",R),d.current=h}).catch(()=>{w("/auth")}),()=>{var g;(g=d.current)==null||g.disconnect()}),[r]);const C=a.useMemo(()=>m.map((g,h)=>e.jsx("div",{className:`chat-room ${h==t?"active":""}`,onClick:()=>S(h),children:e.jsx(F,{userId:s,participants:g.participants})},g._id)),[m]);return e.jsx("div",{id:"rooms-list",children:m&&m.length>0?e.jsx("div",{children:C}):e.jsx("p",{children:"No rooms to display"})})};const B={light:{text:"#000",background:"#ffffff",theme:"#046d8c"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},O=()=>{const[s,t]=a.useState(sessionStorage.getItem("theme")||"light");return a.useEffect(()=>{const r=B[s];Object.entries(r).forEach(([o,x])=>{document.documentElement.style.setProperty(`--${o}-color`,x)}),sessionStorage.setItem("theme",s)},[s]),[s,t]},A=()=>{const[s,t]=O(),r=s==="light",o=()=>{t(r?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:r,onChange:o}),e.jsxs("label",{className:`switcher-label ${r?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})},G=(s,t)=>fetch(`/api/v1/rooms/${s}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(r=>{if(r.ok)return r.json();throw r.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let b;const J=({room:s,token:t,profile:r})=>{const[o,x]=a.useState(""),[m,l]=a.useState(null),[c,d]=a.useState(),w=a.useRef(s._id),f=a.useRef(null),p=I(),R=n=>{x(n.target.value),console.log("typing ...")},S=()=>{o.trim()!==""&&(b==null||b.emit("msg",[s._id,o,new Date]),x(""))},C=n=>{if(n[1]===w.current){const j=n[0];if(j!==(r==null?void 0:r._id)&&!s.participants.some(N=>N._id===j))return;const y=n[2],_=n[3];l(N=>N!==null?[...N,{sender:j,content:y,timestamp:_}]:[{sender:j,content:y,timestamp:_}])}else console.log("New message, room: "+n[1])},g=()=>{b==null||b.emit("meet",[s._id,new Date])},h=n=>{const j=`/meet/${n}?token=${t}&room=${s._id}`;window.open(j)},i=n=>{if(n[1]==s._id&&d(n[2]),n[0]==(r==null?void 0:r._id))return n[3]?void 0:h(n[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{h(n[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(j=>{j==="granted"&&i(n)})},u=()=>{d(null)};a.useEffect(()=>{try{if(!t||!s)return;G(s._id,t).then(n=>{l(n.messages),n.meeting_uuid?d(n.meeting_uuid):d(null)}).catch(()=>{p("/auth")})}catch(n){console.error(n)}},[t,s._id]),a.useEffect(()=>{t&&(b=P(t),b==null||b.on("msg",C),b==null||b.on("meet",i),b==null||b.on("end_meet",u))},[t]),a.useEffect(()=>{w.current=s._id},[s._id]),a.useEffect(()=>{function n(){f.current&&(console.log(f.current.scrollTop),console.log(f.current.scrollHeight),console.log(f.current.clientHeight))}return f.current&&(console.log(f.current),f.current.addEventListener("scroll",n)),()=>{f.current&&f.current.removeEventListener("scroll",n)}},[]);const v=a.useMemo(()=>e.jsx(e.Fragment,{children:Array.isArray(m)&&m.reverse().map((n,j)=>{let y;if(n.sender&&n.sender==(r==null?void 0:r._id))y=r.avatar;else{const _=s.participants.find(N=>N._id===n.sender);y=_?_.avatar:""}return e.jsxs("div",{className:`message ${n.sender==(r==null?void 0:r._id)?"own":""}`,children:[e.jsxs("div",{className:"message_wrapper",children:[n.sender!=(r==null?void 0:r._id)&&y&&e.jsx("img",{className:"inchat-avatar",src:y,alt:"Sender Avatar"}),e.jsx("p",{children:n.content})]}),e.jsx("p",{className:"message_timestamp",children:n.timestamp})]},j)})}),[m]);return e.jsxs("div",{id:"chat-box",children:[e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(F,{userId:r==null?void 0:r._id,participants:s.participants}),e.jsx("button",{className:"btn",onClick:g,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(A,{})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>h(c),children:"Join"})]}),e.jsx("div",{ref:f,id:"messages-container",children:v}),e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx("input",{type:"text",value:o,id:"input_message",onChange:R,onKeyDown:n=>{n.key=="Enter"&&S()}}),e.jsx("button",{onClick:S,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]}),e.jsx("img",{id:"chat-bg",src:"/assets/img/img_new/pattern.png"})]})};const q=({token:s,profileData:t,onRefresh:r})=>{const[o,x]=a.useState(!1),[m,l]=a.useState(!1),c=a.useRef(null),d=a.useRef(null),w=a.useRef(null),f=I();a.useEffect(()=>{if(s){const i=P(s);i.on("inv",r),w.current=i}return()=>{var i;(i=w.current)==null||i.disconnect()}},[s]);const p=()=>{sessionStorage.removeItem("token"),f("/auth")},R=i=>{fetch(`/api/v1/rooms/${i}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({accept:!0})})},S=i=>{fetch(`/api/v1/rooms/${i}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({accept:!1})})},C=async i=>{i.preventDefault();let u={};if(i.target.bio.value&&(u.bio=i.target.bio.value),i.target.fullname.value&&(u.fullname=i.target.fullname.value),i.target.password.value)if(u.password=i.target.password.value,i.target.current_password.value)u.current_password=i.target.current_password.value;else return alert("Please enter current password");if(d.current&&(u.avatar=d.current),!u.bio&&!u.fullname&&!u.password&&!u.avatar)return alert("Empty form");const v=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(u)});if(l(!1),v.ok)return alert("Updated successfully!"),r();const n=await v.json();if(n.message)return alert(n.message);alert("Error updating profile")},g=async()=>{if(window.confirm("Are you sure you want to delete your account?")){const u=window.prompt("Enter your password:");if(u!==null)try{const v={password:u},n=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(v)});if(n.ok)sessionStorage.removeItem("token"),alert("You deleted your account successfully"),f("/auth");else{const j=await n.json();j.message?alert(j.message):alert("Wrong password!")}}catch(v){console.error("Error deleting account:",v)}}},h=()=>{if(c!=null&&c.current&&c.current.length>0){const i=c.current.files[0],u=new FileReader;u.onload=async v=>{var n;if((n=v.target)!=null&&n.result){const j=new Image;j.onload=async()=>{const y=document.createElement("canvas"),_=200,N=200;let L=j.width,E=j.height;L>_&&(E*=_/L,L=_),E>N&&(L*=N/E,E=N),y.width=L,y.height=E;const k=y.getContext("2d");k==null||k.drawImage(j,0,0,L,E);const $=y.toDataURL("image/jpeg");d.current=$},j.src=v.target.result}},u.readAsDataURL(i)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:t==null?void 0:t.avatar,alt:"Profile",id:"profile_img",className:"cover"}),m?e.jsxs(e.Fragment,{children:[e.jsxs("label",{id:"btn_upload-img",htmlFor:"upload-img",children:[e.jsx("i",{className:"bx bxs-camera"}),e.jsx("input",{id:"upload-img",type:"file",accept:"image/*",ref:c,onChange:h})]}),e.jsx("button",{className:"btn",onClick:()=>l(!1),children:e.jsx("i",{className:"bx bxs-pencil"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h3",{children:t==null?void 0:t.fullname}),(t==null?void 0:t.bio)&&e.jsx("p",{children:t==null?void 0:t.bio})]}),e.jsx("button",{className:"btn",onClick:()=>l(!0),children:e.jsx("i",{className:"bx bxs-pencil"})})]}),e.jsx("button",{className:"btn",onClick:()=>x(i=>!i),children:o?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t!=null&&t.invitations.length&&(t==null?void 0:t.invitations.length)>0?e.jsx("span",{id:"nofcount",children:t==null?void 0:t.invitations.length}):null]})}),o&&e.jsx("div",{id:"notify-container",children:t&&t.invitations.length>0?t.invitations.map(i=>e.jsxs("div",{children:[e.jsx("p",{children:i}),e.jsx("button",{onClick:()=>R(i),children:"Accept"}),e.jsx("button",{onClick:()=>S(i),children:"Refuse"})]},i)):e.jsx("p",{children:"No invitations"})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:p,children:e.jsx("i",{className:"bx bx-log-in"})})]}),m&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:C,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]}),e.jsx("button",{type:"submit",children:"Save"})]}),e.jsx("button",{onClick:g,children:"Delete account"})]})]})},H=a.memo(q);const K=({token:s,onChoose:t})=>{const r=a.useRef(null),[o,x]=a.useState([]),m=()=>{var w;const d=(w=r.current)==null?void 0:w.value;d&&fetch(`/api/v1/search/${d}`,{headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(f=>{if(f.ok)return f.json().then(p=>{x(p)});console.log(f.status)})},l=d=>{d.key==="Enter"&&m()},c=d=>{r.current&&!r.current.contains(d.target)&&(x([]),r.current.value="")};return a.useEffect(()=>(document.addEventListener("click",c),()=>{document.removeEventListener("click",c)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:r,onKeyPress:l}),e.jsx("button",{className:"btn",onClick:m,children:e.jsx("i",{className:"bx bx-search"})}),o.length>0&&e.jsx("div",{id:"search_dropdown",children:o.map(d=>e.jsxs("div",{onClick:()=>{t({_id:d._id,fullname:d.fullname})},children:[e.jsx("img",{className:"profile-picture",src:d.avatar,alt:"Avatar"}),d.fullname]},d._id))})]})};const Y=({token:s})=>{const[t,r]=a.useState([]),o=l=>{if(t.some(c=>c._id==l._id))return alert("already selected this user");r(c=>[...c,l])},x=l=>{console.log("remove user from users list"),l>=0&&l<t.length&&r(c=>c.filter((w,f)=>f!==l))},m=async()=>{if(t.length==0)return alert("Please select a user");const l=t.map(c=>c._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({invited:l})})).ok?r([]):alert("deo biet sao bug luon")}catch(c){console.error(c)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(K,{token:s,onChoose:o}),t.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:t.map((l,c)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",l.fullname]}),e.jsx("span",{onClick:()=>x(c),children:"X"})]},l.fullname))}),e.jsx("button",{className:"btn",onClick:m,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})};function V(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const T=s=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(t=>{if(t.ok)return t.json();throw t.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Q=({token:s})=>{const[t,r]=a.useState(null),[o,x]=a.useState([]),[m,l]=a.useState(0),c=I(),d=async()=>{try{const p=await T(s);r(p)}catch{c("/auth")}},w=p=>{l(p)},f=p=>{x(p)};return a.useEffect(()=>{s&&T(s).then(p=>{r(p)}).catch(p=>{console.error(p),c("/auth")})},[s]),e.jsx("div",{id:"main-page",className:"flex",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(H,{token:s,profileData:t,onRefresh:d}),e.jsx(Y,{token:s}),e.jsx(U,{userId:t._id,currentRoomIndex:m,token:s,onRoomChange:w,onUpdateStatus:f})]}),e.jsx("section",{id:"section-right",children:o.length>0&&e.jsx(J,{profile:t,token:s,room:o[m]})})]}),e.jsx(V,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{Q as default,T as getProfile};
