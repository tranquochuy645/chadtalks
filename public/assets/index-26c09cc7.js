import{j as e,r as l,u as C}from"./index-2de14357.js";import{g as k}from"./getSocket-8aa47fbe.js";const A=({participants:s,userId:t})=>{if(s=s.filter(m=>m._id!==t),s.length==0)return null;const r=s.length>1,c=s.slice(0,4);return e.jsx("div",{className:"user-card",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:c.map((m,x)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:m.avatar,alt:"Profile",className:"group-profile-picture"})},x))}),e.jsxs("div",{className:"profile-names",children:[c.length>0&&e.jsx("h3",{children:c.map(m=>m.fullname).join(", ")}),s.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",s.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:s[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("div",{className:"user-info ",children:[e.jsxs("h3",{children:[s[0].fullname+"  ",e.jsx("span",{className:s[0].isOnline?"online":"offline",children:"â€¢"})]}),s[0].bio&&e.jsx("p",{children:s[0].bio})]})]})})};const F=s=>new Promise((t,r)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(c=>{if(c.ok)return c.json().then(m=>{t(m)});throw c.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(c=>{r(c)})}),O=({userId:s,currentRoomIndex:t,token:r,onRoomChange:c,onUpdateStatus:m})=>{const[x,u]=l.useState([]),a=l.useRef(""),f=l.useRef(null),b=C(),v=d=>{const o=d;"onl"+o!=a.current&&(a.current="onl"+o,u(n=>n&&n.map(i=>{const p=i.participants.map(g=>g._id===o?{...g,isOnline:!0}:g);return{...i,participants:p}})))},j=d=>{const o=d;"off"+o!=a.current&&(a.current="off"+o,u(n=>n&&n.map(i=>{const p=i.participants.map(g=>g._id===o?{...g,isOnline:!1}:g);return{...i,participants:p}})))},E=()=>{F(r).then(d=>{u(d)}).catch(()=>{b("/auth")})},N=d=>{var n,i;const o=document.querySelectorAll(".chat-room");o==null||o.forEach(p=>{var g;(g=p.classList)==null||g.remove("active")}),(i=(n=o[d])==null?void 0:n.classList)==null||i.add("active"),c(d)};l.useEffect(()=>{x.length>0&&m(x)},[x]),l.useEffect(()=>(r&&F(r).then(d=>{u(d);const o=k(r);o.on("onl",v),o.on("off",j),o.on("room",E),f.current=o}).catch(()=>{b("/auth")}),()=>{var d;(d=f.current)==null||d.disconnect()}),[r]);const h=l.useMemo(()=>x.map((d,o)=>e.jsx("div",{className:`chat-room ${o==t?"active":""}`,onClick:()=>N(o),children:e.jsx(A,{userId:s,participants:d.participants})},d._id)),[x]);return e.jsx("div",{id:"rooms-list",children:x&&x.length>0?e.jsx("div",{children:h}):e.jsx("p",{children:"No rooms to display"})})};const T={text:"#000",bg:"#ffffff"},U={text:"#ffffff",bg:"#000"},M=()=>{const[s,t]=l.useState(sessionStorage.getItem("theme")==="light"),r=()=>{t(!s)};return l.useEffect(()=>{var c,m;s?(sessionStorage.setItem("theme","light"),(c=document.querySelector(".switcher-label"))==null||c.classList.remove("active"),document.documentElement.style.setProperty("--text-color",U.text),document.documentElement.style.setProperty("--background-color",U.bg)):(sessionStorage.setItem("theme","dark"),(m=document.querySelector(".switcher-label"))==null||m.classList.add("active"),document.documentElement.style.setProperty("--text-color",T.text),document.documentElement.style.setProperty("--background-color",T.bg))},[s]),e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:s,onChange:r}),e.jsxs("label",{className:"switcher-label",htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})},z=(s,t)=>fetch(`/api/v1/rooms/${s}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(r=>{if(r.ok)return r.json();throw r.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let y;const q=({room:s,token:t,profile:r})=>{const[c,m]=l.useState(""),[x,u]=l.useState(null),a=l.useRef(s._id),f=C(),b=h=>{m(h.target.value),console.log("typing ...")},v=()=>{c.trim()!==""&&(y==null||y.emit("msg",[s._id,c,new Date]),m(""))},j=h=>{if(h[1]===a.current){const d=h[0];if(d!==(r==null?void 0:r._id)&&!s.participants.some(i=>i._id===d))return;const o=h[2],n=h[3];u(i=>i!==null?[...i,{sender:d,content:o,timestamp:n}]:[{sender:d,content:o,timestamp:n}])}else console.log("New message, room: "+h[1])},E=()=>{y==null||y.emit("call",[s._id,new Date])},N=h=>{console.log("Receive call"),console.log(h);const d=`/call/${h[1]}?token=${t}`;if(h[0]==(r==null?void 0:r._id))return window.open(d);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{window.open(d)}):Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&N(h)})};return l.useEffect(()=>{try{if(!t||!s)return;z(s._id,t).then(h=>{u(h.messages)}).catch(()=>{f("/auth")})}catch(h){console.error(h)}},[t,s._id]),l.useEffect(()=>{t&&(y=k(t),y==null||y.on("msg",j),y==null||y.on("call",N))},[t]),l.useEffect(()=>{a.current=s._id},[s._id]),e.jsxs("div",{id:"chat-box",children:[e.jsxs("div",{className:"flex",children:[e.jsx(M,{}),e.jsx("button",{onClick:E,children:"Make call"})]}),e.jsx("div",{className:"message-container",children:Array.isArray(x)&&x.map((h,d)=>{let o;if(h.sender&&h.sender==(r==null?void 0:r._id))o=r.avatar;else{const n=s.participants.find(i=>i._id===h.sender);o=n?n.avatar:""}return e.jsxs("div",{className:`message ${h.sender==(r==null?void 0:r._id)?"own":""}`,children:[o&&e.jsx("img",{className:"inchat-avatar",src:o,alt:"Sender Avatar"}),e.jsx("span",{children:h.content}),e.jsx("span",{children:h.timestamp})]},d)})}),e.jsxs("div",{className:"input-container flex",children:[e.jsx("input",{type:"text",value:c,onChange:b,className:"input-field"}),e.jsx("button",{onClick:v,className:"send-button",children:"Send"})]})]})};const J=({token:s,profileData:t,onRefresh:r})=>{const[c,m]=l.useState(!1),[x,u]=l.useState(!1),a=l.useRef(null),f=l.useRef(null),b=l.useRef(null),v=C();l.useEffect(()=>{if(s){const n=k(s);n.on("inv",r),b.current=n}return()=>{var n;(n=b.current)==null||n.disconnect()}},[s]);const j=()=>{sessionStorage.removeItem("token"),v("/auth")},E=n=>{fetch(`/api/v1/rooms/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({accept:!0})})},N=n=>{fetch(`/api/v1/rooms/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({accept:!1})})},h=async n=>{n.preventDefault();let i={};if(n.target.bio.value&&(i.bio=n.target.bio.value),n.target.fullname.value&&(i.fullname=n.target.fullname.value),n.target.password.value)if(i.password=n.target.password.value,n.target.current_password.value)i.current_password=n.target.current_password.value;else return alert("Please enter current password");if(f.current&&(i.avatar=f.current),!i.bio&&!i.fullname&&!i.password&&!i.avatar)return alert("Empty form");const p=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(i)});if(u(!1),p.ok)return alert("Updated successfully!"),r();const g=await p.json();if(g.message)return alert(g.message);alert("Error updating profile")},d=async()=>{if(window.confirm("Are you sure you want to delete your account?")){const i=window.prompt("Enter your password:");if(i!==null)try{const p={password:i},g=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify(p)});if(g.ok)sessionStorage.removeItem("token"),alert("You deleted your account successfully"),v("/auth");else{const w=await g.json();w.message?alert(w.message):alert("Wrong password!")}}catch(p){console.error("Error deleting account:",p)}}},o=()=>{if(a!=null&&a.current&&a.current.length>0){const n=a.current.files[0],i=new FileReader;i.onload=async p=>{var g;if((g=p.target)!=null&&g.result){const w=new Image;w.onload=async()=>{const R=document.createElement("canvas"),I=200,P=200;let S=w.width,_=w.height;S>I&&(_*=I/S,S=I),_>P&&(S*=P/_,_=P),R.width=S,R.height=_;const L=R.getContext("2d");L==null||L.drawImage(w,0,0,S,_);const B=R.toDataURL("image/jpeg");f.current=B},w.src=p.target.result}},i.readAsDataURL(n)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"profile",children:[e.jsx("img",{src:t==null?void 0:t.avatar,alt:"Profile",id:"profile_img",className:"cover"}),x?e.jsxs(e.Fragment,{children:[e.jsx("input",{id:"btn_upload-img",type:"file",accept:"image/*",ref:a,onChange:o}),e.jsx("button",{className:"btn_profile",onClick:()=>u(!1),children:e.jsx("i",{className:"bx bxs-pencil"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("h3",{children:t==null?void 0:t.fullname}),(t==null?void 0:t.bio)&&e.jsx("p",{children:t==null?void 0:t.bio})]}),e.jsx("button",{className:"btn_profile",onClick:()=>u(!0),children:e.jsx("i",{className:"bx bxs-pencil"})})]}),e.jsx("button",{className:"btn_profile",onClick:()=>m(n=>!n),children:c?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t!=null&&t.invitations.length&&(t==null?void 0:t.invitations.length)>0?e.jsx("span",{id:"nofcount",children:t==null?void 0:t.invitations.length}):null]})}),c&&e.jsx("div",{id:"notify-container",children:t&&t.invitations.length>0?t.invitations.map(n=>e.jsxs("div",{children:[e.jsx("p",{children:n}),e.jsx("button",{onClick:()=>E(n),children:"Accept"}),e.jsx("button",{onClick:()=>N(n),children:"Refuse"})]},n)):e.jsx("p",{children:"No invitations"})}),e.jsx("button",{id:"logout-btn",className:"btn_profile",onClick:j,children:e.jsx("i",{className:"bx bx-log-in"})})]}),x&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:h,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]}),e.jsx("button",{type:"submit",children:"Save"})]}),e.jsx("button",{onClick:d,children:"Delete account"})]})]})},G=l.memo(J);const Y=({token:s,onChoose:t})=>{const r=l.useRef(null),[c,m]=l.useState([]),x=()=>{var b;const f=(b=r.current)==null?void 0:b.value;f&&fetch(`/api/v1/search/${f}`,{headers:{"content-type":"application/json",authorization:"Bearer "+s}}).then(v=>{if(v.ok)return v.json().then(j=>{m(j)});console.log(v.status)})},u=f=>{f.key==="Enter"&&x()},a=f=>{r.current&&!r.current.contains(f.target)&&(m([]),r.current.value="")};return l.useEffect(()=>(document.addEventListener("click",a),()=>{document.removeEventListener("click",a)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:r,onKeyPress:u}),e.jsx("button",{className:"btn_profile",onClick:x,children:e.jsx("i",{className:"bx bx-search"})}),c.length>0&&e.jsx("div",{id:"search_dropdown",children:c.map(f=>e.jsxs("div",{onClick:()=>{t({_id:f._id,fullname:f.fullname})},children:[e.jsx("img",{className:"profile-picture",src:f.avatar,alt:"Avatar"}),f.fullname]},f._id))})]})};const K=({token:s})=>{const[t,r]=l.useState([]),c=u=>{if(t.some(a=>a._id==u._id))return alert("already selected this user");r(a=>[...a,u])},m=u=>{console.log("remove user from users list"),u>=0&&u<t.length&&r(a=>a.filter((b,v)=>v!==u))},x=async()=>{if(t.length==0)return alert("Please select a user");const u=t.map(a=>a._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+s},body:JSON.stringify({invited:u})})).ok?r([]):alert("deo biet sao bug luon")}catch(a){console.error(a)}};return e.jsxs("div",{id:"room-maker",children:[e.jsx(Y,{token:s,onChoose:c}),t.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:t.map((u,a)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",u.fullname]}),e.jsx("span",{onClick:()=>m(a),children:"X"})]},u.fullname))}),e.jsx("button",{className:"btn_profile",onClick:x,children:e.jsx("i",{className:"bx bxs-message-square-add"})})]})]})},$=s=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(t=>{if(t.ok)return t.json();throw t.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),H=({token:s})=>{const[t,r]=l.useState(null),[c,m]=l.useState([]),[x,u]=l.useState(0),a=C(),f=async()=>{try{const j=await $(s);r(j)}catch{a("/auth")}},b=j=>{u(j)},v=j=>{m(j)};return l.useEffect(()=>{s&&$(s).then(j=>{r(j)}).catch(j=>{console.error(j),a("/auth")})},[s]),e.jsx("div",{id:"main-page",className:"flex",children:t?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(G,{token:s,profileData:t,onRefresh:f}),e.jsx(K,{token:s}),e.jsx(O,{userId:t._id,currentRoomIndex:x,token:s,onRoomChange:b,onUpdateStatus:v})]}),e.jsxs("section",{id:"section-right",children:[c.length>0&&e.jsx(q,{profile:t,token:s,room:c[x]}),e.jsx("img",{id:"chat-bg",src:"/assets/img/img_new/pattern.png"})]})]})}):e.jsx("div",{children:"Loading skeleton ..."})})};export{H as default,$ as getProfile};
