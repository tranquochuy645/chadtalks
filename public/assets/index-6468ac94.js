import{r as f,j as e,u as F,a as ee,c as te,g as ne,P as se}from"./index-450c2ada.js";import{u as A,S as ie}from"./index-5f6330fb.js";const re=({participants:r,userId:t})=>{if(r=r.filter(i=>i._id!==t),r.length===0)return null;const d=r.length>1,h=r.slice(0,4);return e.jsx("div",{className:"card",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:h.map((i,l)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:i.avatar,alt:"Profile",className:"group-profile-picture"})},l))}),e.jsxs("div",{className:"profile-names",children:[h.length>0&&e.jsx("h3",{children:h.map(i=>i.fullname).join(", ")}),r.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",r.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:r[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("h3",{children:[r[0].fullname+"  ",e.jsx("span",{className:r[0].isOnline?"online":"offline",children:"â€¢"})]}),r[0].bio&&e.jsx("p",{children:r[0].bio})]})})},X=f.memo(re);const K=r=>new Promise((t,d)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+r}}).then(h=>{if(h.ok)return h.json().then(i=>{t(i)});if(h.status==401)throw alert("Token expired"),sessionStorage.removeItem("token"),new Error}).catch(h=>{d(h)})}),oe=({userId:r,currentRoomIndex:t,token:d,onRoomChange:h,onUpdateStatus:i})=>{const[l,a]=f.useState([]),n=A(),o=F(),v=s=>{const p=s;a(x=>x&&x.map(_=>{const T=_.participants.map(S=>S._id===p?{...S,isOnline:!0}:S);return{..._,participants:T}}))},m=s=>{const p=s;a(x=>x&&x.map(_=>{const T=_.participants.map(S=>S._id===p?{...S,isOnline:!1}:S);return{..._,participants:T}}))},g=s=>{console.log("set meet"),a(p=>p&&p.map(x=>x._id===s[1]?{...x,isMeeting:!0,meeting_uuid:s[2]}:x))},u=s=>{console.log("set end meet"),a(p=>p&&p.map(x=>x._id===s[0]&&x.isMeeting?{...x,isMeeting:!1,meeting_uuid:null}:x))},w=()=>{K(d).then(s=>{a(s)}).catch(()=>{o("/auth")})},k=s=>{var x,_;const p=document.querySelectorAll(".chat-room");p==null||p.forEach(T=>{var S;(S=T.classList)==null||S.remove("active")}),(_=(x=p[s])==null?void 0:x.classList)==null||_.add("active"),h(s)};f.useEffect(()=>{l.length>0&&i(l)},[l]),f.useEffect(()=>{if(n)return n.on("onl",v),n.on("off",m),n.on("meet",g),n.on("end_meet",u),n.on("room",w),()=>{n.off("onl",v),n.off("off",m),n.off("meet",g),n.off("end_meet",u),n.off("room",w)}},[n]),f.useEffect(()=>{K(d).then(s=>{a(s)}).catch(()=>{o("/auth")})},[]);const C=async(s,p)=>{switch(s){case"leave":return fetch(`/api/v1/rooms/${p}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+d},body:JSON.stringify({action:s})});case"delete":return fetch(`/api/v1/rooms/${p}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+d}})}},j=f.useMemo(()=>l.map((s,p)=>{var _,T,S;const x=(_=s==null?void 0:s.readCursors)==null?void 0:_.find(z=>z._id==r);return e.jsxs("div",{className:`chat-room ${p==t?"active":""}`,children:[e.jsxs("div",{onClick:()=>k(p),children:[e.jsx(X,{userId:r,participants:s.participants}),e.jsx("p",{children:(T=s==null?void 0:s.latestMessage[0])==null?void 0:T.content}),e.jsx("p",{children:((S=s==null?void 0:s.latestMessage[0])==null?void 0:S.timestamp)>(x==null?void 0:x.lastReadTimeStamp)?"Unread":"All Read"})]}),e.jsx("input",{className:"checkbox",type:"checkbox",id:`${s._id}_opts`}),e.jsx("label",{className:"checkbox_label",htmlFor:`${s._id}_opts`,children:e.jsx("i",{className:"bx bx-dots-vertical-rounded"})}),e.jsxs("div",{className:"chat-room_opts",children:[e.jsx("button",{onClick:()=>C("leave",s._id),children:"Leave"}),e.jsx("button",{onClick:()=>C("delete",s._id),children:"Delete"})]})]},s._id)}),[l]);return e.jsx("div",{id:"rooms-list",children:l&&l.length>0?e.jsx("div",{children:j}):e.jsx("p",{children:"No rooms to display"})})};const J=({onChange:r,accept:t,id:d,icon:h})=>{const i=f.useRef(null),l=a=>{if(a.target.files){const n=a.target.files[0];r(n)}};return e.jsxs("label",{id:`btn_${d}`,className:"btn_fileinput",htmlFor:d,children:[h,e.jsx("input",{id:d,className:"fileinput",type:"file",accept:t,ref:i,onChange:l,style:{display:"none"}})]})};const ae=({token:r,userId:t,roomId:d,onJustSent:h})=>{const[i,l]=f.useState(""),[a,n]=f.useState([]),[o,v]=f.useState([]),m=A(),g=async j=>{try{const s=new FormData;return j.forEach(_=>{s.append(`file${j.length>1?"s":""}`,_)}),await(await fetch(`/media/${t}/${d}?token=${r}&count=${j.length}`,{method:"POST",body:s})).json()}catch(s){throw s}},u=j=>{l(j.target.value),console.log("typing ...")},w=async()=>{let j=[],s=[];if(a.length>0&&(console.log(a.length),j=a,n([])),o.length>0&&(console.log(o.length),j=[...j,...o],v([])),j.length>0)try{const p=await g(j);p.urls&&(s=p.urls)}catch(p){return alert("error uploading files: "+p.message)}(i.trim()!==""||s.length!==0)&&(console.log(s),m==null||m.emit("msg",[d,i,new Date,s]),h(),l(""))},k=j=>{v(s=>[...s,j])},C=j=>{n(s=>[...s,j])};return e.jsxs("div",{id:"chat-box_input-container",children:[e.jsx(J,{accept:"image/*",onChange:k,id:"chatbox_upload-img",icon:e.jsx("i",{className:"bx bx-image-add"})}),e.jsx(J,{accept:"*",onChange:C,id:"chatbox_upload-file",icon:e.jsx("i",{className:"bx bx-paperclip"})}),o.length>0&&e.jsx("div",{children:o.map((j,s)=>e.jsx("span",{children:j.name},s))}),a.length>0&&e.jsx("div",{children:a.map((j,s)=>e.jsx("span",{children:j.name},s))}),e.jsx("input",{type:"text",value:i,id:"input_message",onChange:u,onKeyDown:j=>{j.key=="Enter"&&w()}}),e.jsx("button",{onClick:w,className:"btn",children:e.jsx("i",{className:"bx bxs-send"})})]})},le=f.memo(ae);const ce={light:{text:"#000",background:"#fff",theme:"#009688"},dark:{text:"#ffffff",background:"#000",theme:"#240063"}},ue=()=>{const[r,t]=f.useState(sessionStorage.getItem("theme")||"light");return f.useEffect(()=>{const d=ce[r];Object.entries(d).forEach(([h,i])=>{document.documentElement.style.setProperty(`--${h}-color`,i)}),sessionStorage.setItem("theme",r)},[r]),[r,t]},de=()=>{const[r,t]=ue(),d=r==="light",h=()=>{t(d?"dark":"light")};return e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:d,onChange:h}),e.jsxs("label",{className:`switcher-label ${d?"":"active"}`,htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const he=({token:r,room:t,userId:d})=>{const h=A(),i=()=>{h.emit("meet",[t._id,new Date])},l=n=>{const o=`/meet/${n}?token=${r}&room=${t._id}`;window.open(o)},a=n=>{if(console.log(n),n[0]==d)return n[3]?void 0:l(n[2]);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{l(n[2])}):Notification.permission!=="denied"&&Notification.requestPermission().then(o=>{o==="granted"&&a(n)})};return t&&f.useEffect(()=>{if(h)return h.on("meet",a),()=>{h.off("meet",a)}},[h,t._id]),e.jsxs("div",{id:"chat-box_topbar",className:"flex",children:[t&&e.jsxs("div",{id:"chat-box_topbar_left",children:[e.jsx(X,{userId:d,participants:t.participants}),t.isMeeting&&t.meeting_uuid?e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This room is in a meeting"}),e.jsx("button",{onClick:()=>l(t.meeting_uuid),children:"Join"})]}):e.jsx("button",{className:"btn",onClick:i,children:e.jsx("i",{className:"bx bxs-video"})})]}),e.jsx(de,{})]})},fe=f.memo(he);var q={exports:{}};(function(r,t){(function(h,i){r.exports=i(f,ee)})(te,function(d,h){return function(i){var l={};function a(n){if(l[n])return l[n].exports;var o=l[n]={i:n,l:!1,exports:{}};return i[n].call(o.exports,o,o.exports,a),o.l=!0,o.exports}return a.m=i,a.c=l,a.d=function(n,o,v){a.o(n,o)||Object.defineProperty(n,o,{enumerable:!0,get:v})},a.r=function(n){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},a.t=function(n,o){if(o&1&&(n=a(n)),o&8||o&4&&typeof n=="object"&&n&&n.__esModule)return n;var v=Object.create(null);if(a.r(v),Object.defineProperty(v,"default",{enumerable:!0,value:n}),o&2&&typeof n!="string")for(var m in n)a.d(v,m,(function(g){return n[g]}).bind(null,m));return v},a.n=function(n){var o=n&&n.__esModule?function(){return n.default}:function(){return n};return a.d(o,"a",o),o},a.o=function(n,o){return Object.prototype.hasOwnProperty.call(n,o)},a.p="",a(a.s=4)}([function(i,l,a){i.exports=a(5)()},function(i,l){i.exports=d},function(i,l){i.exports=h},function(i,l){i.exports=function(a,n,o){var v=a.direction,m=a.value;switch(v){case"top":return o.top+m<n.top&&o.bottom>n.bottom&&o.left<n.left&&o.right>n.right;case"left":return o.left+m<n.left&&o.bottom>n.bottom&&o.top<n.top&&o.right>n.right;case"bottom":return o.bottom-m>n.bottom&&o.left<n.left&&o.right>n.right&&o.top<n.top;case"right":return o.right-m>n.right&&o.left<n.left&&o.top<n.top&&o.bottom>n.bottom}}},function(i,l,a){a.r(l),a.d(l,"default",function(){return V});var n=a(1),o=a.n(n),v=a(2),m=a.n(v),g=a(0),u=a.n(g),w=a(3),k=a.n(w);function C(b){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?C=function(E){return typeof E}:C=function(E){return E&&typeof Symbol=="function"&&E.constructor===Symbol&&E!==Symbol.prototype?"symbol":typeof E},C(b)}function j(b,y){if(!(b instanceof y))throw new TypeError("Cannot call a class as a function")}function s(b,y){for(var E=0;E<y.length;E++){var c=y[E];c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(b,c.key,c)}}function p(b,y,E){return y&&s(b.prototype,y),E&&s(b,E),b}function x(b,y){return y&&(C(y)==="object"||typeof y=="function")?y:T(b)}function _(b){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(E){return E.__proto__||Object.getPrototypeOf(E)},_(b)}function T(b){if(b===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b}function S(b,y){if(typeof y!="function"&&y!==null)throw new TypeError("Super expression must either be null or a function");b.prototype=Object.create(y&&y.prototype,{constructor:{value:b,writable:!0,configurable:!0}}),y&&z(b,y)}function z(b,y){return z=Object.setPrototypeOf||function(c,P){return c.__proto__=P,c},z(b,y)}function R(b,y,E){return y in b?Object.defineProperty(b,y,{value:E,enumerable:!0,configurable:!0,writable:!0}):b[y]=E,b}function Z(b){return b.width===void 0&&(b.width=b.right-b.left),b.height===void 0&&(b.height=b.bottom-b.top),b}var V=function(b){S(y,b);function y(E){var c;return j(this,y),c=x(this,_(y).call(this,E)),R(T(c),"getContainer",function(){return c.props.containment||window}),R(T(c),"addEventListener",function(P,N,L,$){c.debounceCheck||(c.debounceCheck={});var O,U,M=function(){O=null,c.check()};$>-1?U=function(){O||(O=setTimeout(M,$||0))}:U=function(){clearTimeout(O),O=setTimeout(M,L||0)};var B={target:P,fn:U,getLastTimeout:function(){return O}};P.addEventListener(N,B.fn),c.debounceCheck[N]=B}),R(T(c),"startWatching",function(){c.debounceCheck||c.interval||(c.props.intervalCheck&&(c.interval=setInterval(c.check,c.props.intervalDelay)),c.props.scrollCheck&&c.addEventListener(c.getContainer(),"scroll",c.props.scrollDelay,c.props.scrollThrottle),c.props.resizeCheck&&c.addEventListener(window,"resize",c.props.resizeDelay,c.props.resizeThrottle),!c.props.delayedCall&&c.check())}),R(T(c),"stopWatching",function(){if(c.debounceCheck){for(var P in c.debounceCheck)if(c.debounceCheck.hasOwnProperty(P)){var N=c.debounceCheck[P];clearTimeout(N.getLastTimeout()),N.target.removeEventListener(P,N.fn),c.debounceCheck[P]=null}}c.debounceCheck=null,c.interval&&(c.interval=clearInterval(c.interval))}),R(T(c),"check",function(){var P=c.node,N,L;if(!P)return c.state;if(N=Z(c.roundRectDown(P.getBoundingClientRect())),c.props.containment){var $=c.props.containment.getBoundingClientRect();L={top:$.top,left:$.left,bottom:$.bottom,right:$.right}}else L={top:0,left:0,bottom:window.innerHeight||document.documentElement.clientHeight,right:window.innerWidth||document.documentElement.clientWidth};var O=c.props.offset||{},U=C(O)==="object";U&&(L.top+=O.top||0,L.left+=O.left||0,L.bottom-=O.bottom||0,L.right-=O.right||0);var M={top:N.top>=L.top,left:N.left>=L.left,bottom:N.bottom<=L.bottom,right:N.right<=L.right},B=N.height>0&&N.width>0,I=B&&M.top&&M.left&&M.bottom&&M.right;if(B&&c.props.partialVisibility){var W=N.top<=L.bottom&&N.bottom>=L.top&&N.left<=L.right&&N.right>=L.left;typeof c.props.partialVisibility=="string"&&(W=M[c.props.partialVisibility]),I=c.props.minTopValue?W&&N.top<=L.bottom-c.props.minTopValue:W}typeof O.direction=="string"&&typeof O.value=="number"&&(console.warn("[notice] offset.direction and offset.value have been deprecated. They still work for now, but will be removed in next major version. Please upgrade to the new syntax: { %s: %d }",O.direction,O.value),I=k()(O,N,L));var G=c.state;return c.state.isVisible!==I&&(G={isVisible:I,visibilityRect:M},c.setState(G),c.props.onChange&&c.props.onChange(I)),G}),c.state={isVisible:null,visibilityRect:{}},c}return p(y,[{key:"componentDidMount",value:function(){this.node=m.a.findDOMNode(this),this.props.active&&this.startWatching()}},{key:"componentWillUnmount",value:function(){this.stopWatching()}},{key:"componentDidUpdate",value:function(c){this.node=m.a.findDOMNode(this),this.props.active&&!c.active?(this.setState({isVisible:null,visibilityRect:{}}),this.startWatching()):this.props.active||this.stopWatching()}},{key:"roundRectDown",value:function(c){return{top:Math.floor(c.top),left:Math.floor(c.left),bottom:Math.floor(c.bottom),right:Math.floor(c.right)}}},{key:"render",value:function(){return this.props.children instanceof Function?this.props.children({isVisible:this.state.isVisible,visibilityRect:this.state.visibilityRect}):o.a.Children.only(this.props.children)}}]),y}(o.a.Component);R(V,"defaultProps",{active:!0,partialVisibility:!1,minTopValue:0,scrollCheck:!1,scrollDelay:250,scrollThrottle:-1,resizeCheck:!1,resizeDelay:250,resizeThrottle:-1,intervalCheck:!0,intervalDelay:100,delayedCall:!1,offset:{},containment:null,children:o.a.createElement("span",null)}),R(V,"propTypes",{onChange:u.a.func,active:u.a.bool,partialVisibility:u.a.oneOfType([u.a.bool,u.a.oneOf(["top","right","bottom","left"])]),delayedCall:u.a.bool,offset:u.a.oneOfType([u.a.shape({top:u.a.number,left:u.a.number,bottom:u.a.number,right:u.a.number}),u.a.shape({direction:u.a.oneOf(["top","right","bottom","left"]),value:u.a.number})]),scrollCheck:u.a.bool,scrollDelay:u.a.number,scrollThrottle:u.a.number,resizeCheck:u.a.bool,resizeDelay:u.a.number,resizeThrottle:u.a.number,intervalCheck:u.a.bool,intervalDelay:u.a.number,containment:typeof window<"u"?u.a.instanceOf(window.Element):u.a.any,children:u.a.oneOfType([u.a.element,u.a.func]),minTopValue:u.a.number})},function(i,l,a){var n=a(6);function o(){}function v(){}v.resetWarningCache=o,i.exports=function(){function m(w,k,C,j,s,p){if(p!==n){var x=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw x.name="Invariant Violation",x}}m.isRequired=m;function g(){return m}var u={array:m,bool:m,func:m,number:m,object:m,string:m,symbol:m,any:m,arrayOf:g,element:m,elementType:m,instanceOf:g,node:m,objectOf:g,oneOf:g,oneOfType:g,shape:g,exact:g,checkPropTypes:v,resetWarningCache:o};return u.PropTypes=u,u}},function(i,l,a){var n="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";i.exports=n}])})})(q);var pe=q.exports;const me=ne(pe);const ge=({src:r,alt:t})=>{const[d,h]=f.useState(!1);return f.useEffect(()=>{const i=new IntersectionObserver(a=>{a.forEach(n=>{n.isIntersecting&&(h(!0),i.unobserve(n.target))})}),l=document.getElementById(`lazyload-element-${r}`);return l&&i.observe(l),()=>{l&&i.unobserve(l)}},[r]),e.jsx("video",{id:`lazyload-element-${r}`,controls:!0,autoPlay:!1,playsInline:!0,src:d?r:"",children:t})},xe=({src:r,alt:t})=>{const[d,h]=f.useState(!1);return f.useEffect(()=>{const i=new IntersectionObserver(a=>{a.forEach(n=>{n.isIntersecting&&(h(!0),i.unobserve(n.target))})}),l=document.getElementById(`lazyload-element-${r}`);return l&&i.observe(l),()=>{l&&i.unobserve(l)}},[r]),e.jsx("img",{id:`lazyload-element-${r}`,src:d?r:"",loading:"lazy",alt:t})},Q=({url:r,token:t})=>{var n;const[d,h]=f.useState(!1),[i,l]=f.useState(!1),a=((n=r.split("/").pop())==null?void 0:n.substring(23))||"File";return f.useEffect(()=>{var v;const o=(v=r.split(".").pop())==null?void 0:v.toLowerCase();h(["jpg","jpeg","png","gif","bmp","svg"].includes(o||"")),l(["mp4","webm","ogg"].includes(o||""))},[r]),d?e.jsx(xe,{src:r+"?token="+t,alt:a}):i?e.jsx(ge,{src:r+"?token="+t,alt:a}):e.jsx("a",{href:r+"?token="+t,target:"_blank",rel:"noopener noreferrer",children:a})},be=({token:r,content:t,timestamp:d,urls:h})=>e.jsxs("div",{className:"message own",children:[e.jsx("div",{className:"message_wrapper",children:e.jsx("p",{children:t})}),e.jsx("p",{className:"message_timestamp",children:d}),h&&h.length>0&&h.map((i,l)=>e.jsx(Q,{token:r,url:i},d+l))]}),ve=({token:r,avatarSRC:t,content:d,timestamp:h,urls:i})=>e.jsxs("div",{className:"message guest",children:[e.jsxs("div",{className:"message_wrapper",children:[e.jsx("img",{className:"inchat-avatar",src:t,alt:"Sender Avatar"}),e.jsx("p",{children:d}),i&&i.length>0&&i.map((l,a)=>e.jsx(Q,{token:r,url:l},h+a))]}),e.jsx("p",{className:"message_timestamp",children:h})]}),ye=({token:r,messages:t,userId:d,participants:h})=>e.jsx(e.Fragment,{children:Array.isArray(t)&&t.map((i,l)=>{if(i.sender&&i.sender==d)return e.jsx(be,{token:r,content:i.content,timestamp:i.timestamp,urls:i.urls},l);{const a=h.find(o=>o._id===i.sender),n=a?a.avatar:"";return e.jsx(ve,{token:r,avatarSRC:n,content:i.content,timestamp:i.timestamp,urls:i.urls},l)}})}),je=f.memo(ye);const H=(r,t,d,h)=>fetch(`/api/v1/rooms/${r}?limit=${d}&skip=${h}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(i=>{if(i.status===304)throw new Error("Already got this");if(i.ok)return i.json();throw i.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")}),D=30,_e=({token:r,room:t,userId:d,justSent:h})=>{const[i,l]=f.useState([]),[a,n]=f.useState(0),o=f.useRef(null),v=f.useRef(null),m=f.useRef(null),g=f.useRef(null),u=A(),w=F();console.log("Render container");const k=s=>{if(s[1]===t._id){const p=s[0];if(p!==d&&!t.participants.some(S=>S._id===p))return;m.current&&(m.current.style.display="block");const x=s[2],_=s[3],T=s[4];n(S=>S++),l(S=>S!==null?[...S,{sender:p,content:x,timestamp:_,urls:T}]:[{sender:p,content:x,timestamp:_,urls:T}])}},C=()=>{v.current&&(v.current.scrollIntoView({behavior:"smooth"}),m.current&&(m.current.style.display="none"))},j=s=>{if(!s||!i||i.length==0)return;if(i.length>=a){o.current&&(o.current.style.display="none");return}let p,x=D;p=a-i.length-x,p<0&&(x+=p,p=0),H(t._id,r,`${x}`,`${p}`).then(_=>{g.current&&(g.current.scrollTop=300),l(T=>T?_.messages.concat(T):_.messages),_.conversationLength&&n(_.conversationLength)}).catch(()=>{w("/auth")})};return f.useEffect(()=>{try{if(!r||!t)return;H(t._id,r).then(s=>{l(s.messages),s.conversationLength&&n(s.conversationLength)}).catch(()=>{w("/auth")})}catch(s){console.error(s)}},[r,t._id]),f.useEffect(()=>{if(u)return u.on("msg",k),()=>{u.off("msg",k)}},[u,t._id]),f.useEffect(()=>{o.current&&(o.current.style.display="none");const s=setTimeout(()=>{o.current&&g.current&&g.current.scrollHeight>g.current.clientHeight&&(o.current.style.display="flex")},1e3);return()=>{clearTimeout(s)}},[t._id]),f.useEffect(()=>{if(!(!g.current||!i)){if(i.length<=D)return C();if(Math.abs(g.current.scrollHeight-g.current.scrollTop-g.current.clientHeight)<300)return console.log("bottom"),C();if(i[i.length-1].sender==d&&h)return h=!1,C()}},[i]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{ref:g,id:"messages-container",children:[e.jsx(me,{onChange:j,children:e.jsx("div",{ref:o,id:"topRef",children:e.jsx(se,{size:50})})}),i&&e.jsx(je,{token:r,messages:i,userId:d,participants:t.participants}),e.jsx("div",{ref:v})]}),e.jsxs("button",{id:"btn_scroll",ref:m,onClick:()=>{C()},children:[Array.isArray(i)&&i.length>1&&i[i.length-1].content,e.jsx("i",{className:"bx bx-down-arrow-alt"})]})]})};const we=({room:r,token:t,profile:d})=>{const[h,i]=f.useState(!1),l=f.useCallback(()=>{i(!0)},[]);return e.jsxs("div",{id:"chat-box",children:[e.jsx(fe,{token:t,userId:d._id,room:r}),r&&e.jsx(_e,{justSent:h,room:r,token:t,userId:d._id}),r&&e.jsx(le,{token:t,userId:d._id,roomId:r._id,onJustSent:l})]})},Ee=r=>new Promise(async(t,d)=>{if(!window.confirm("Are you sure you want to delete your account?"))return d("Account deletion canceled");const i=window.prompt("Enter your password:");if(!i)return d("Password input canceled");try{const l={password:i},a=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify(l)});if(a.ok)return sessionStorage.removeItem("token"),t("Account deletion successful");const n=await a.json();if(n.message)return d(n.message);d("Wrong password")}catch(l){d(l)}});const Se=({token:r,profileData:t,onRefresh:d})=>{const[h,i]=f.useState(!1),[l,a]=f.useState(!1),n=f.useRef(null),o=f.useRef(null),v=F(),m=A();f.useEffect(()=>{if(m)return m.on("inv",d),()=>{m.off("inv",d)}},[m]);const g=()=>{sessionStorage.removeItem("token"),v("/auth")},u=s=>{fetch(`/api/v1/rooms/${s}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({action:"join"})})},w=s=>{fetch(`/api/v1/rooms/${s}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({action:"refuse"})})},k=async()=>{if(!o.current)return;let s={};if(o.current.bio.value&&(s.bio=o.current.bio.value),o.current.fullname.value&&(s.fullname=o.current.fullname.value),o.current.password.value)if(s.password=o.current.password.value,o.current.current_password.value)s.current_password=o.current.current_password.value;else return alert("Please enter current password");if(n.current&&(s.avatar=n.current),!s.bio&&!s.fullname&&!s.password&&!s.avatar)return alert("Empty form");const p=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify(s)});if(a(!1),p.ok)return alert("Updated successfully!"),d();const x=await p.json();if(x.message)return alert(x.message);alert("Error updating profile")},C=async s=>{const p=new FormData;p.append("file",s);const x=await fetch(`/media/${t==null?void 0:t._id}/public?token=${r}&count=1`,{method:"POST",body:p}),_=await x.json();!x.ok&&_.message&&alert(_.message),_.urls&&(n.current=_.urls[0],k())},j=async()=>{try{const s=await Ee(r);alert(s),v("/auth")}catch(s){alert(s)}};return e.jsxs("div",{id:"profile",children:[e.jsxs("div",{id:"profile_topbar",children:[e.jsx("img",{src:t==null?void 0:t.avatar,alt:"Profile",id:"profile_img",className:"cover"}),l?e.jsx(J,{accept:"image/*",onChange:C,id:"upload-img",icon:e.jsx("i",{className:"bx bxs-camera"})}):e.jsxs("div",{children:[e.jsx("h3",{children:t==null?void 0:t.fullname}),(t==null?void 0:t.bio)&&e.jsx("p",{children:t==null?void 0:t.bio})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{className:"btn",onClick:()=>{i(!1),a(s=>!s)},children:l?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsx("i",{className:"bx bxs-pencil"})}),e.jsx("button",{className:"btn",onClick:()=>{a(!1),i(s=>!s)},children:h?e.jsx("i",{className:"bx bxs-message-square-x"}):e.jsxs("div",{id:"bell",children:[e.jsx("i",{className:"bx bxs-bell"}),t!=null&&t.invitations.length&&(t==null?void 0:t.invitations.length)>0?e.jsx("span",{id:"nofcount",children:t==null?void 0:t.invitations.length}):null]})}),e.jsx("button",{id:"logout-btn",className:"btn",onClick:g,children:e.jsx("i",{className:"bx bx-log-in"})})]})]}),e.jsx("div",{id:"notify-container",className:`profile_dropdown ${h?"active":""}`,children:t&&t.invitations.length>0?t.invitations.map(s=>e.jsxs("div",{children:[e.jsx("p",{children:s}),e.jsx("button",{onClick:()=>u(s),children:"Accept"}),e.jsx("button",{onClick:()=>w(s),children:"Refuse"})]},s)):e.jsx("p",{children:"No invitations"})}),e.jsxs("div",{className:`profile_dropdown ${l?"active":""}`,id:"profile_editor",children:[e.jsxs("form",{id:"profile_form",ref:o,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Your name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname",placeholder:t==null?void 0:t.fullname})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio",placeholder:t==null?void 0:t.bio})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]})]}),e.jsxs("div",{className:"flex",children:[e.jsx("button",{id:"btn_delete-account",onClick:j,children:"Delete account"}),e.jsx("button",{id:"btn_submit-edit",onClick:k,children:"Save"})]})]})]})},Ce=f.memo(Se);const Te=({token:r})=>{const[t,d]=f.useState([]),[h,i]=f.useState([]),l=f.useRef(null),a=u=>{if(t.some(w=>w._id==u._id))return alert("already selected this user");d(w=>[...w,u])},n=u=>{console.log("remove user from users list"),u>=0&&u<t.length&&d(w=>w.filter((C,j)=>j!==u))},o=async()=>{if(t.length==0)return alert("Please select a user");const u=t.map(w=>w._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+r},body:JSON.stringify({invited:u})})).ok?d([]):alert("deo biet sao bug luon")}catch(w){console.error(w)}},v=()=>{var w;const u=(w=l.current)==null?void 0:w.value;u&&fetch(`/api/v1/search/${u}`,{headers:{"content-type":"application/json",authorization:"Bearer "+r}}).then(k=>{if(k.ok)return k.json().then(C=>{i(C)});console.log(k.status)})},m=u=>{u.key==="Enter"&&v()},g=u=>{l.current&&!l.current.contains(u.target)&&(i([]),l.current.value="")};return f.useEffect(()=>(document.addEventListener("click",g),()=>{document.removeEventListener("click",g)}),[]),e.jsxs("div",{id:"room-maker",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{id:"search-bar",children:[e.jsx("button",{className:"btn",onClick:v,children:e.jsx("i",{className:"bx bx-search"})}),e.jsx("div",{id:"chosenList",className:"flex",children:t.map((u,w)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",u.fullname]}),e.jsx("span",{onClick:()=>n(w),children:"X"})]},u.fullname))}),e.jsx("input",{type:"text",placeholder:"Search for users...",ref:l,onKeyPress:m})]}),t.length>0&&e.jsx("div",{className:"flex",children:e.jsx("button",{className:"btn",onClick:o,children:e.jsx("i",{className:"bx bxs-message-square-add"})})})]}),h.length>0&&e.jsx("div",{id:"search_dropdown",children:h.map(u=>e.jsxs("div",{onClick:()=>{a({_id:u._id,fullname:u.fullname})},children:[e.jsx("img",{className:"profile-picture",src:u.avatar,alt:"Avatar"}),u.fullname]},u._id))})]})};function Ne(){return e.jsxs("svg",{id:"bgrn-svg",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 700 700",preserveAspectRatio:"none",children:[e.jsxs("g",{mask:'url("#SvgjsMask1020")',fill:"none",children:[e.jsx("rect",{width:"700",height:"700",x:"0",y:"0",fill:'url("#SvgjsLinearGradient1021")'}),e.jsx("path",{d:"M700 0L426.65 0L700 81.54z",fill:"rgba(255, 255, 255, 0.2)"}),e.jsx("path",{d:"M426.65 0L700 81.54L700 267.52L414.62 0z",fill:"rgba(255, 255, 255, .13)"}),e.jsx("path",{d:"M414.62 0L700 267.52L700 452.46L156.39 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M156.39 0L700 452.46L700 490.96L83.34999999999998 0z",fill:"rgba(255, 255, 255, .1)"}),e.jsx("path",{d:"M0 700L154.99 700L0 376.93z",fill:"rgba(0, 0, 0, .1)"}),e.jsx("path",{d:"M0 376.93L154.99 700L303.17 700L0 371.8z",fill:"rgba(0, 0, 0, .175)"}),e.jsx("path",{d:"M0 371.8L303.17 700L525.89 700L0 229.98000000000002z",fill:"rgba(0, 0, 0, .25)"}),e.jsx("path",{d:"M0 229.98000000000002L525.89 700L592.96 700L0 184.46z",fill:"rgba(0, 0, 0, .325)"})]}),e.jsxs("defs",{children:[e.jsx("mask",{id:"SvgjsMask1020",children:e.jsx("rect",{width:"700",height:"700",fill:"#ffffff"})}),e.jsxs("linearGradient",{x1:"0%",y1:"0%",x2:"100%",y2:"100%",gradientUnits:"userSpaceOnUse",id:"SvgjsLinearGradient1021",children:[e.jsx("stop",{id:"stop_1",offset:"0"}),e.jsx("stop",{id:"stop_2",offset:"1"})]})]})]})}const Y=r=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+r}}).then(t=>{if(t.ok)return t.json();throw t.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Oe=({token:r})=>{const[t,d]=f.useState(null),[h,i]=f.useState([]),[l,a]=f.useState(0),n=F(),o=async()=>{try{console.log("Loading profile again...");const g=await Y(r);d(g)}catch{n("/auth")}},v=g=>{a(g)},m=g=>{i(g)};return f.useEffect(()=>{r&&Y(r).then(g=>{d(g)}).catch(g=>{console.error(g),n("/auth")})},[r]),e.jsx("div",{id:"main-page",className:"flex",children:t?e.jsxs(ie,{token:r,children:[e.jsxs("div",{id:"main-page_container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(Ce,{token:r,profileData:t,onRefresh:o}),e.jsx(Te,{token:r}),e.jsx(oe,{userId:t._id,currentRoomIndex:l,token:r,onRoomChange:v,onUpdateStatus:m})]}),e.jsx("section",{id:"section-right",children:e.jsx(we,{profile:t,token:r,room:h[l]})})]}),e.jsx(Ne,{})]}):e.jsx("div",{children:"Loading skeleton ..."})})};export{Oe as default,Y as getProfile};
