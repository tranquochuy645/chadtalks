import{j as e,r as l,u as _}from"./index-d0f37fe6.js";import{g as k}from"./getSocket-8aa47fbe.js";const A=({participants:t,userId:s})=>{if(t=t.filter(m=>m._id!==s),t.length==0)return null;const r=t.length>1,i=t.slice(0,4);return e.jsx("div",{className:"user-card",children:r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"group-pictures-container",children:i.map((m,g)=>e.jsx("div",{className:"profile",children:e.jsx("img",{src:m.avatar,alt:"Profile",className:"group-profile-picture"})},g))}),e.jsxs("div",{className:"profile-names",children:[i.length>0&&e.jsx("h3",{children:i.map(m=>m.fullname).join(", ")}),t.length>4&&e.jsxs("p",{className:"group-members-count",children:["+",t.length-4," more"]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:t[0].avatar,alt:"Profile",className:"profile-picture"}),e.jsxs("div",{className:"user-info ",children:[e.jsxs("h3",{children:[t[0].fullname+"  ",e.jsx("span",{className:t[0].isOnline?"online":"offline",children:"â€¢"})]}),t[0].bio&&e.jsx("p",{children:t[0].bio})]})]})})};const T=t=>new Promise((s,r)=>{fetch("/api/v1/rooms",{method:"GET",headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(i=>{if(i.ok)return i.json().then(m=>{s(m)});throw i.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch rooms information")}).catch(i=>{r(i)})}),O=({userId:t,currentRoomIndex:s,token:r,onRoomChange:i,onUpdateStatus:m})=>{const[g,u]=l.useState([]),o=l.useRef(""),f=l.useRef(null),y=_(),v=d=>{const a=d;"onl"+a!=o.current&&(o.current="onl"+a,u(n=>n&&n.map(c=>{const p=c.participants.map(x=>x._id===a?{...x,isOnline:!0}:x);return{...c,participants:p}})))},j=d=>{const a=d;"off"+a!=o.current&&(o.current="off"+a,u(n=>n&&n.map(c=>{const p=c.participants.map(x=>x._id===a?{...x,isOnline:!1}:x);return{...c,participants:p}})))},R=()=>{T(r).then(d=>{u(d)}).catch(()=>{y("/auth")})},S=d=>{var n,c;const a=document.querySelectorAll(".chat-room");a==null||a.forEach(p=>{var x;(x=p.classList)==null||x.remove("active")}),(c=(n=a[d])==null?void 0:n.classList)==null||c.add("active"),i(d)};l.useEffect(()=>{g.length>0&&m(g)},[g]),l.useEffect(()=>(r&&T(r).then(d=>{u(d);const a=k(r);a.on("onl",v),a.on("off",j),a.on("room",R),f.current=a}).catch(()=>{y("/auth")}),()=>{var d;(d=f.current)==null||d.disconnect()}),[r]);const h=l.useMemo(()=>g.map((d,a)=>e.jsx("div",{className:`chat-room ${a==s?"active":""}`,onClick:()=>S(a),children:e.jsx(A,{userId:t,participants:d.participants})},d._id)),[g]);return e.jsx("div",{id:"rooms-list",children:g&&g.length>0?e.jsx("div",{children:h}):e.jsx("p",{children:"No rooms to display"})})};const M=(t,s)=>fetch(`/api/v1/rooms/${t}`,{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+s}}).then(r=>{if(r.ok)return r.json();throw r.status==401&&(alert("Token expired"),sessionStorage.removeItem("token")),new Error("Failed to fetch messages")});let w;const z=({room:t,token:s,profile:r})=>{const[i,m]=l.useState(""),[g,u]=l.useState(null),o=l.useRef(t._id),f=_(),y=h=>{m(h.target.value),console.log("typing ...")},v=()=>{i.trim()!==""&&(w==null||w.emit("msg",[t._id,i,new Date]),m(""))},j=h=>{if(h[1]===o.current){const d=h[0];if(d!==(r==null?void 0:r._id)&&!t.participants.some(c=>c._id===d))return;const a=h[2],n=h[3];u(c=>c!==null?[...c,{sender:d,content:a,timestamp:n}]:[{sender:d,content:a,timestamp:n}])}else console.log("New message, room: "+h[1])},R=()=>{w==null||w.emit("call",[t._id,new Date])},S=h=>{console.log("Receive call"),console.log(h);const d=`/call/${h[1]}?token=${s}`;if(h[0]==(r==null?void 0:r._id))return window.open(d);Notification.permission==="granted"?new Notification("Incoming Call",{body:"You have an incoming call. Do you want to join?",icon:"path/to/notification-icon.png",requireInteraction:!0}).addEventListener("click",()=>{window.open(d)}):Notification.permission!=="denied"&&Notification.requestPermission().then(a=>{a==="granted"&&S(h)})};return l.useEffect(()=>{try{if(!s||!t)return;M(t._id,s).then(h=>{u(h.messages)}).catch(()=>{f("/auth")})}catch(h){console.error(h)}},[s,t._id]),l.useEffect(()=>{s&&(w=k(s),w==null||w.on("msg",j),w==null||w.on("call",S))},[s]),l.useEffect(()=>{o.current=t._id},[t._id]),e.jsxs("div",{id:"chat-box",children:[e.jsx("button",{onClick:R,children:"Make call"}),e.jsx("div",{className:"message-container",children:Array.isArray(g)&&g.map((h,d)=>{let a;if(h.sender&&h.sender==(r==null?void 0:r._id))a=r.avatar;else{const n=t.participants.find(c=>c._id===h.sender);a=n?n.avatar:""}return e.jsxs("div",{className:`message ${h.sender==(r==null?void 0:r._id)?"own":""}`,children:[a&&e.jsx("img",{className:"inchat-avatar",src:a,alt:"Sender Avatar"}),e.jsx("span",{children:h.content}),e.jsx("span",{children:h.timestamp})]},d)})}),e.jsxs("div",{className:"input-container flex",children:[e.jsx("input",{type:"text",value:i,onChange:y,className:"input-field"}),e.jsx("button",{onClick:v,className:"send-button",children:"Send"})]})]})};const F={text:"#000",bg:"#ffffff"},U={text:"#ffffff",bg:"#000"},q=()=>{const[t,s]=l.useState(sessionStorage.getItem("theme")==="light"),r=()=>{s(!t)};return l.useEffect(()=>{var i,m;t?(sessionStorage.setItem("theme","light"),(i=document.querySelector(".switcher-label"))==null||i.classList.remove("active"),document.documentElement.style.setProperty("--text-color",U.text),document.documentElement.style.setProperty("--background-color",U.bg)):(sessionStorage.setItem("theme","dark"),(m=document.querySelector(".switcher-label"))==null||m.classList.add("active"),document.documentElement.style.setProperty("--text-color",F.text),document.documentElement.style.setProperty("--background-color",F.bg))},[t]),e.jsxs("div",{className:"theme-switch-container",children:[e.jsx("input",{type:"checkbox",id:"switcher-input",checked:t,onChange:r}),e.jsxs("label",{className:"switcher-label",htmlFor:"switcher-input",children:[e.jsx("i",{className:"fas fa-solid fa-sun"}),e.jsx("span",{className:"switcher-toggler"}),e.jsx("i",{className:"fas fa-solid fa-moon"})]})]})};const J=({token:t,profileData:s,onRefresh:r})=>{const[i,m]=l.useState(!1),[g,u]=l.useState(!1),o=l.useRef(null),f=l.useRef(null),y=l.useRef(null),v=_();l.useEffect(()=>{if(t){const n=k(t);n.on("inv",r),y.current=n}return()=>{var n;(n=y.current)==null||n.disconnect()}},[t]);const j=()=>{sessionStorage.removeItem("token"),v("/auth")},R=n=>{fetch(`/api/v1/rooms/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!0})})},S=n=>{fetch(`/api/v1/rooms/${n}`,{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({accept:!1})})},h=async n=>{n.preventDefault();let c={};if(n.target.bio.value&&(c.bio=n.target.bio.value),n.target.fullname.value&&(c.fullname=n.target.fullname.value),n.target.password.value)if(c.password=n.target.password.value,n.target.current_password.value)c.current_password=n.target.current_password.value;else return alert("Please enter current password");if(f.current&&(c.avatar=f.current),!c.bio&&!c.fullname&&!c.password&&!c.avatar)return alert("Empty form");const p=await fetch("/api/v1/users/",{method:"PUT",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify(c)});if(u(!1),p.ok)return alert("Updated successfully!"),r();const x=await p.json();if(x.message)return alert(x.message);alert("Error updating profile")},d=async()=>{if(window.confirm("Are you sure you want to delete your account?")){const c=window.prompt("Enter your password:");if(c!==null)try{const p={password:c},x=await fetch("/api/v1/users/",{method:"DELETE",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify(p)});if(x.ok)sessionStorage.removeItem("token"),alert("You deleted your account successfully"),v("/auth");else{const b=await x.json();b.message?alert(b.message):alert("Wrong password!")}}catch(p){console.error("Error deleting account:",p)}}},a=()=>{if(o!=null&&o.current&&o.current.length>0){const n=o.current.files[0],c=new FileReader;c.onload=async p=>{var x;if((x=p.target)!=null&&x.result){const b=new Image;b.onload=async()=>{const C=document.createElement("canvas"),I=200,P=200;let N=b.width,E=b.height;N>I&&(E*=I/N,N=I),E>P&&(N*=P/E,E=P),C.width=N,C.height=E;const L=C.getContext("2d");L==null||L.drawImage(b,0,0,N,E);const B=C.toDataURL("image/jpeg");f.current=B},b.src=p.target.result}},c.readAsDataURL(n)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{id:"profile",children:[e.jsx("img",{src:s==null?void 0:s.avatar,alt:"Profile",id:"profile_img",className:"cover"}),g?e.jsx("input",{type:"file",accept:"image/*",ref:o,onChange:a}):e.jsx("button",{onClick:()=>u(!0),children:"Edit"}),e.jsxs("div",{children:[e.jsx("h3",{children:s==null?void 0:s.fullname}),(s==null?void 0:s.bio)&&e.jsx("p",{children:s==null?void 0:s.bio})]}),e.jsx("button",{onClick:()=>m(n=>!n),children:i?"X":`TB (${s==null?void 0:s.invitations.length})`}),i&&e.jsx("div",{children:s&&s.invitations.length>0?s.invitations.map(n=>e.jsxs("div",{children:[e.jsx("p",{children:n}),e.jsx("button",{onClick:()=>R(n),children:"Accept"}),e.jsx("button",{onClick:()=>S(n),children:"Refuse"})]},n)):e.jsx("p",{children:"No invitations"})}),e.jsx(q,{}),e.jsx("button",{id:"logout-btn",onClick:j,children:"Logout"})]}),g&&e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:h,children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"bio",children:"Bio:"}),e.jsx("input",{type:"text",id:"bio",name:"bio"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"fullname",children:"Name:"}),e.jsx("input",{type:"text",id:"fullname",name:"fullname"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"current_password",children:"Current password:"}),e.jsx("input",{type:"password",id:"current_password",name:"current_password"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",children:"New password:"}),e.jsx("input",{type:"password",id:"password",name:"password"})]}),e.jsx("button",{type:"submit",children:"Save"})]}),e.jsx("button",{onClick:()=>u(!1),children:"Cancel"}),e.jsx("button",{onClick:d,children:"Delete account"})]})]})},G=l.memo(J);const K=({token:t,onChoose:s})=>{const r=l.useRef(null),[i,m]=l.useState([]),g=()=>{var y;const f=(y=r.current)==null?void 0:y.value;f&&fetch(`/api/v1/search/${f}`,{headers:{"content-type":"application/json",authorization:"Bearer "+t}}).then(v=>{if(v.ok)return v.json().then(j=>{m(j)});console.log(v.status)})},u=f=>{f.key==="Enter"&&g()},o=f=>{r.current&&!r.current.contains(f.target)&&(m([]),r.current.value="")};return l.useEffect(()=>(document.addEventListener("click",o),()=>{document.removeEventListener("click",o)}),[]),e.jsxs("div",{id:"search-bar",children:[e.jsx("input",{type:"text",placeholder:"Search for users...",ref:r,onKeyPress:u}),e.jsx("button",{onClick:g,children:"Search"}),i.length>0&&e.jsx("div",{className:"search_dropdown",children:i.map(f=>e.jsxs("div",{onClick:()=>{s({_id:f._id,fullname:f.fullname})},children:[e.jsx("img",{src:f.avatar,alt:"Avatar"}),f.fullname]},f._id))})]})};const V=({token:t})=>{const[s,r]=l.useState([]),i=u=>{if(s.some(o=>o._id==u._id))return alert("already selected this user");r(o=>[...o,u])},m=u=>{console.log("remove user from users list"),u>=0&&u<s.length&&r(o=>o.filter((y,v)=>v!==u))},g=async()=>{if(s.length==0)return alert("Please select a user");const u=s.map(o=>o._id);try{(await fetch("/api/v1/rooms",{method:"POST",headers:{"content-type":"application/json",authorization:"Bearer "+t},body:JSON.stringify({invited:u})})).ok?r([]):alert("deo biet sao bug luon")}catch(o){console.error(o)}};return e.jsxs("div",{id:"room-maker",children:[s.length>0&&e.jsxs("div",{className:"flex",children:[e.jsx("div",{id:"chosenList",className:"flex",children:s.map((u,o)=>e.jsxs("div",{className:"chosenUser flex",children:[e.jsxs("p",{children:[" ",u.fullname]}),e.jsx("span",{onClick:()=>m(o),children:"X"})]},u.fullname))}),e.jsx("button",{onClick:g,children:"Create"})]}),e.jsx(K,{token:t,onChoose:i})]})},$=t=>fetch("/api/v1/users/",{method:"GET",headers:{"content-type":"application/json",Authorization:"Bearer "+t}}).then(s=>{if(s.ok)return s.json();throw s.status==401&&(alert("Token expired"),sessionStorage.removeItem("token"),window.location.reload()),new Error("Failed to fetch user profile")}),Y=({token:t})=>{const[s,r]=l.useState(null),[i,m]=l.useState([]),[g,u]=l.useState(0),o=_(),f=async()=>{try{const j=await $(t);r(j)}catch{o("/auth")}},y=j=>{u(j)},v=j=>{m(j)};return l.useEffect(()=>{t&&$(t).then(j=>{r(j)}).catch(j=>{console.error(j),o("/auth")})},[t]),e.jsxs("div",{id:"main-page",className:"flex",children:[" ",s?e.jsx(e.Fragment,{children:e.jsxs("div",{className:"container",children:[e.jsxs("section",{id:"section-left",children:[e.jsx(G,{token:t,profileData:s,onRefresh:f}),e.jsx(V,{token:t}),e.jsx(O,{userId:s._id,currentRoomIndex:g,token:t,onRoomChange:y,onUpdateStatus:v})]}),e.jsx("section",{id:"section-right",children:i.length>0&&e.jsx(z,{profile:s,token:t,room:i[g]})})]})}):e.jsx("div",{children:"Loading skeleton ..."})]})};export{Y as default,$ as getProfile};
